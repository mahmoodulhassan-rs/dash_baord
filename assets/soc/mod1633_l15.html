<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta name="Author" content="<username>"> <meta name="GENERATOR" content="urg/version [en] (platform name) [urg]">
<title>Unified Coverage Report :: Line split page</title>
<link type="text/css" rel="stylesheet" href="css/.urg.css">
<link type="text/css" rel="stylesheet" href="css/.layout.css">
<script type="text/javascript" src="js/.jquery.js"></script>
<script type="text/javascript" src="js/.jquery-ui.js"></script>
<script type="text/javascript" src="js/.sortable.js"></script>
<script type="text/javascript" src="js/.colResizable.js"></script>
<script type="text/javascript" src="js/.layout.js"></script>
<script type="text/javascript">
var layout, westLayout, centerLayout;
$(document).ready(function () {
  layout = $("body").layout({ 
    resizable: true,
    spacing_open: 4,
    spacing_closed: 4,
    north: {
      size: 76
    },
    south: {
      size: 45,
      initClosed: true
    }  });
  $("table").colResizable({    liveDrag:true,
    fixed:false,
    draggingClass:"dragging"
  });
});
</script>
</head>
<body><div class="ui-layout-north">
<div class="logo"></div>
<center class="pagetitle">Line split page</center>
<div align="center"><a href="dashboard.html" ><b>dashboard</b></a> | <a href="hierarchy.html" ><b>hierarchy</b></a> | <a href="modlist.html" ><b>modlist</b></a> | groups | <a href="tests.html" ><b>tests</b></a> | <a href="asserts.html" ><b>asserts</b></a></div>

</div>
<div class="ui-layout-center">
Go <a href="mod1633.html#l15">back</a>
<pre class="code"><br clear=all>
1332                      begin
1333       1/1               if (~n_rxreset)
1334                            // asynchronous reset.
1335       1/1                  retry_test_rck &lt;= 1'b0;
1336                         else
1337       1/1                  retry_test_rck &lt;= retry_test;
1338                      end
1339                    
1340                      // synchronise pause_enable from the PCLK domain to rx_clk
1341                      // This is generated in the PCLK domain within the registers block
1342                      // and can change dynamically.
1343                      // Hence full metastability protection is applied.
1344                      cdnsdru_datasync_v1 i_cdnsdru_datasync_v1_pause_enable (
1345                         .clk(rx_clk),
1346                         .reset_n(n_rxreset),
1347                         .din(pause_enable),
1348                         .dout(pause_enable_rck));
1349                      cdnsdru_datasync_v1 i_cdnsdru_datasync_v1_pfc_enable (
1350                         .clk(rx_clk),
1351                         .reset_n(n_rxreset),
1352                         .din(pfc_enable),
1353                         .dout(pfc_enable_rck));
1354                    
1355                    
1356                      // synchronize ext_rxq_sel_en
1357                      cdnsdru_datasync_v1 i_cdnsdru_datasync_v1_ext_rxq_sel_en(
1358                         .clk(rx_clk),
1359                         .reset_n(n_rxreset),
1360                         .din(ext_rxq_sel_en),
1361                         .dout(ext_rxq_sel_en_rck));
1362                    
1363                    
1364                    // -----------------------------------------------------------------------------
1365                    // Synchronise GMII/MII &amp; PCS interface signals
1366                    // -----------------------------------------------------------------------------
1367                    
1368                      // These signals are synchronous to the incoming clocks but are
1369                      // resynchronised here for I/O timing.
1370                      // Full metastability protection is therefore NOT required.
1371                      always @(posedge rx_clk or negedge n_rxreset)
1372                      begin
1373       1/1              if (~n_rxreset)
1374                          begin
1375       1/1                  rxd_gmii_sync   &lt;= {1'b0,8'h00};  // parity and rxd_gmii
1376       1/1                  rx_er_gmii_sync &lt;= 1'b0;
1377       1/1                  rx_dv_gmii_sync &lt;= 1'b0;
1378                          end
1379                        else
1380                          begin
1381                            // GMII/MII interface
1382       1/1                  rxd_gmii_sync   &lt;= rxd_gmii;
1383       1/1                  rx_er_gmii_sync &lt;= rx_er_gmii;
1384       1/1                  rx_dv_gmii_sync &lt;= rx_dv_gmii;
1385                          end
1386                      end
1387                    
1388                      // Only generate the synchronization for the rx_br_halt
1389                      // signal when 802p3_br is defined, otherwise tie it to zero.
1390                      // Note: this is going to be reported as unmapped keypoint in LEC
1391                      // anyway if we are in 802p3_br configuration and this is the eMAC,
1392                      // as the MMSL only drives it to the pMAC, but still, if no br is defined 
1393                      // this way of coding will avoid to get any unmapped point for that register.
1394                      generate if (p_edma_has_br == 1'b1) begin: gen_rx_br_halt_sync_logic
1395                        reg rx_br_halt_pipe_r;
1396                        always @(posedge rx_clk or negedge n_rxreset)
1397                        begin
1398                          if (~n_rxreset)
1399                            rx_br_halt_pipe_r &lt;= 1'b0;
1400                          else 
1401                            rx_br_halt_pipe_r &lt;= rx_br_halt;
1402                        end    
1403                        assign rx_br_halt_pipe = rx_br_halt_pipe_r;
1404                      end else begin: no_gen_rx_br_halt_sync_logic
1405                        assign rx_br_halt_pipe = 1'b0;
1406                      end
1407                      endgenerate
1408                      
1409                      // Only generate the synchronization for the PCS signals
1410                      // if the PCS is defined in the defs file, otherwise just 
1411                      // tie them to zero. This will avoid to create registers 
1412                      // in first place, which would be optimized out by 
1413                      // the synt and PandR tool and cause reports of unmapped 
1414                      // keypoints during LEC 
1415                      generate if (p_edma_has_pcs == 1'b1) begin: gen_pcs_sync_logic
1416                        reg [15:0] rxd_pcs_sync_r;
1417                        reg  [1:0] rxd_pcs_par_sync_r;
1418                        reg  [1:0] rx_er_pcs_sync_r;
1419                        reg  [1:0] rx_dv_pcs_sync_r;
1420                        always @(posedge rx_clk or negedge n_rxreset)
1421                        begin
1422                          if (~n_rxreset)
1423                            begin
1424                              rxd_pcs_sync_r     &lt;= 16'h0000;
1425                              rxd_pcs_par_sync_r &lt;= 2'b00;
1426                              rx_er_pcs_sync_r   &lt;= 2'b00;
1427                              rx_dv_pcs_sync_r   &lt;= 2'b00;
1428                            end
1429                          else
1430                            begin
1431                              rxd_pcs_sync_r     &lt;= rxd_pcs;
1432                              rxd_pcs_par_sync_r &lt;= rxd_pcs_par;
1433                              rx_er_pcs_sync_r   &lt;= rx_er_pcs;
1434                              rx_dv_pcs_sync_r   &lt;= rx_dv_pcs;
1435                            end
1436                        end
1437                        assign rxd_pcs_sync       = rxd_pcs_sync_r;    
1438                        assign rxd_pcs_par_sync   = rxd_pcs_par_sync_r;
1439                        assign rx_er_pcs_sync     = rx_er_pcs_sync_r;
1440                        assign rx_dv_pcs_sync     = rx_dv_pcs_sync_r;
1441                      end else begin: no_gen_pcs_sync_logic
1442                        assign rxd_pcs_sync       = 16'h0000;
1443                        assign rxd_pcs_par_sync   = 2'b00;
1444                        assign rx_er_pcs_sync     = 2'b00;
1445                        assign rx_dv_pcs_sync     = 2'b00;
1446                      end
1447                      endgenerate
1448                      
1449                    
1450                    // -----------------------------------------------------------------------------
1451                    // Multiplex GMII/MII &amp; PCS interface signals to make easier to reference
1452                    // -----------------------------------------------------------------------------
1453                    
1454                      // Data Indicator for backpressure application.
1455                      // No need for rx_br_halt_pipe here as irrelevant once frame has started.
1456                      always @(posedge rx_clk or negedge n_rxreset)
1457                      begin
1458       1/1              if(~n_rxreset)
1459       1/1                rx_dv_bp &lt;= 1'b0;
1460                        else
1461       1/1                rx_dv_bp &lt;= rx_dv_int[0] | rx_dv_int[1];
1462                      end
1463                    
1464                      // Select RXD source
1465                      assign rxd_int[17:0] = (data_in_16bits)?    {rxd_pcs_par_sync,
1466                                                                   rxd_pcs_sync[15:0]} :  // Gig TBI
1467                                                        (tbi)? {{2{rxd_pcs_par_sync[0]}},
1468                                                                   rxd_pcs_sync[7:0],     // 10/100
1469                                                                   rxd_pcs_sync[7:0]} :   // SGMII
1470                                                    (gigabit)? {{2{rxd_gmii_sync[8]}},
1471                                                                   rxd_gmii_sync[7:0],    // GMII
1472                                                                   rxd_gmii_sync[7:0]} :  // MII
1473                                                               {{2{rxd_gmii_sync[8]}},
1474                                                                   rxd_gmii_sync[3:0],
1475                                                                   rxd_gmii_sync[3:0],
1476                                                                   rxd_gmii_sync[3:0],
1477                                                                   rxd_gmii_sync[3:0]};
1478                    
1479                      // Select RX_DV source (one bit per byte)
1480                      assign rx_dv_int[1:0] = (data_in_16bits)? {rx_dv_pcs_sync[1],
1481                                                                 rx_dv_pcs_sync[0]} :
1482                                                         (tbi)? {rx_dv_pcs_sync[0],
1483                                                                 rx_dv_pcs_sync[0]} :
1484                                                                {rx_dv_gmii_sync,
1485                                                                 rx_dv_gmii_sync};
1486                    
1487                      // Select RX_ER source (one bit per byte)
1488                      assign rx_er_in[1:0]  = (data_in_16bits)? {rx_er_pcs_sync[1],
1489                                                                 rx_er_pcs_sync[0]} :
1490                                                         (tbi)? {rx_er_pcs_sync[0],
1491                                                                 rx_er_pcs_sync[0]} :
1492                                                                {rx_er_gmii_sync,
1493                                                                 rx_er_gmii_sync};
1494                    
1495                      // ignore rx_er when rx_dv is low if necessary
1496                      always @(*)
1497       1/1              if (ign_ipg_rx_er)
1498       <font color = "red">0/1     ==>        rx_er_int[1:0] = rx_er_in &amp; rx_dv_int;</font>
1499                        else
1500       1/1                rx_er_int[1:0] = rx_er_in;
1501                    
1502                    
1503                    // --------------------------------------------------------------------------
1504                    // detect reception of Low Power Idle
1505                    // set when LPI is detected
1506                    // reset when normal idle is detected
1507                    // Don't need to look at rx_br_halt_pipe as always want to monitor for LPI..
1508                    // --------------------------------------------------------------------------
1509                      always @(posedge rx_clk or negedge n_rxreset)
1510                      begin
1511       1/1               if(~n_rxreset)
1512       1/1                 lpi_indicate &lt;= 1'b0;
1513                         else
1514                           begin
1515                              // Gig TBI
1516       1/1                    if (data_in_16bits)
1517                                begin
1518       <font color = "red">0/1     ==>                 if ((rx_dv_int == 2'b00) &amp;</font>
1519                                       ((rx_er_in == 2'b11) &amp; (rxd_int[15:0] == 16'h0101) |
1520                                        (rx_er_in == 2'b01) &amp; (rxd_int[15:0] == 16'h0001) |
1521                                        (rx_er_in == 2'b10) &amp; (rxd_int[15:0] == 16'h0100)))
1522       <font color = "red">0/1     ==>                      lpi_indicate &lt;= 1'b1;</font>
1523       <font color = "red">0/1     ==>                 else if ((rx_er_in == 2'b00) | (rxd_int[15:0] == 16'h0000))</font>
1524       <font color = "red">0/1     ==>                           lpi_indicate &lt;= 1'b0;</font>
                   <font color = "red">==>  MISSING_ELSE</font>
1525                                end
1526                              // 10/100 TBI or GMII
1527       1/1                    else if (tbi | gigabit)
1528                                begin
1529       <font color = "red">0/1     ==>                 if ((rx_dv_int == 2'b00) &amp;</font>
1530                                       ((rx_er_in == 2'b11) &amp; (rxd_int[15:0] == 16'h0101)))
1531       <font color = "red">0/1     ==>                     lpi_indicate &lt;= 1'b1;</font>
1532       <font color = "red">0/1     ==>                 else if ((rx_er_in != 2'b11) | (rxd_int[15:0] != 16'h0101))</font>
1533       <font color = "red">0/1     ==>                            lpi_indicate &lt;= 1'b0;</font>
                   <font color = "red">==>  MISSING_ELSE</font>
1534                                end
1535                              else // MII
1536                                begin
1537       1/1                         if ((rx_dv_int == 2'b00) &amp;
1538                                       ((rx_er_in == 2'b11) &amp; (rxd_int[15:0] == 16'h1111)))
1539       <font color = "red">0/1     ==>                     lpi_indicate &lt;= 1'b1;</font>
1540       1/1                         else if ((rx_er_in != 2'b11) | (rxd_int[15:0] != 16'h1111))
1541       1/1                                    lpi_indicate &lt;= 1'b0;
                   <font color = "red">==>  MISSING_ELSE</font>
1542                                end
1543                           end
1544                      end
1545                    
1546                    
1547                    // -----------------------------------------------------------------------------
1548                    // Validate incoming data and build into 16 bit current data buffer
1549                    // All RXD is validated with RX_DV or RX_ER, and placed into a 16 bit
1550                    // buffer (curr_data_16).
1551                    // The loading of this buffer needs to work in nibbles to cope with MII.
1552                    // -----------------------------------------------------------------------------
1553                    
1554                      // Current Nibble Pointer
1555                      // Used to keep track of current nibble being written to in current data
1556                      // buffer. Incremented depending on interface mode selected only when
1557                      // rx_dv or rx_er are active.
1558                      // Also increment on curr_rx_dv or curr_rx_er to ensure that always
1559                      // see two bytes without valid data at end of frame. This ensures proper
1560                      // edge detection and flushing through of data.
1561                      // Halt pipeline with rx_br_halt_pipe
1562                      always @(posedge rx_clk or negedge n_rxreset)
1563                      begin
1564       1/1              if (~n_rxreset)
1565       1/1                nibble_pntr &lt;= 2'b00;
1566                        else
1567       1/1                if (~enable_receive_rck)
1568       1/1                  nibble_pntr &lt;= 2'b00;
1569       1/1                else if (rx_br_halt_pipe)
1570       <font color = "red">0/1     ==>          nibble_pntr &lt;= nibble_pntr;</font>
1571       1/1                else if ((rx_dv_int != 2'b00) | (rx_er_int != 2'b00) |
1572                                   (curr_rx_dv != 2'b00) | (curr_rx_er != 2'b00))
1573       1/1                  nibble_pntr &lt;= next_nibble_pntr[1:0];
1574                          else
1575       1/1                  nibble_pntr &lt;= 2'b00;
1576                      end
1577                    
1578                    
1579                      // Nibble pointer increment
1580                      // This depends on the mode selected. Also if there is an odd number of
1581                      // preamble in 10/100 mode then skip one and force in new preamble nibble.
1582                      assign nibble_pntr_inc =
1583                                          (data_in_16bits)? 3'b100 : // Gig TBI mode
1584                         (data_in_8bits | odd_pre_nibbles)? 3'b010 : // GMII mode or
1585                                                                     // MII mode &amp; odd number
1586                                                                     // of preamble
1587                                                            3'b001 ; // MII mode (normal)
1588                    
1589                    
1590                      // decode next nibble pointer value (extra bit for full/overflow)
1591                      assign next_nibble_pntr = {1'b0, nibble_pntr[1:0]} + nibble_pntr_inc[2:0];
1592                    
1593                    
1594                      // Detect that previous was a &quot;5&quot;.
1595                      // Use pointer to next location to be filled to work out what previous was.
1596                      // This is used for detecting an odd number of preamble in 10/100 mode.
1597                      always @(*)
1598                      begin
1599       1/1               case (nibble_pntr[1:0])
1600       1/1                  2'b11   : prev_nibble_was_pre = (curr_data_16[11:8]  == 4'h5);
1601       1/1                  2'b10   : prev_nibble_was_pre = (curr_data_16[7:4]   == 4'h5);
1602       1/1                  2'b01   : prev_nibble_was_pre = (curr_data_16[3:0]   == 4'h5);
1603       1/1                  default : prev_nibble_was_pre = (curr_data_16[15:12] == 4'h5);
1604                         endcase
1605                      end
1606                    
1607                    
1608                      // Detect when receiving an odd number of preamble nibbles in 10/100 mode.
1609                      // This will be indicated when receiving the &quot;D&quot; nibble of the SFD and
1610                      // we are supposed to write it to either nibble 0 or 2 of the current data
1611                      // buffer. Note that the previous nibble must be a &quot;5&quot; to be SFD.
1612                      // If this happens an extra preamble nibble will be inserted so that the
1613                      // &quot;D&quot; SFD nibble now appears in nibble 1 or 3 of the current data buffer.
1614                      assign odd_pre_nibbles = ~rx_state_data &amp; ~gigabit &amp; ~tbi &amp; ~valid_sfd &amp;
1615                                               (rxd_int[3:0] == 4'hd) &amp; prev_nibble_was_pre &amp;
1616                                               ((nibble_pntr == 2'b00) | (nibble_pntr == 2'b10));
1617                    
1618                    
1619                      // determine if current data buffer is full
1620                      // Current data buffer is full if about to increment and next_nibble_pntr is
1621                      // indicating full or overflow. This signal is used to pass the data in
1622                      // curr_data_16 onto the next stage.
1623                      always @(posedge rx_clk or negedge n_rxreset)
1624                      begin
1625       1/1               if (~n_rxreset)
1626       1/1                 curr_buf_full &lt;= 1'b0;
1627       1/1               else if (~enable_receive_rck)
1628       1/1                 curr_buf_full &lt;= 1'b0;
1629       1/1               else if (~rx_br_halt_pipe)
1630       1/1                 curr_buf_full &lt;= next_nibble_pntr[2];
                   <font color = "red">==>  MISSING_ELSE</font>
1631                      end
1632                    
1633                    
1634                      // 16-bit Current data buffer
1635                      // Forms incoming RXD into 16 bit words, by loading up next location pointed
1636                      // to by nibble_pntr.
1637                      // Buffer is always filled to the top of the buffer, and then overwritten
1638                      // by next access. This makes this filling independent of mode.
1639                      always @(posedge rx_clk or negedge n_rxreset)
1640                      begin
1641       1/1               if (~n_rxreset)
1642       1/1                 curr_data_16 &lt;= {2'b00,16'h0000}; // 2{parity}, 2{data}
1643                    
1644                         // Halt datapath
1645       1/1               else if (rx_br_halt_pipe)
1646       <font color = "red">0/1     ==>         curr_data_16 &lt;= curr_data_16;</font>
1647                    
1648                         // clear buffer when receive is disabled and at end of frame when there
1649                         // is to be no carrier extension. The later prevents any residue CRC
1650                         // data causing problems.
1651       1/1               else if (~enable_receive_rck | (end_of_frame &amp; rx_state_data))
1652       1/1                 curr_data_16 &lt;= {2'b00,16'h0000}; // 2{parity}, 2{data}
1653                    
1654                         // If there has been an odd number of preamble nibbles detected then
1655                         // need to force &quot;5&quot; at current pointer and a &quot;d&quot; at next nibble.
1656                         // pointer will automatically increment by two to compensate.
1657                         // odd_pre_nibbles is only set for nibble_pntr values of 0 or 2.
1658       1/1               else if (odd_pre_nibbles)
1659                            begin
1660       <font color = "red">0/1     ==>            case (nibble_pntr[1:0])</font>
1661                                 2'b10   : begin
1662       <font color = "red">0/1     ==>                           curr_data_16[11:8]  &lt;= 4'h5;</font>
1663       <font color = "red">0/1     ==>                           curr_data_16[15:12] &lt;= 4'hd;</font>
1664       <font color = "red">0/1     ==>                           curr_data_16[17]    &lt;= 1'b1;  // Parity</font>
1665                                           end
1666                                 default : begin // will only be nibble_pntr == 2'b00
1667       <font color = "red">0/1     ==>                           curr_data_16[3:0]   &lt;= 4'h5;</font>
1668       <font color = "red">0/1     ==>                           curr_data_16[7:4]   &lt;= 4'hd;</font>
1669       <font color = "red">0/1     ==>                           curr_data_16[16]    &lt;= 1'b1; // parity</font>
1670                                           end
1671                              endcase
1672                            end
1673                    
1674                         // Otherwise load next nibble pointed to by nibble_pntr with rxd_int.
1675                         else
1676                           begin
1677       1/1                   case (nibble_pntr[1:0])
1678       1/1                     2'b11   : {curr_data_16[17],curr_data_16[15:12]}    &lt;= {rxd_int[16],rxd_int[3:0]};
1679       1/1                     2'b10   : {curr_data_16[17],curr_data_16[15:8]}     &lt;= {rxd_int[16],rxd_int[7:0]};
1680       1/1                     2'b01   : {curr_data_16[17:16],curr_data_16[15:4]}  &lt;= {rxd_int[17:16],rxd_int[11:0]};
1681       1/1                     default : curr_data_16[17:0]                        &lt;=  rxd_int[17:0];
1682                             endcase
1683                           end
1684                      end
1685                    
1686                    
1687                      // Current interface selection (GMII, MII or PCS)
1688                      // Selects source for RX_ER and RX_DV, depending on interface
1689                      // mode selected in the registers block, indicated by data_in_8bits
1690                      // and data_in_16bits signals.
1691                      // Update the RX_DV and RX_ER only when either of the 2 bytes
1692                      // in the curr_data_16 buffer are about to be complete. This
1693                      // is detemined by the mode and the current nibble offset pointer
1694                      always @(posedge rx_clk or negedge n_rxreset)
1695                      begin
1696       1/1               if (~n_rxreset)
1697                           begin
1698       1/1                   curr_rx_dv     &lt;= 2'b00;
1699       1/1                   curr_rx_er     &lt;= 2'b00;
1700                           end
1701       1/1               else if (~enable_receive_rck)
1702                           begin
1703       1/1                   curr_rx_dv     &lt;= 2'b00;
1704       1/1                   curr_rx_er     &lt;= 2'b00;
1705                           end
1706                    
1707                         // Halt datapath
1708       1/1               else if (rx_br_halt_pipe)
1709                           begin
1710       <font color = "red">0/1     ==>           curr_rx_dv     &lt;= curr_rx_dv;</font>
1711       <font color = "red">0/1     ==>           curr_rx_er     &lt;= curr_rx_er;</font>
1712                           end
1713                    
1714                         // If there has been an odd number of preamble nibbles detected then
1715                         // pointer will automatically increment by two to compensate, therefore
1716                         // need to tag correct rx_dv and rx_er bytes. (10/100 mode only)
1717                         // Only signalled when nibble_pntr is 0 or 2.
1718                         // Odd number of preamble nibbles detected and nibble_pntr is 0.
1719       1/1               else if (odd_pre_nibbles &amp; (nibble_pntr == 2'b00))
1720                           begin
1721       <font color = "red">0/1     ==>           curr_rx_dv[0]   &lt;= rx_dv_int[0];</font>
1722       <font color = "red">0/1     ==>           curr_rx_er[0]   &lt;= rx_er_int[0];</font>
1723                           end
1724                    
1725                         // Odd number of preamble nibbles detected and nibble_pntr is 2.
1726       1/1               else if (odd_pre_nibbles &amp; (nibble_pntr == 2'b10))
1727                           begin
1728       <font color = "red">0/1     ==>           curr_rx_dv[1]   &lt;= rx_dv_int[1];</font>
1729       <font color = "red">0/1     ==>           curr_rx_er[1]   &lt;= rx_er_int[1];</font>
1730                           end
1731                    
1732                         else
1733                           begin
1734       1/1                   case ({nibble_pntr[1:0], data_in_8bits, data_in_16bits})
1735                    
1736                                // MII nibble mode (4 bits)
1737                                // Only update curr_rx_dv on byte boundary, so that odd nibbles
1738                                // are not passed through data stream.
1739                                // Any occurance of rx_er_int in either nibble must be saved for
1740                                // symbol error detection. Since curr_rx_er is later gated with
1741                                // curr_rx_dv, symbol errors on the odd nibble of an missaligned
1742                                // frame cannot be detected.
1743                                4'b11_00: begin
1744       1/1                                  curr_rx_dv[1]   &lt;= rx_dv_int[1];
1745       1/1                                  curr_rx_er[1]   &lt;= rx_er_int[1] | curr_rx_er[1];
1746                                          end
1747                                4'b10_00: begin
1748       1/1                                  curr_rx_dv[1]   &lt;= curr_rx_dv[1];
1749       1/1                                  curr_rx_er[1]   &lt;= rx_er_int[1];
1750                                          end
1751                                4'b01_00: begin
1752       1/1                                  curr_rx_dv[0]   &lt;= rx_dv_int[0];
1753       1/1                                  curr_rx_er[0]   &lt;= rx_er_int[0] | curr_rx_er[0];
1754                                          end
1755                                4'b00_00: begin
1756       1/1                                  curr_rx_dv[1:0] &lt;= 2'b00;
1757       1/1                                  curr_rx_er[1:0] &lt;= {1'b0, rx_er_int[0]};
1758                                          end
1759                    
1760                                // GMII mode or 10/100 SGMII (8 bits)
1761                                4'b10_10: begin
1762       <font color = "red">0/1     ==>                          curr_rx_dv[1]   &lt;= rx_dv_int[1];</font>
1763       <font color = "red">0/1     ==>                          curr_rx_er[1]   &lt;= rx_er_int[1];</font>
1764                                          end
1765                                4'b00_10: begin
1766       <font color = "red">0/1     ==>                          curr_rx_dv[0]   &lt;= rx_dv_int[0];</font>
1767       <font color = "red">0/1     ==>                          curr_rx_er[0]   &lt;= rx_er_int[0];</font>
1768       <font color = "red">0/1     ==>                          curr_rx_dv[1]   &lt;= 1'b0;</font>
1769       <font color = "red">0/1     ==>                          curr_rx_er[1]   &lt;= 1'b0;</font>
1770                                          end
1771                    
1772                                // Gigabit TBI mode (16 bits)
1773                                default : begin
1774       <font color = "red">0/1     ==>                          curr_rx_dv[1:0] &lt;= rx_dv_int[1:0];</font>
1775       <font color = "red">0/1     ==>                          curr_rx_er[1:0] &lt;= rx_er_int[1:0];</font>
1776                                          end
1777                             endcase
1778                           end
1779                      end
1780                    
1781                    
1782                    // -----------------------------------------------------------------------------
1783                    // Distinguish between SFD, preamble, carrier extension and valid data nibbles
1784                    // -----------------------------------------------------------------------------
1785                    
1786                      // Detect SFD
1787                      // -----------------
1788                      // Detect any bytes that have SFD in them
1789                      assign det_sfd[1:0] = {(curr_data_16[15:8] == 8'hd5),
1790                                             (curr_data_16[7:0]  == 8'hd5)};
1791                    
1792                      // Qualify detection of SFD
1793                      // Only detect when curr_rx_dv is high, and then only select
1794                      // first instance of SFD occurance.
1795                      assign det_sfd_qual[1:0] = (det_sfd[0] &amp; curr_rx_dv[0])? 2'b01 :
1796                                                 (det_sfd[1] &amp; curr_rx_dv[1])? 2'b10 :
1797                                                                               2'b00 ;
1798                    
1799                      // Valid SFD is detected when any of the detect bits are matched
1800                      // and curr_buf_full is valid
1801                      assign valid_sfd = (det_sfd_qual != 2'b00) &amp; curr_buf_full;
1802                    
1803                    
1804                      // Detect preamble
1805                      // -----------------
1806                      // detect any bytes that have preamble in them. If we are not
1807                      // checking for good pre-amble then force detection of good
1808                      // pre-amble. Doing this ensures UNH test 4.1.9 will pass
1809                      assign det_pre[1:0] = (rx_bad_preamble)? 2'b11 :
1810                                                              {(curr_data_16[15:8] == 8'h55),
1811                                                               (curr_data_16[7:0]  == 8'h55)};
1812                    
1813                      // qualify detection of preamble
1814                      // If SFD in lower byte then can't be any preamble in buffer.
1815                      // If SFD is in upper byte then lower byte must contain preamble if
1816                      // rx_dv is set. If rx_dv is not set then force preamble in lower
1817                      // byte to keep state machine happy.
1818                      // Else if no SFD present then detect only preamble in bytes with rx_dv.
1819                      assign det_pre_qual =
1820                         (det_sfd_qual[0])?  2'b00 :
1821                         (det_sfd_qual[1])? {1'b0,((det_pre[0] &amp; curr_rx_dv[0]) | ~curr_rx_dv[0])}:
1822                                            det_pre[1:0] &amp; curr_rx_dv[1:0];
1823                    
1824                      // ensure that all bytes before SFD are correct preamble
1825                      // This signal is only set when curr_buf_full is valid
1826                      // If SFD in lower byte then force valid_pre.
1827                      // Else if SFD in upper byte then det_pre_qual[0] must be high.
1828                      // Else if no SFD detected then valid pre is active if latest byte (upper)
1829                      // has qualified preamble
1830                      assign valid_pre =
1831                         (det_sfd_qual[0])? curr_buf_full :
1832                         (det_sfd_qual[1])? det_pre_qual[0] &amp; curr_buf_full:
1833                                            det_pre_qual[1] &amp; curr_buf_full;
1834                    
1835                    
1836                      // Detect valid data
1837                      // -----------------
1838                      // Detect which bytes contain valid data
1839                      // Don't include preamble or SFD when not in RX_DATA state.
1840                      assign det_data =
1841                                curr_rx_dv &amp;
1842                                ~((det_sfd_qual | det_pre_qual) &amp; {2{~rx_state_data}});
1843                    
1844                    
1845                      // valid_data indicates when a new 16-bit data word containing
1846                      // valid data is ready to analyse.
1847                      // Need also to ensure that this is part of a valid ongoing frame.
1848                      assign valid_data = (det_data != 2'b00) &amp; frame_being_decoded &amp;
1849                                           (curr_buf_full | end_of_data);
1850                    
1851                    
1852                    
1853                      // Detect carrier extension
1854                      // ------------------------
1855                      // Detect carrier extension
1856                      // Carrier extension is defined as RX_DV low and RX_ER high.
1857                      // RXD should also be the value 0x0f, but this will not be checked
1858                      // in this implementation. Instead carrier extension error will be checked.
1859                      assign det_cxt[1:0] = curr_rx_er &amp; ~curr_rx_dv;
1860                    
1861                      // valid_cxt indicates when a new 16-bit data word containing
1862                      // valid carrier extension is ready to analyse and either in
1863                      // carrier extend state or about to go into it.
1864                      assign valid_cxt = (rx_state_carr_ext | start_of_carr_ext) &amp;
1865                                         (det_cxt != 2'b00) &amp; (curr_buf_full | end_of_carr_ext);
1866                    
1867                    
1868                    
1869                      // Detect code errors
1870                      // ------------------
1871                      // Detect any bytes that have carrier extension error in them
1872                      assign det_cxt_err[1:0] = {(curr_data_16[15:8]  == 8'h1f),
1873                                                 (curr_data_16[7:0]   == 8'h1f)};
1874                    
1875                      // qualify detection of carrier extension error with RX_DV and RX_ER
1876                      assign det_cxt_err_qual = det_cxt_err &amp; ~curr_rx_dv &amp; curr_rx_er;
1877                    
1878                      // detect carrier extension error if any of the nibbles contain
1879                      // the carrier extension code (0x1f) and already in or about to
1880                      // enter carrier extension state
1881                      assign valid_cxt_err = (rx_state_carr_ext | start_of_carr_ext) &amp;
1882                                             (det_cxt_err_qual != 2'b00) &amp; curr_buf_full;
1883                    
1884                      // detect RX_ER assertion during RX_DV asserted (code error)
1885                      // This is will cause a symbol error or jabber error or both
1886                      assign valid_code_err = |(rx_dv_int &amp; rx_er_int);
1887                    
1888                      // hold rx_er until end of frame
1889                      always@(posedge rx_clk or negedge n_rxreset)
1890                      begin
1891       1/1              if (~n_rxreset)
1892       1/1                code_error &lt;= 1'b0;
1893       1/1              else if (rx_br_halt_pipe)
1894       <font color = "red">0/1     ==>        code_error &lt;= code_error;</font>
1895       1/1              else if (end_of_frame | ~enable_receive_rck | rx_state_idle)
1896       1/1                code_error &lt;= 1'b0;
1897       1/1              else if (valid_cxt_err | valid_code_err)
1898       <font color = "red">0/1     ==>        code_error &lt;= 1'b1;</font>
1899                        else
1900       1/1                code_error &lt;= code_error;
1901                      end
1902                    
1903                    // -----------------------------------------------------------------------------
1904                    // Detect start and end of frame and the beginning of carrier extension
1905                    //  -----------------------------------------------------------------------------
1906                    
1907                      // Edge detection for Start/End of frame and carrier extension recognition
1908                      always@(posedge rx_clk or negedge n_rxreset)
1909                      begin
1910       1/1              if (~n_rxreset)
1911                          begin
1912       1/1                  rx_dv_int_del &lt;= 2'b00;
1913       1/1                  rx_er_int_del &lt;= 2'b00;
1914                          end
1915       1/1              else if (~rx_br_halt_pipe)
1916                          begin
1917       1/1                  rx_dv_int_del &lt;= rx_dv_int;
1918       1/1                  rx_er_int_del &lt;= rx_er_int &amp; ~rx_dv_int;
1919                          end
                   <font color = "red">==>  MISSING_ELSE</font>
1920                      end
1921                    
1922                      // Detect edges on selected RX_DV and RX_ER
1923                      // These will be used for start and end of frame detections
1924                      // Only detect when both bits are high or low (this only affects
1925                      // PCS operation)
1926                      // Exclude symbol errors from rx_er edge detection as it is only used for
1927                      // detecting start and end of carrier extension.
1928                      assign rx_dv_int_le=  (rx_dv_int == 2'b11) &amp; (rx_dv_int_del != 2'b11);
1929                      assign rx_dv_int_te=  (rx_dv_int == 2'b00) &amp; (rx_dv_int_del != 2'b00);
1930                      assign rx_er_int_le=  (&amp;(rx_er_int &amp; ~rx_dv_int)) &amp; (rx_er_int_del != 2'b11);
1931                      assign rx_er_int_te= ~(&amp;(rx_er_int &amp; ~rx_dv_int)) &amp; (rx_er_int_del == 2'b11);
1932                    
1933                    
1934                      // define start of data condition
1935                      // This is when we are about to enter the RX_DATA state from RX_PREAMBLE
1936                      // Also gated with rx_dv_int to show that there is some valid data as well.
1937                      assign start_of_data = enable_receive_rck &amp; valid_pre &amp; valid_sfd &amp;
1938                                             |rx_dv_int &amp; rx_state_preamble;
1939                    
1940                      // define end of data condition
1941                      // End of data always indicated on falling edge of RX_DV when in
1942                      // RX_DATA state
1943                      assign end_of_data = rx_state_data &amp; rx_dv_int_te;
1944                    
1945                    
1946                      // detect start of carrier extension
1947                      // detected by looking for a rising edge on rx_er and rx_dv low,
1948                      // whilst in RX_DATA state (i.e. will exit this state next cycle)
1949                      // Only detect in gigabit half duplex mode.
1950                      assign start_of_carr_ext =
1951                             rx_state_data &amp; ~full_duplex &amp; gigabit &amp; rx_er_int_le;
1952                    
1953                    
1954                      // detect end of carrier extension
1955                      // detected by looking for a falling edge on rx_er and in RX_CARR_EXT state.
1956                      assign end_of_carr_ext = rx_state_carr_ext &amp; rx_er_int_te;
1957                    
1958                    
1959                    
1960                      // define end of frame condition
1961                      // end_of_frame always indicated on falling edge of RX_DV if any of the
1962                      // following requirements are met:
1963                      //   1. no valid carrier extension or
1964                      //   2. if slotTime requirement has already been reached or
1965                      //   3. if already in a burst.
1966                      // If already in carrier extension then set end_of_frame...
1967                      //   1. at the falling edge of RX_ER or
1968                      //   2. after slot time has elapsed.
1969                      assign end_of_frame =
1970                                (end_of_data &amp; (~start_of_carr_ext | slot_time_done)) |
1971                                (rx_state_carr_ext &amp; (end_of_carr_ext | slot_time_done));
1972                    
1973                    
1974                    
1975                    // -----------------------------------------------------------------------------
1976                    // Minimum Slot time counter
1977                    // -----------------------------------------------------------------------------
1978                    // Must check that ethernet frame meets minimum slot time requirements.
1979                    //
1980                    // For 10/100 mode this is 512 bit times (or 64 bytes) which must be taken up
1981                    // by the data (excluding preamble and SFD). This requirement will be redundant
1982                    // since MinFrameSize is checked later.
1983                    //
1984                    // For Gigabit Full Duplex mode this is 512 bit times (or 64 bytes) which must
1985                    // be taken up by the data (excluding preamble and SFD). This requirement will
1986                    // be redundant since MinFrameSize is checked later.
1987                    //
1988                    // For Gigabit half duplex mode this is 4096 bit times (or 512 bytes) which may
1989                    // be a combination of data (excluding preamble and SFD) and carrier extension.
1990                    //
1991                    // For gigabit half duplex mode bursting, the first in a burst must meet the
1992                    // above requirement of 512 bytes, but successive frames in a burst need only
1993                    // occupy the 64 bytes of data (excluding preamble and SFD). Again the later
1994                    // is checked by the MinFrameSize check.
1995                    
1996                    
1997                      // Count number of bytes that have valid data or valid carrier extension.
1998                      // Only count if in gigabit half duplex mode or if already in a burst.
1999                      always@(posedge rx_clk or negedge n_rxreset)
2000                      begin
2001       1/1               if (~n_rxreset)
2002       1/1                 slot_time_cnt &lt;= 10'b0000000000;
2003       1/1               else if (end_of_frame | ~enable_receive_rck | ~frame_being_decoded |
2004                                  ~gigabit | full_duplex | giga_bursting)
2005       1/1                 slot_time_cnt &lt;= 10'b0000000000;
2006       <font color = "red">0/1     ==>       else if ((valid_data | valid_cxt)) // should add in &quot;&amp; ~rx_br_halt_pipe&quot; here if supporting gigabit half duplex which we are not..</font>
2007       <font color = "red">0/1     ==>         slot_time_cnt &lt;= next_slot_time_cnt[9:0];</font>
2008                         else
2009       <font color = "red">0/1     ==>         slot_time_cnt &lt;= slot_time_cnt;</font>
2010                      end
2011                    
2012                    
2013                      // Count number of bytes that have either valid data or carrier extension
2014                      assign slot_time_cnt_inc = ({1'b0, det_data[0]} +
2015                                                  {1'b0, det_data[1]} +
2016                                                  {1'b0, det_cxt[0]}  +
2017                                                  {1'b0, det_cxt[1]});
2018                    
2019                      // assign next value for slot time counter (equals current plus increment)
2020                      assign next_slot_time_cnt = slot_time_cnt[9:0] +
2021                                                           {8'h00, slot_time_cnt_inc[1:0]};
2022                    
2023                    
2024                      // Decode when required count is reached.
2025                      // Set if new data or carrier extension is available and we have
2026                      // now reached the minimum slotTime requirement.
2027                      // forces to true if not in gigabit half duplex or already bursting.
2028                      assign slot_time_dec = ((valid_data | valid_cxt) &amp;
2029                                             not_min_slot_time &amp; next_slot_time_cnt[9]) |
2030                                             ~gigabit | full_duplex | giga_bursting;
2031                    
2032                    
2033                      // Determine whether slot time is too short
2034                      // Starts with the presumption that it is under sized and clears
2035                      // once required count is reached.
2036                      always@(posedge rx_clk or negedge n_rxreset)
2037                      begin
2038       1/1              if (~n_rxreset)
2039       1/1                not_min_slot_time &lt;= 1'b1;
2040                    
2041                        // Halt pipeline
2042       1/1              else if (rx_br_halt_pipe)
2043       <font color = "red">0/1     ==>        not_min_slot_time &lt;= not_min_slot_time;</font>
2044                    
2045                        // if finished or not enabled then preset
2046       1/1              else if (end_of_frame | ~enable_receive_rck | ~frame_being_decoded)
2047       1/1                not_min_slot_time &lt;= 1'b1;
2048                    
2049                        // else if the slot time is decoded reset not_min_slot_time
2050       1/1              else if (slot_time_dec)
2051       1/1                not_min_slot_time &lt;= 1'b0;
2052                    
2053                        // else maintain value
2054                        else
2055       <font color = "red">0/1     ==>        not_min_slot_time &lt;= not_min_slot_time;</font>
2056                      end
2057                    
2058                    
2059                      // assign a signal to show when slot time is complete
2060                      assign slot_time_done = slot_time_dec | ~not_min_slot_time;
2061                    
2062                    
2063                      //detect when in burst mode
2064                      always@(posedge rx_clk or negedge n_rxreset)
2065                      begin
2066       1/1              if (~n_rxreset)
2067       1/1                giga_bursting &lt;= 1'b0;
2068                    
2069                        // Halt pipeline
2070       1/1              else if (rx_br_halt_pipe)
2071       <font color = "red">0/1     ==>        giga_bursting &lt;= giga_bursting;</font>
2072                    
2073                        // if not in correct mode or no valid frame then reset
2074       1/1              else if (~gigabit | ~enable_receive_rck | full_duplex)
2075       1/1                giga_bursting &lt;= 1'b0;
2076                    
2077                        // maintain bursting until both RX_DV and RX_ER are low
2078       <font color = "red">0/1     ==>      else if ((curr_rx_dv == 2'b00) &amp; (curr_rx_er == 2'b00) &amp; curr_buf_full)</font>
2079       <font color = "red">0/1     ==>        giga_bursting &lt;= 1'b0;</font>
2080                    
2081                        // go into bursting mode if reach slot time
2082       <font color = "red">0/1     ==>      else if (slot_time_done)</font>
2083       <font color = "red">0/1     ==>        giga_bursting &lt;= 1'b1;</font>
2084                    
2085                        // else maintain value
2086                        else
2087       <font color = "red">0/1     ==>        giga_bursting &lt;= giga_bursting;</font>
2088                      end
2089                    
2090                    
2091                    // -----------------------------------------------------------------------------
2092                    // RX state machine to keep track of current phase during reception
2093                    // -----------------------------------------------------------------------------
2094                    
2095                      // receive state machine. Used for checking and filtering out preamble
2096                      // and SFD.
2097                      // Stay in IDLE when receive is disabled or after a frame is determined bad.
2098                      // Always move to IDLE when bad preamble seen.
2099                      // Move from IDLE to PREAMBLE when a rising edge on RX_DV seen. All data
2100                      // should be preamble until a valid SFD seen. Once SFD seen move to data.
2101                      // If at the end of RX_DATA, carrier extension is detected move into
2102                      // RX_CARR_EXT state, else move back to IDLE.
2103                      // In RX_CARR_EXT wait for either a new frame (bursting) or end
2104                      // of carrier extension (indicated by end_of_frame)
2105                      always @(*)
2106                      begin
2107       1/1              case(rx_state)
2108                           RX_PREAMBLE: // currently receiving preamble
2109                    
2110                                    // Premature end of frame detected
2111       1/1                          if (rx_dv_int_te)
2112       <font color = "red">0/1     ==>                     rx_state_nxt = RX_IDLE;</font>
2113                    
2114                                    // Bad preamble detected
2115       1/1                          else if (~valid_pre &amp; curr_buf_full)
2116       1/1                             rx_state_nxt = RX_IDLE;
2117                    
2118                                    // Valid SFD and preamble detected
2119       1/1                          else if (start_of_data)
2120       1/1                             rx_state_nxt = RX_DATA;
2121                    
2122                                    // Good preamble, no SFD yet
2123                                    else
2124       1/1                             rx_state_nxt = RX_PREAMBLE;
2125                    
2126                    
2127                           RX_DATA: // currently receiving data
2128                    
2129                                    // End of frame seen (i.e no carrier extenion)
2130       1/1                          if (end_of_frame)
2131       1/1                             rx_state_nxt = RX_IDLE;
2132                    
2133                                    // Beginning of carrier extension detected
2134       1/1                          else if (start_of_carr_ext)
2135       <font color = "red">0/1     ==>                     rx_state_nxt = RX_CARR_EXT;</font>
2136                    
2137                                    // More data to handle
2138                                    else
2139       1/1                             rx_state_nxt = RX_DATA;
2140                    
2141                    
2142                           RX_CARR_EXT: // Currently receiving carrier extension
2143                    
2144                                    // beginning of new frame detected (bursting)
2145       <font color = "red">0/1     ==>                  if (rx_dv_int_le)</font>
2146       <font color = "red">0/1     ==>                     rx_state_nxt = RX_PREAMBLE;</font>
2147                    
2148                                    // end of carrier extension detected
2149       <font color = "red">0/1     ==>                  else if (end_of_frame)</font>
2150       <font color = "red">0/1     ==>                     rx_state_nxt = RX_IDLE;</font>
2151                    
2152                                    // more valid carrier extension to handle
2153                                    else
2154       <font color = "red">0/1     ==>                     rx_state_nxt = RX_CARR_EXT;</font>
2155                    
2156                    
2157                           default: // RX_IDLE:
2158                                    // IDLE waiting for enable from control register and
2159                                    // a leading edge on rx_dv
2160       1/1                          if (rx_dv_int_le)
2161       1/1                             rx_state_nxt = RX_PREAMBLE;
2162                                    else
2163       1/1                             rx_state_nxt = RX_IDLE;
2164                    
2165                        endcase
2166                      end
2167                    
2168                      // synchronise state machine next state logic
2169                      // If rx id disabled then synchronously reset state machine.
2170                      always@(posedge rx_clk or negedge n_rxreset)
2171                      begin
2172       1/1              if (~n_rxreset)
2173       1/1                rx_state &lt;= RX_IDLE;
2174       1/1              else if (~enable_receive_rck)
2175       1/1                rx_state &lt;= RX_IDLE;
2176       1/1              else if (~rx_br_halt_pipe)
2177       1/1                rx_state &lt;= rx_state_nxt;
                   <font color = "red">==>  MISSING_ELSE</font>
2178                      end
2179                    
2180                      // decode states to make referencing easier
2181                      assign rx_state_preamble = (rx_state == RX_PREAMBLE);
2182                      assign rx_state_data     = (rx_state == RX_DATA);
2183                      assign rx_state_carr_ext = (rx_state == RX_CARR_EXT);
2184                      assign rx_state_idle     = ~rx_state_preamble &amp; ~rx_state_data &amp;
2185                                                 ~rx_state_carr_ext;
2186                    
2187                    // -----------------------------------------------------------------------------
2188                    // Detect when a valid frame is being handled by the decoding logic
2189                    // -----------------------------------------------------------------------------
2190                    
2191                      // Detect beginning of valid data and hold until end of frame
2192                      // This is used for enabling/resetting the logic associated with
2193                      // the frame decoding.
2194                      always@(posedge rx_clk or negedge n_rxreset)
2195                      begin
2196       1/1              if (~n_rxreset)
2197       1/1                valid_frame_detected &lt;= 1'b0;
2198       1/1              else if (~enable_receive_rck)
2199       1/1                valid_frame_detected &lt;= 1'b0;
2200       1/1              else if (rx_br_halt_pipe)
2201       <font color = "red">0/1     ==>        valid_frame_detected &lt;= valid_frame_detected;</font>
2202       1/1              else if (start_of_data)
2203       1/1                valid_frame_detected &lt;= 1'b1;
2204                    
2205                        // Detection of tiny runt frame - ensure this unique case where
2206                        // end_of_frame for runt frame is coincident with decoding_finished
2207                        // from previous frame - this ensures the runt is dropped
2208       1/1              else if (end_of_frame &amp; decoding_finished &amp; pipeline_finished)
2209       <font color = "red">0/1     ==>        valid_frame_detected &lt;= 1'b0;</font>
2210                    
2211       1/1              else if (last_aligned_data &amp; (decoding_finished | end_of_frame))
2212       1/1                valid_frame_detected &lt;= 1'b0;
2213                        else
2214       1/1                valid_frame_detected &lt;= valid_frame_detected;
2215                      end
2216                    
2217                      // frame_being_decoded is combination of the next state being data
2218                      // or already have valid_frame_detected
2219                      assign frame_being_decoded = start_of_data | valid_frame_detected;
2220                    
2221                      // Hold end of frame until pipeline_finished
2222                      // This will always be after decoding has completed.
2223                      // Special case to reset decoding_finished when only one nibble of
2224                      // data is present in the frame.
2225                      // Don't set decoding_finished if already set.
2226                      always@(posedge rx_clk or negedge n_rxreset)
2227                      begin
2228       1/1              if (~n_rxreset)
2229       1/1                decoding_finished &lt;= 1'b0;
2230       1/1              else if (~enable_receive_rck)
2231       1/1                decoding_finished &lt;= 1'b0;
2232       1/1              else if (rx_br_halt_pipe)
2233       <font color = "red">0/1     ==>        decoding_finished &lt;= decoding_finished;</font>
2234                    //    else if (end_of_frame &amp; ~decoding_finished)
2235       1/1              else if (end_of_frame | rx_state_idle) // ETH-1706
2236       1/1                decoding_finished &lt;= 1'b1;
2237       1/1              else if (pipeline_finished |
2238                                 (~frame_in_pipeline &amp; ~last_align_data_tag))
2239       1/1                decoding_finished &lt;= 1'b0;
2240                        else
2241       1/1                decoding_finished &lt;= decoding_finished;
2242                      end
2243                    
2244                    // -----------------------------------------------------------------------------
2245                    // Buffer to realign valid data after striping out SFD and preamble
2246                    // -----------------------------------------------------------------------------
2247                    // Strip out Preamble and SFD from incoming 16 bit data and align
2248                    // back into a new 16 bit word (new_data_align).
2249                    // Incoming data from current data buffer (curr_data_16), includes SFD and
2250                    // preamble bytes. These must be removed by only taking valid data bytes
2251                    // indicated by det_data[1:0] (i.e either 0, 1 or 2 bytes of valid data
2252                    // may be present).
2253                    // This valid data must then be re-aligned into a single 16 bit word again.
2254                    
2255                      // Keep an offset pointer to keep track of current byte being
2256                      // written to in 16 bit alignment buffer.
2257                      always @(posedge rx_clk or negedge n_rxreset)
2258                      begin
2259       1/1              if (~n_rxreset)
2260       1/1                align_pntr &lt;= 1'b0;
2261                    
2262                        // Halt pipeline
2263       1/1              else if (rx_br_halt_pipe)
2264       <font color = "red">0/1     ==>        align_pntr &lt;= align_pntr;</font>
2265                    
2266                        // If receive is disabled reset alignment pointer to byte 0
2267       1/1              else if (~enable_receive_rck | ~frame_being_decoded | last_aligned_data)
2268       1/1                align_pntr &lt;= 1'b0;
2269                    
2270                        // If last data transfered has overflowed a new transfer will
2271                        // be initiated. Zero pointer after this event
2272                        // Note that if this event doesn't happen then the pointer will
2273                        // already be zero (no overflow)
2274       1/1              else if (force_over_align)
2275       <font color = "red">0/1     ==>        align_pntr &lt;= 1'b0;</font>
2276                    
2277                        // When new valid data available, assign align_pntr to new value
2278       1/1              else if (valid_data)
2279       1/1                align_pntr &lt;= next_align_pntr;
2280                    
2281                        // Else maintain value
2282                        else
2283       1/1                align_pntr &lt;= align_pntr;
2284                      end
2285                    
2286                    
2287                      // Decode next state of alignment buffer.
2288                      // Need to know next offset value (next_align_pntr), whether the buffer
2289                      // will be full on the next clock (next_align_full), and whether the buffer
2290                      // will overflow (next_align_overflow).
2291                      // Decoding depends on current offset (align_pntr) and number of new data
2292                      // bytes (det_data).
2293                      always @(det_data or align_pntr)
2294                      begin
2295       1/1              case ({det_data, align_pntr})
2296                           3'b00_0 : begin // nothing in buffer, nothing new
2297       1/1                             next_align_pntr     = 1'b0;
2298       1/1                             next_align_full     = 1'b0;
2299       1/1                             next_align_overflow = 1'b0;
2300                                     end
2301                    
2302                           3'b00_1 : begin // one byte in buffer, nothing new
2303       <font color = "red">0/1     ==>                     next_align_pntr     = 1'b1;</font>
2304       <font color = "red">0/1     ==>                     next_align_full     = 1'b0;</font>
2305       <font color = "red">0/1     ==>                     next_align_overflow = 1'b0;</font>
2306                                     end
2307                    
2308                           3'b01_0 : begin // nothing in buffer, one byte new
2309       1/1                             next_align_pntr     = 1'b1;
2310       1/1                             next_align_full     = 1'b0;
2311       1/1                             next_align_overflow = 1'b0;
2312                                     end
2313                    
2314                           3'b01_1 : begin // one byte in buffer, one byte new
2315       1/1                             next_align_pntr     = 1'b0;
2316       1/1                             next_align_full     = 1'b1;
2317       1/1                             next_align_overflow = 1'b0;
2318                                     end
2319                    
2320                           3'b10_0 : begin // nothing in buffer, one byte new
2321       1/1                             next_align_pntr     = 1'b1;
2322       1/1                             next_align_full     = 1'b0;
2323       1/1                             next_align_overflow = 1'b0;
2324                                     end
2325                    
2326                           3'b10_1 : begin // one byte in buffer, one byte new
2327       <font color = "red">0/1     ==>                     next_align_pntr     = 1'b0;</font>
2328       <font color = "red">0/1     ==>                     next_align_full     = 1'b1;</font>
2329       <font color = "red">0/1     ==>                     next_align_overflow = 1'b0;</font>
2330                                     end
2331                    
2332                           3'b11_0 : begin // nothing in buffer, two bytes new
2333       1/1                             next_align_pntr     = 1'b0;
2334       1/1                             next_align_full     = 1'b1;
2335       1/1                             next_align_overflow = 1'b0;
2336                                     end
2337                    
2338                           default : begin //3'b11_1
2339       <font color = "red">0/1     ==>                     next_align_pntr     = 1'b1;</font>
2340       <font color = "red">0/1     ==>                     next_align_full     = 1'b1;</font>
2341       <font color = "red">0/1     ==>                     next_align_overflow = 1'b1;</font>
2342                                     end
2343                        endcase
2344                      end
2345                    
2346                      // Indicate when there has been an overflow of the alignment buffer.
2347                      // This will be used to force the residue back into the alignment buffer,
2348                      // ready for the next new data or at the end of a frame.
2349                      always@(posedge rx_clk or negedge n_rxreset)
2350                      begin
2351       1/1              if (~n_rxreset)
2352       1/1                prev_align_overflowd &lt;= 1'b0;
2353       1/1              else if (rx_br_halt_pipe)
2354       <font color = "red">0/1     ==>        prev_align_overflowd &lt;= prev_align_overflowd;</font>
2355       1/1              else if (~enable_receive_rck | ~frame_being_decoded | last_aligned_data)
2356       1/1                prev_align_overflowd &lt;= 1'b0;
2357       1/1              else if (next_align_overflow &amp; valid_data)
2358       <font color = "red">0/1     ==>        prev_align_overflowd &lt;= 1'b1;</font>
2359       1/1              else if (valid_data | force_over_align)
2360       1/1                prev_align_overflowd &lt;= 1'b0;
2361                        else
2362       1/1                prev_align_overflowd &lt;= prev_align_overflowd;
2363                      end
2364                    
2365                      // detect when final data in frame loaded into the alignment buffer
2366                      always@(posedge rx_clk or negedge n_rxreset)
2367                      begin
2368       1/1              if (~n_rxreset)
2369       1/1                last_aligned_data &lt;= 1'b0;
2370       1/1              else if (~enable_receive_rck)
2371       1/1                last_aligned_data &lt;= 1'b0;
2372       1/1              else if (rx_br_halt_pipe)
2373       <font color = "red">0/1     ==>        last_aligned_data &lt;= last_aligned_data;</font>
2374       1/1              else if (set_last_aligned_data)
2375       1/1                last_aligned_data &lt;= 1'b1;
2376       1/1              else if (~frame_being_decoded | decoding_finished)
2377       1/1                last_aligned_data &lt;= 1'b0;
2378                        else
2379       1/1                last_aligned_data &lt;= last_aligned_data;
2380                      end
2381                    
2382                      assign set_last_aligned_data = ((end_of_data &amp; valid_data &amp; ~next_align_overflow) |
2383                                                      (end_of_data &amp; ~valid_data &amp; ~prev_align_overflowd) |
2384                                                       force_over_align);
2385                    
2386                    
2387                      // async assign last_align_data_tag for writing into pipeline, so that
2388                      // special case of missaligned 10/100 nibble frame is recognised.
2389                      assign last_align_data_tag = last_aligned_data | last_odd_nibble;
2390                    
2391                    
2392                      // Detect when an missaligned 10/100 nibble frame forces the last data
2393                      // into the alignment buffer. Not set when a force_over_align is done.
2394                      assign last_odd_nibble = nibble_pntr[0] &amp; end_of_data &amp;
2395                                               ~((valid_data &amp; next_align_overflow) |
2396                                                 (~valid_data &amp; prev_align_overflowd));
2397                    
2398                    
2399                      // force overflow to be transfered to alignment buffer at end_of_data.
2400                      // If there is more valid data, then force overflow into the alignment
2401                      // buffer if there will be further overflow once data is loaded.
2402                      // If there is no valid data incoming, then need to see if the previous
2403                      // valid data caused an overflow and then force it into the alignment buffer.
2404                      always@(posedge rx_clk or negedge n_rxreset)
2405                      begin
2406       1/1              if (~n_rxreset)
2407       1/1                force_over_align &lt;= 1'b0;
2408       1/1              else if (~enable_receive_rck)
2409       1/1                force_over_align &lt;= 1'b0;
2410                    
2411                        // Halt pipeline
2412       1/1              else if (rx_br_halt_pipe)
2413       <font color = "red">0/1     ==>        force_over_align &lt;= force_over_align;</font>
2414                    
2415                        // Detection of tiny runt frame - ensure this unique case where
2416                        // end_of_frame for runt frame is coincident with decoding_finished
2417                        // from previous frame - this ensures the runt is dropped
2418       1/1              else if (end_of_frame &amp; decoding_finished &amp; pipeline_finished)
2419       <font color = "red">0/1     ==>        force_over_align &lt;= 1'b0;</font>
2420                    
2421       1/1              else if ((end_of_data &amp; valid_data &amp; next_align_overflow) |
2422                                 (end_of_data &amp; ~valid_data &amp; prev_align_overflowd))
2423       <font color = "red">0/1     ==>        force_over_align &lt;= 1'b1;</font>
2424                        else
2425       1/1                force_over_align &lt;= 1'b0;
2426                      end
2427                    
2428                      // right justify incoming new data
2429                      // This will strip out any invalid data (e.g. SFD or preamble) that happened
2430                      // before valid data came in.
2431                      always @(curr_data_16 or det_data)
2432                      begin
2433       1/1              case (det_data)
2434       1/1                 2'b10  : curr_data_align[17:0] = {1'b0,curr_data_16[17],8'h00, curr_data_16[15:8]};
2435       1/1                 2'b01  : curr_data_align[17:0] = {1'b0,curr_data_16[16],8'h00, curr_data_16[7:0]};
2436       1/1                 default: curr_data_align[17:0] = curr_data_16[17:0];
2437                        endcase
2438                      end
2439                    
2440                      // new_data_align data alignment buffer
2441                      // Used to re-align data into 16 bit chunks after stripping out
2442                      // preamble and SFD.
2443                      // This buffer is split into two halves. Firstly the lower 16 bits
2444                      // is the alignment buffer itself, that will be used to present aligned
2445                      // data for further processing.
2446                      // Secondly the upper 8 bits forms the residue for overspill from the
2447                      // lower 16 bits. This residue is moved back into the lower 16 bits
2448                      // when an overflow is detected.
2449                      always @(posedge rx_clk or negedge n_rxreset)
2450                      begin
2451       1/1              if (~n_rxreset)
2452       1/1                new_data_align[26:0] &lt;= {3'h0,24'h000000};  // 3{parity} . orginal data_align
2453                    
2454                        // synchronous reset
2455       1/1              else if (~enable_receive_rck)
2456       1/1                new_data_align[26:0] &lt;= {3'h0,24'h000000};  // 3{parity} . orginal data_align
2457                    
2458                        // Halt pipeline
2459       1/1              else if (rx_br_halt_pipe)
2460       <font color = "red">0/1     ==>        new_data_align  &lt;= new_data_align;</font>
2461                    
2462                        // if new valid data is available, and we didn't overflow last time
2463                        // load up the correct number of valid bytes into the buffer.
2464                        // If align_pntr is low then start new data at the 1st byte, and zero
2465                        // the residue.
2466       1/1              else if (valid_data &amp; ~align_pntr &amp; ~prev_align_overflowd)
2467                          begin
2468       1/1                  new_data_align[15:0]  &lt;= curr_data_align[15:0];
2469       1/1                  new_data_align[23:16] &lt;= 8'h00;
2470       1/1                  new_data_align[26:24] &lt;= {1'b0,curr_data_align[17:16]}; // Parity
2471                          end
2472                    
2473                        // if new valid data is available, and we didn't overflow last time
2474                        // load up the correct number of valid bytes into the buffer.
2475                        // If align_pntr is high then start new data at the 2nd byte, and
2476                        // maintain the 1st byte. (align_pntr must be high because of IF order)
2477       1/1              else if (valid_data &amp; ~prev_align_overflowd)
2478                          begin
2479       <font color = "red">0/1     ==>          new_data_align[7:0]   &lt;= new_data_align[7:0];</font>
2480       <font color = "red">0/1     ==>          new_data_align[23:8]  &lt;= curr_data_align[15:0];</font>
2481       <font color = "red">0/1     ==>          new_data_align[24]    &lt;= new_data_align[24];</font>
2482       <font color = "red">0/1     ==>          new_data_align[26:25] &lt;= curr_data_align[17:16]; // passing parity of curr_data_align[15:0]</font>
2483                          end
2484                    
2485                        // if previous store overflowed and we have more new valid data, need
2486                        // to ensure residue is placed in the bottom byte (marked as used by
2487                        // this point). (prev_align_overflowd must be high because of IF order)
2488                        // Always start new data at the 2nd byte.
2489       1/1              else if (valid_data)
2490                          begin
2491       <font color = "red">0/1     ==>          new_data_align[7:0]   &lt;= new_data_align[23:16];</font>
2492       <font color = "red">0/1     ==>          new_data_align[23:8]  &lt;= curr_data_align[15:0];</font>
2493       <font color = "red">0/1     ==>          new_data_align[24]    &lt;= new_data_align[26];</font>
2494       <font color = "red">0/1     ==>          new_data_align[26:25] &lt;= curr_data_align[17:16]; // passing parity of curr_data_align[15:0]</font>
2495                          end
2496                    
2497                        // if previous store overflowed and was the last data, a force_overflow
2498                        // will be activated. Copy residue into lowest byte and zero rest of
2499                        // alignment buffer.
2500       1/1              else if (force_over_align)
2501                          begin
2502       <font color = "red">0/1     ==>          new_data_align[7:0]   &lt;= new_data_align[23:16];</font>
2503       <font color = "red">0/1     ==>          new_data_align[23:8]  &lt;= 16'h0000;</font>
2504       <font color = "red">0/1     ==>          new_data_align[24]    &lt;= new_data_align[26];</font>
2505       <font color = "red">0/1     ==>          new_data_align[26:25] &lt;= 2'b00;                 // parity of 16'h0000</font>
2506                          end
                        MISSING_ELSE
2507                      end
2508                    
2509                      // Indicate when new aligned data is available
2510                      // Either when the alignment buffer is filled or when the last data in
2511                      // a frame is about to be written into the pipeline (either when last current
2512                      // data nibble or when forced overflow of the alignment buffer).
2513                      always@(posedge rx_clk or negedge n_rxreset)
2514                      begin
2515       1/1              if (~n_rxreset)
2516       1/1                 new_aligned_data &lt;= 1'b0;
2517       1/1              else if (~enable_receive_rck | ~frame_being_decoded | last_aligned_data |
2518                                  rx_br_halt_pipe)
2519       1/1                new_aligned_data &lt;= 1'b0;
2520                    
2521                        // Detection of tiny runt frame - ensure this unique case where
2522                        // end_of_frame for runt frame is coincident with decoding_finished
2523                        // from previous frame - this ensures the runt is dropped
2524       1/1              else if (end_of_frame &amp; decoding_finished &amp; pipeline_finished)
2525       <font color = "red">0/1     ==>        new_aligned_data &lt;= 1'b0;</font>
2526                    
2527       1/1              else if ((next_align_full &amp; valid_data) |
2528                                 (end_of_data &amp; valid_data) |
2529                                 force_over_align)
2530       1/1                new_aligned_data &lt;= 1'b1;
2531                        else
2532       1/1                new_aligned_data &lt;= 1'b0;
2533                      end
2534                    
2535                      // Indicate how many bytes are valid in new aligned data
2536                      // This is updated whenever new align data is available and
2537                      // excludes any overflow (i.e. a maximum of 2 bytes)
2538                      always@(posedge rx_clk or negedge n_rxreset)
2539                      begin
2540       1/1              if (~n_rxreset)
2541       1/1                no_aligned_data  &lt;= 2'b00;
2542                    
2543                        // If frame is complete ensure that no_aligned_data is reset
2544       1/1              else if (last_aligned_data | ~enable_receive_rck | ~frame_being_decoded |
2545                                  rx_br_halt_pipe)
2546       1/1                no_aligned_data &lt;= 2'b00;
2547                    
2548                        // if there is new data about to be loaded into the align buffer
2549                        // which will fill or overflow it then there is a maximum of 2 bytes
2550       1/1              else if (next_align_full &amp; (valid_data | end_of_data))
2551       1/1                no_aligned_data &lt;= 2'b10;
2552                    
2553                        // Else if there is new data about to be loaded into the align buffer
2554                        // which doesn't fill it then there must be either zero or one
2555                        // byte as indicated by the next alignment pointer value.
2556       1/1              else if (valid_data | end_of_data)
2557       1/1                no_aligned_data &lt;= {1'b0, next_align_pntr};
2558                    
2559                        // if the last data in a frame caused an overflow of the
2560                        // align buffer then there will always be one byte for
2561                        // the force_over_align
2562       1/1              else if (force_over_align)
2563       <font color = "red">0/1     ==>        no_aligned_data &lt;= 2'b01;</font>
2564                    
2565                        // Else maintain value
2566                        else
2567       1/1                no_aligned_data &lt;= no_aligned_data;
2568                      end
2569                    
2570                    // -----------------------------------------------------------------------------
2571                    // Extract specific fields from frame
2572                    // Decoder operates based on new_data_align strobe.
2573                    // -----------------------------------------------------------------------------
2574                      assign udp_dest_addr = ext_dest_port;
2575                      // instantiate the decoding module
2576                      gem_rx_decode  #(
2577                           .grouped_params(grouped_params)
2578                      ) i_rx_deco (
2579                    
2580                        // system signals
2581                        .n_rxreset            (n_rxreset),
2582                        .rx_clk               (rx_clk),
2583                    
2584                        // Mode selection
2585                        .enable_receive_rck   (enable_receive_rck),
2586                        .pause_enable_rck     (pause_enable_rck),
2587                        .rx_toe_enable        (rx_toe_enable),
2588                        .frer_6b_tag          (frer_6b_tag),
2589                    
2590                        // Decode control signals
2591                        .frame_being_decoded  (frame_being_decoded),
2592                        .end_of_frame         (set_last_aligned_data),
2593                        .pause_add_match      (pause_add_match),
2594                        .start_of_data        (start_of_data),
2595                        .new_aligned_data     (new_aligned_data),
2596                        .new_data_align       (new_data_align[23:0]),
2597                        .rx_no_pause_frames   (rx_no_pause_frames),
2598                    
2599                        // external filter interface outputs
2600                        .ext_da               (ext_da),
2601                        .ext_da_stb           (ext_da_stb),
2602                        .ext_sa               (ext_sa),
2603                        .ext_sa_stb           (ext_sa_stb),
2604                        .ext_type             (ext_type),
2605                        .ext_type_stb         (ext_type_stb),
2606                        .ext_ip_sa            (ext_ip_sa),
2607                        .ext_ip_sa_stb        (ext_ip_sa_stb),
2608                        .ext_ip_da            (ext_ip_da),
2609                        .ext_ip_da_stb        (ext_ip_da_stb),
2610                        .ext_source_port      (ext_source_port),
2611                        .ext_sp_stb           (ext_sp_stb),
2612                        .ext_dest_port        (ext_dest_port),
2613                        .ext_dp_stb           (ext_dp_stb),
2614                        .ext_ipv6             (ext_ipv6),
2615                    
2616                        .stacked_vlantype     (stacked_vlantype),
2617                        .ext_vlan_tag1        (ext_vlan_tag1),
2618                        .ext_vlan_tag1_stb    (ext_vlan_tag1_stb),
2619                        .ext_vlan_tag2        (ext_vlan_tag2),
2620                        .ext_vlan_tag2_stb    (ext_vlan_tag2_stb),
2621                        .ext_has_2vlans       (ext_has_2vlans),
2622                        .drop_pause_frame     (drop_pause_frame),
2623                    
2624                        .frer_rtag_ethertype  (frer_rtag_ethertype),
2625                        .frer_rtag_mark_early (frer_rtag_mark_early),
2626                        //      .frer_rtag_seqnum     (),   // This version is not used, it is extracted later
2627                        //      .frer_rtag_seqnum_stb (),   // based on frer_rtag_mark_early to match pipeline
2628                    
2629                        // precision time protocol signals for IEEE 1588 support
2630                        .sof_rx               (sof_rx),
2631                        .sof_rx_tog           (sof_rx_tog),
2632                        .sync_frame_rx        (sync_frame_rx),
2633                        .delay_req_rx         (delay_req_rx),
2634                        .pdelay_req_rx        (pdelay_req_rx),
2635                        .pdelay_resp_rx       (pdelay_resp_rx),
2636                        .general_frame_rx     (general_frame_rx),
2637                        .ptp_unicast_ena      (ptp_unicast_ena_rck),
2638                        .rx_ptp_unicast       (rx_ptp_unicast),
2639                    
2640                        // Index for Packet Fields
2641                        .index_cnt_sof        (index_cnt_sof),
2642                        .index_cnt_type       (index_cnt_type),
2643                        .index_cnt_l3         (index_cnt_l3),
2644                        .index_cnt_l4         (index_cnt_l4),
2645                        .udptcp_offset        (udptcp_offset),
2646                        .pld_offset           (pld_offset),
2647                        .pld_offset_vld       (pld_offset_vld),
2648                    
2649                        // Frame type and status outputs
2650                        .vlan_tagged          (vlan_tagged),
2651                        .priority_tagged      (priority_tagged),
2652                        .tci                  (tci),
2653                        .length_field         (length_field),
2654                        .pause_frame          (pause_frame),
2655                        .pause_time           (pause_time),
2656                        .snap_frame           (snap_frame),
2657                        .ip_v4_frame          (ip_v4_frame),
2658                        .ip_v6_frame          (ip_v6_frame),
2659                        .arp_frame            (arp_frame),
2660                        .tcp_frame            (tcp_frame),
2661                        .udp_frame            (udp_frame),
2662                        .ip_ck_err            (ip_ck_err),
2663                        .tcp_udp_ck_err       (tcp_udp_ck_err),
2664                    
2665                        // Matches for screener module - Queue Priority
2666                        .ip_v4_tos            (ip_v4_tos),
2667                        .ip_v6_tc             (ip_v6_tc),
2668                    
2669                        .rsc_stop             (rsc_stop),
2670                        .rsc_push             (rsc_push),
2671                        .tcp_seqnum           (tcp_seqnum),
2672                        .tcp_syn              (tcp_syn),
2673                        .tcp_payload_len      (tcp_payload_len),
2674                    
2675                        // PFC pause frame signals
2676                        .pfc_enable_rck       (pfc_enable_rck),
2677                        .pfc_pause_frame      (pfc_pause_frame),
2678                        .pfc_pause_time0      (pfc_pause_time0),
2679                        .pfc_pause_time1      (pfc_pause_time1),
2680                        .pfc_pause_time2      (pfc_pause_time2),
2681                        .pfc_pause_time3      (pfc_pause_time3),
2682                        .pfc_pause_time4      (pfc_pause_time4),
2683                        .pfc_pause_time5      (pfc_pause_time5),
2684                        .pfc_pause_time6      (pfc_pause_time6),
2685                        .pfc_pause_time7      (pfc_pause_time7),
2686                        .priority_enable      (priority_enable)
2687                    
2688                      );
2689                    
2690                    // -----------------------------------------------------------------------------
2691                    // instantiate the rx PFC pause counter
2692                    // Note that the counter continues even if rx_br_halt_pipe is set.
2693                    // -----------------------------------------------------------------------------
2694                    
2695                      gem_rx_pfc_counter i_rx_pfc_counter(
2696                    
2697                        // system signals.
2698                        .n_rxreset               (n_rxreset),
2699                        .rx_clk                  (rx_clk),
2700                    
2701                        // register signals
2702                        .enable_receive_rck      (enable_receive_rck),
2703                        .retry_test_rck          (retry_test_rck),
2704                        .tx_byte_mode            (tx_byte_mode),
2705                    
2706                        // PFC pause framesignals
2707                        .pfc_enable_rck          (pfc_enable_rck),
2708                        .new_pfc_pause_time0     (new_pfc_pause_time0),
2709                        .new_pfc_pause_time1     (new_pfc_pause_time1),
2710                        .new_pfc_pause_time2     (new_pfc_pause_time2),
2711                        .new_pfc_pause_time3     (new_pfc_pause_time3),
2712                        .new_pfc_pause_time4     (new_pfc_pause_time4),
2713                        .new_pfc_pause_time5     (new_pfc_pause_time5),
2714                        .new_pfc_pause_time6     (new_pfc_pause_time6),
2715                        .new_pfc_pause_time7     (new_pfc_pause_time7),
2716                        .new_pfc_pause_tog       (new_pfc_pause_tog),
2717                        .new_priority_enable     (new_priority_enable),
2718                        .rx_pfc_paused           (rx_pfc_paused)
2719                      );
2720                    
2721                    // -----------------------------------------------------------------------------
2722                    // instantiate the rx filter block to filter out unwanted frames
2723                    // -----------------------------------------------------------------------------
2724                      gem_filter #(
2725                         .p_num_spec_add_filters     (p_num_spec_add_filters)
2726                       )
2727                    
2728                         i_filter (
2729                    
2730                         // system inputs.
2731                         .n_rxreset            (n_rxreset),
2732                         .rx_clk               (rx_clk),
2733                    
2734                         .tx_en                (tx_en),
2735                         // signals coming via loop back module.
2736                         .ext_match1_from_loop (ext_match1_from_loop),
2737                         .ext_match2_from_loop (ext_match2_from_loop),
2738                         .ext_match3_from_loop (ext_match3_from_loop),
2739                         .ext_match4_from_loop (ext_match4_from_loop),
2740                    
2741                         // signals coming from gem_rx
2742                         .frame_being_decoded  (frame_being_decoded),
2743                         .ext_da               (ext_da),
2744                         .ext_da_stb           (ext_da_stb),
2745                         .ext_sa               (ext_sa),
2746                         .ext_sa_stb           (ext_sa_stb),
2747                         .ext_type             (ext_type),
2748                         .ext_type_stb         (ext_type_stb),
2749                         .code_error           (code_error),
2750                         .rx_no_pause_frames   (rx_no_pause_frames),
2751                         .rm_non_vlan          (rm_non_vlan),
2752                         .vlan_tagged          (vlan_tagged),
2753                    
2754                         // signals going to gem_rx
2755                         .pause_add_match      (pause_add_match),
2756                         .rx_store_frame       (rx_store_frame),
2757                    
2758                         // signals coming from gem_reg_top (gem_registers).
2759                         .ext_match_en         (ext_match_en),
2760                         .uni_hash_en          (uni_hash_en),
2761                         .multi_hash_en        (multi_hash_en),
2762                         .no_broadcast         (no_broadcast),
2763                         .copy_all_frames      (copy_all_frames),
2764                         .hash                 (hash),
2765                         .spec_add_filter_regs    (spec_add_filter_regs),
2766                         .spec_add_filter_active  (spec_add_filter_active),
2767                         .fil_add_match           (fil_add_match),
2768                         .mask_add1            (mask_add1),
2769                         .spec_type1           (spec_type1),
2770                         .spec_type2           (spec_type2),
2771                         .spec_type3           (spec_type3),
2772                         .spec_type4           (spec_type4),
2773                         .spec_type1_active    (spec_type1_active),
2774                         .spec_type2_active    (spec_type2_active),
2775                         .spec_type3_active    (spec_type3_active),
2776                         .spec_type4_active    (spec_type4_active),
2777                         .full_duplex          (full_duplex),
2778                         .loopback_local       (loopback_local),
2779                         .en_half_duplex_rx    (en_half_duplex_rx),
2780                    
2781                         // signals going to gem_dma_top
2782                         .fil_broadcast_frame  (fil_broadcast_frame),
2783                         .fil_multicast_frame  (fil_multicast_frame),
2784                         .fil_mult_hash_match  (fil_mult_hash_match),
2785                         .fil_uni_hash_match   (fil_uni_hash_match),
2786                         .fil_ext_match1       (fil_ext_match1),
2787                         .fil_ext_match2       (fil_ext_match2),
2788                         .fil_ext_match3       (fil_ext_match3),
2789                         .fil_ext_match4       (fil_ext_match4),
2790                         .fil_type_match1      (fil_type_match1),
2791                         .fil_type_match2      (fil_type_match2),
2792                         .fil_type_match3      (fil_type_match3),
2793                         .fil_type_match4      (fil_type_match4)
2794                      );
2795                    
2796                    // -----------------------------------------------------------------------------
2797                    // Detect when frame is matched by filter
2798                    // -----------------------------------------------------------------------------
2799                    
2800                      // Detect when frame is matched and hold until end of frame
2801                      // Only set when rx_store_frame pulse is sent from filter block and
2802                      // it's not already high and we are still decoding.
2803                      always@(posedge rx_clk or negedge n_rxreset)
2804                      begin
2805       1/1              if (~n_rxreset)
2806       1/1                frame_matched &lt;= 1'b0;
2807       1/1              else if (last_aligned_data | ~enable_receive_rck | ~frame_being_decoded)
2808       1/1                frame_matched &lt;= 1'b0;
2809       1/1              else if (rx_store_frame &amp; ~frame_matched)
2810       1/1                frame_matched &lt;= 1'b1;
2811                        else
2812       1/1                frame_matched &lt;= frame_matched;
2813                      end
2814                    
2815                    // -----------------------------------------------------------------------------
2816                    // Signals generated during decoding process need saving for status report
2817                    // -----------------------------------------------------------------------------
2818                    
2819                      // Save decoding stage outputs for use at end of packet status update.
2820                      // Require save versions as the decoding process may be processing a
2821                      // new incoming frame by this stage.
2822                      // Status of decoding signals is sampled and held at end_of_frame only if
2823                      // not waiting for the end of the previous frame (decoding_finished still
2824                      // high).
2825                      generate if (p_num_spec_add_filters &gt; 32'd0) begin : gen_spec_add_filter
2826                       reg  [p_num_spec_add_filters-1:0] add_match_saved_r;
2827                       always@(posedge rx_clk or negedge n_rxreset)
2828                       begin
2829       1/1               if (~n_rxreset)
2830       1/1                     add_match_saved_r      &lt;= {p_num_spec_add_filters{1'b0}}; // specific address register match
2831       1/1               else if (pipeline_finished | ~enable_receive_rck)
2832       1/1                     add_match_saved_r      &lt;= {p_num_spec_add_filters{1'b0}};
2833       1/1               else if (end_of_frame &amp; ~decoding_finished)
2834       1/1                     add_match_saved_r      &lt;= fil_add_match[p_num_spec_add_filters:1];
                        MISSING_ELSE
2835                       end
2836                       assign add_match_saved = {add_match_saved_r,1'b0};
2837                       assign add_match_saved_bot = add_match_saved_r[0];
2838                      end else begin : gen_no_spec_add
2839                       assign add_match_saved = 1'b0;
2840                       assign add_match_saved_bot = 1'b0;
2841                      end
2842                      endgenerate
2843                    
2844                      always@(posedge rx_clk or negedge n_rxreset)
2845                      begin
2846       1/1             if (~n_rxreset)
2847                         begin
2848       1/1                 scr_drop_frame_saved   &lt;= 1'b0;
2849       1/1                 slot_time_saved        &lt;= 1'b0;
2850       1/1                 code_error_saved       &lt;= 1'b0;
2851       1/1                 vlan_tagged_saved      &lt;= 1'b0;
2852       1/1                 length_field_saved     &lt;= 16'hffff;
2853       1/1                 pause_frame_saved      &lt;= 1'b0;
2854       1/1                 pause_time_saved       &lt;= 16'h0000;
2855       1/1                 pfc_pause_frame_saved  &lt;= 1'b0;
2856       1/1                 snap_frame_saved       &lt;= 1'b0;
2857       1/1                 ip_v4_frame_saved      &lt;= 1'b0;
2858       1/1                 arp_req_frame_saved    &lt;= 1'b0;
2859       1/1                 tcp_frame_saved        &lt;= 1'b0;
2860       1/1                 udp_frame_saved        &lt;= 1'b0;
2861       1/1                 ip_ck_err_saved        &lt;= 1'b0;
2862       1/1                 tcp_udp_ck_err_saved   &lt;= 1'b0;
2863       1/1                 drop_pause_frame_saved &lt;= 1'b0;
2864       1/1                 broad_frame_saved      &lt;= 1'b0;
2865       1/1                 multi_frame_saved      &lt;= 1'b0;
2866       1/1                 multi_match_saved      &lt;= 1'b0;
2867       1/1                 uni_match_saved        &lt;= 1'b0;
2868       1/1                 ext_match1_saved       &lt;= 1'b0;
2869       1/1                 ext_match2_saved       &lt;= 1'b0;
2870       1/1                 ext_match3_saved       &lt;= 1'b0;
2871       1/1                 ext_match4_saved       &lt;= 1'b0;
2872       1/1                 type_match1_saved      &lt;= 1'b0;
2873       1/1                 type_match2_saved      &lt;= 1'b0;
2874       1/1                 type_match3_saved      &lt;= 1'b0;
2875       1/1                 type_match4_saved      &lt;= 1'b0;
2876       1/1                 frame_matched_saved    &lt;= 1'b0;
2877                         end
2878       1/1             else if (pipeline_finished | ~enable_receive_rck)
2879                         begin
2880       1/1                 scr_drop_frame_saved   &lt;= 1'b0;
2881       1/1                 slot_time_saved        &lt;= 1'b0;
2882       1/1                 code_error_saved       &lt;= 1'b0;
2883       1/1                 vlan_tagged_saved      &lt;= 1'b0;
2884       1/1                 length_field_saved     &lt;= 16'hffff;
2885       1/1                 pause_frame_saved      &lt;= 1'b0;
2886       1/1                 pause_time_saved       &lt;= 16'h0000;
2887       1/1                 pfc_pause_frame_saved  &lt;= 1'b0;
2888       1/1                 snap_frame_saved       &lt;= 1'b0;
2889       1/1                 ip_v4_frame_saved      &lt;= 1'b0;
2890       1/1                 arp_req_frame_saved    &lt;= 1'b0;
2891       1/1                 tcp_frame_saved        &lt;= 1'b0;
2892       1/1                 udp_frame_saved        &lt;= 1'b0;
2893       1/1                 ip_ck_err_saved        &lt;= 1'b0;
2894       1/1                 tcp_udp_ck_err_saved   &lt;= 1'b0;
2895       1/1                 drop_pause_frame_saved &lt;= 1'b0;
2896       1/1                 broad_frame_saved      &lt;= 1'b0;
2897       1/1                 multi_frame_saved      &lt;= 1'b0;
2898       1/1                 multi_match_saved      &lt;= 1'b0;
2899       1/1                 uni_match_saved        &lt;= 1'b0;
2900       1/1                 ext_match1_saved       &lt;= 1'b0;
2901       1/1                 ext_match2_saved       &lt;= 1'b0;
2902       1/1                 ext_match3_saved       &lt;= 1'b0;
2903       1/1                 ext_match4_saved       &lt;= 1'b0;
2904       1/1                 type_match1_saved      &lt;= 1'b0;
2905       1/1                 type_match2_saved      &lt;= 1'b0;
2906       1/1                 type_match3_saved      &lt;= 1'b0;
2907       1/1                 type_match4_saved      &lt;= 1'b0;
2908       1/1                 frame_matched_saved    &lt;= 1'b0;
2909                         end
2910       1/1             else if (end_of_frame &amp; ~decoding_finished)
2911                         begin
2912       1/1                 scr_drop_frame_saved   &lt;= scr_drop_frame;
2913       1/1                 slot_time_saved        &lt;= slot_time_done;
2914       1/1                 code_error_saved       &lt;= code_error | valid_code_err;
2915       1/1                 vlan_tagged_saved      &lt;= vlan_tagged;
2916       1/1                 length_field_saved     &lt;= length_field;
2917       1/1                 pause_frame_saved      &lt;= pause_frame;
2918       1/1                 pause_time_saved       &lt;= pause_time;
2919       1/1                 pfc_pause_frame_saved  &lt;= pfc_pause_frame;
2920       1/1                 snap_frame_saved       &lt;= snap_frame;
2921       1/1                 ip_v4_frame_saved      &lt;= ip_v4_frame;
2922       1/1                 arp_req_frame_saved    &lt;= arp_req_frame;
2923       1/1                 tcp_frame_saved        &lt;= tcp_frame;
2924       1/1                 udp_frame_saved        &lt;= udp_frame;
2925       1/1                 ip_ck_err_saved        &lt;= ip_ck_err;
2926       1/1                 tcp_udp_ck_err_saved   &lt;= tcp_udp_ck_err;
2927       1/1                 drop_pause_frame_saved &lt;= drop_pause_frame;
2928       1/1                 broad_frame_saved      &lt;= fil_broadcast_frame;
2929       1/1                 multi_frame_saved      &lt;= fil_multicast_frame;
2930       1/1                 multi_match_saved      &lt;= fil_mult_hash_match;
2931       1/1                 uni_match_saved        &lt;= fil_uni_hash_match;
2932       1/1                 ext_match1_saved       &lt;= fil_ext_match1;
2933       1/1                 ext_match2_saved       &lt;= fil_ext_match2;
2934       1/1                 ext_match3_saved       &lt;= fil_ext_match3;
2935       1/1                 ext_match4_saved       &lt;= fil_ext_match4;
2936       1/1                 type_match1_saved      &lt;= fil_type_match1;
2937       1/1                 type_match2_saved      &lt;= fil_type_match2;
2938       1/1                 type_match3_saved      &lt;= fil_type_match3;
2939       1/1                 type_match4_saved      &lt;= fil_type_match4;
2940       1/1                 frame_matched_saved    &lt;= frame_matched | rx_store_frame;
2941                         end
                        MISSING_ELSE
2942                      end
2943                    
2944                      // Determine when odd number of nibbles is present in current frame.
2945                      // Used for deciding if aligment error or CRC error
2946                      always@(posedge rx_clk or negedge n_rxreset)
2947                      begin
2948       1/1              if (~n_rxreset)
2949       1/1                nibble_cnt_odd_saved &lt;= 1'b0;
2950       1/1              else if (pipeline_finished | ~enable_receive_rck)
2951       1/1                nibble_cnt_odd_saved &lt;= 1'b0;
2952       1/1              else if (end_of_data)
2953       1/1                nibble_cnt_odd_saved &lt;= nibble_pntr[0];
2954                        else
2955       1/1                nibble_cnt_odd_saved &lt;= nibble_cnt_odd_saved;
2956                      end
2957                    
2958                    // -----------------------------------------------------------------------------
2959                    // Match filtering logic at end of pipeline
2960                    // -----------------------------------------------------------------------------
2961                    
2962                      // If new data appears at pipeline output before matched then
2963                      // discard rest of frame
2964                      // Set when new_pipeline_data for a new frame and not already matched or
2965                      // overflow is already set
2966                      always@(posedge rx_clk or negedge n_rxreset)
2967                      begin
2968       1/1              if (~n_rxreset)
2969       1/1                match_too_late_pipe &lt;= 1'b0;
2970       1/1              else if (~enable_receive_rck | pipeline_finished | ~frame_in_pipeline)
2971       1/1                match_too_late_pipe &lt;= 1'b0;
2972       1/1              else if (new_pipeline_data_comb &amp; rx_w_sop_next &amp;
2973                                 ~(rx_store_frame | frame_matched | frame_matched_saved))
2974       <font color = "red">0/1     ==>        match_too_late_pipe &lt;= 1'b1;</font>
2975       1/1              else if (new_pipeline_data_comb &amp; rx_w_sop_next &amp; rx_w_overflow)
2976       <font color = "red">0/1     ==>        match_too_late_pipe &lt;= 1'b1;</font>
2977                        else
2978       1/1                match_too_late_pipe &lt;= match_too_late_pipe;
2979                      end
2980                    
2981                      // Hold frame_matched for pipeline stage.
2982                      // Needs to be held at the point the first data in a frame is appearing
2983                      // at the output of the pipeline, and is held until the pipeline
2984                      // is finished.
2985                      // Do not allow frame to match if FIFO is still in an overflow state.
2986                      always@(posedge rx_clk or negedge n_rxreset)
2987                      begin
2988       1/1              if (~n_rxreset)
2989       1/1                frame_match_pipe_det &lt;= 1'b0;
2990       1/1              else if (~enable_receive_rck | ~frame_in_pipeline | pipeline_finished)
2991       1/1                frame_match_pipe_det &lt;= 1'b0;
2992       1/1              else if (new_pipeline_data_comb &amp; rx_w_sop_next &amp; ~rx_w_overflow)
2993       1/1                frame_match_pipe_det &lt;= frame_matched | rx_store_frame |
2994                                                   frame_matched_saved;
2995                        else
2996       1/1                frame_match_pipe_det &lt;= frame_match_pipe_det;
2997                      end
2998                    
2999                      // Only allow data to be written if matched in time (by the time the
3000                      // first data in a frame comes out of the pipeline).
3001                      // Do not allow frame to match if FIFO is still in an overflow state.
3002                      assign frame_matched_pipe = ~match_too_late_pipe &amp;
3003                                                  (frame_match_pipe_det |
3004                                                   (new_pipeline_data_comb &amp; rx_w_sop_next &amp;
3005                                                    ~rx_w_overflow &amp; (frame_matched |
3006                                                                      rx_store_frame |
3007                                                                      frame_matched_saved)));
3008                    
3009                    
3010                    
3011                    // -----------------------------------------------------------------------------
3012                    // Pipeline Delay to allow time for Address and type matching
3013                    // Detect state of pipeline.
3014                    // -----------------------------------------------------------------------------
3015                    
3016                      // Detect when frame is being pushed through the pipeline
3017                      // Set when new aligned data is pushed into the pipeline.
3018                      // Reset when the pipeline has completed a frame, provided a new frame
3019                      // is not coming in.
3020                      // Flush second frame from pipeline when previously attempted to put
3021                      // 2 ends into pipeline (overflow due to short runt frame).
3022                      always@(posedge rx_clk or negedge n_rxreset)
3023                      begin
3024       1/1              if (~n_rxreset)
3025       1/1                frame_in_pipeline &lt;= 1'b0;
3026       1/1              else if (~enable_receive_rck)
3027       1/1                frame_in_pipeline &lt;= 1'b0;
3028       1/1              else if (pipeline_finished &amp; two_ends_in_pipe)
3029       <font color = "red">0/1     ==>        frame_in_pipeline &lt;= 1'b0;</font>
3030       1/1              else if (pipeline_finished &amp; end_of_frame &amp; decoding_finished)
3031       <font color = "red">0/1     ==>        frame_in_pipeline &lt;= 1'b0;</font>
3032       1/1              else if (new_aligned_data)
3033       1/1                frame_in_pipeline &lt;= 1'b1;
3034       1/1              else if (pipeline_finished &amp; ~frame_being_decoded)
3035       1/1                frame_in_pipeline &lt;= 1'b0;
3036                        else
3037       1/1                frame_in_pipeline &lt;= frame_in_pipeline;
3038                      end
3039                    
3040                      // Detect when the last aligned data is put into the pipeline
3041                      // and hold until it pops out the end. This is used for advancing the
3042                      // pipeline, without new aligned data being available.
3043                      // Also detect and hold when the last is popped out of the pipeline
3044                      // until the pipeline has finished.
3045                      always@(posedge rx_clk or negedge n_rxreset)
3046                      begin
3047       1/1              if (~n_rxreset)
3048                          begin
3049       1/1                  last_in_pipeline     &lt;= 1'b0;
3050       1/1                  last_out_of_pipeline &lt;= 1'b0;
3051                          end
3052       1/1              else if (pipeline_finished | ~enable_receive_rck)
3053                          begin
3054       1/1                  last_in_pipeline     &lt;= 1'b0;
3055       1/1                  last_out_of_pipeline &lt;= 1'b0;
3056                          end
3057       1/1              else if (last_align_data_tag &amp; new_aligned_data)
3058                          begin
3059       1/1                  last_in_pipeline     &lt;= 1'b1;
3060       1/1                  last_out_of_pipeline &lt;= 1'b0;
3061                          end
3062       1/1              else if (pipeline_output[18] &amp; last_in_pipeline)
3063                          begin
3064       1/1                  last_in_pipeline     &lt;= 1'b0;
3065       1/1                  last_out_of_pipeline &lt;= 1'b1;
3066                          end
3067                        else
3068                          begin
3069       1/1                  last_in_pipeline     &lt;= last_in_pipeline;
3070       1/1                  last_out_of_pipeline &lt;= last_out_of_pipeline;
3071                          end
3072                      end
3073                    
3074                      // advance pipeline on when no more new valid data coming in
3075                      // In PBUF mode, forcing is done to ensure we apply the
3076                      // residual data in the pipeline to the DMA in a consistent
3077                      // manner as when there is valid data coming in
3078                      // In non-pbuf mode, the residual data is actually passed
3079                      // to the DMA at half the rate when compared to when valid
3080                      // the pipeline is full and getting topped up
3081                      always@(posedge rx_clk or negedge n_rxreset)
3082                      begin
3083       1/1              if (~n_rxreset)
3084       1/1                force_push_pipeline &lt;= 1'b0;
3085       1/1              else if (pipeline_finished | ~enable_receive_rck |
3086                                 ~frame_in_pipeline | last_out_of_pipeline)
3087       1/1                force_push_pipeline &lt;= 1'b0;
3088       1/1              else if (last_in_pipeline)
3089       1/1                force_push_pipeline &lt;= ~force_push_pipeline |
3090                                                  (data_in_16bits &amp;&amp; p_edma_rx_pkt_buffer == 1);
3091                        else
3092       1/1                force_push_pipeline &lt;= force_push_pipeline;
3093                      end
3094                    
3095                      // detect when pipeline has finished for current frame
3096                      // since last_pipeline_data always waits for decoding_finished, this will
3097                      // always happend after the decoding has completed.
3098                      always@(posedge rx_clk or negedge n_rxreset)
3099                      begin
3100       1/1              if (~n_rxreset)
3101       1/1                pipeline_finished  &lt;= 1'b0;
3102       1/1              else if (~enable_receive_rck)
3103       1/1                pipeline_finished &lt;= 1'b0;
3104       1/1              else if (last_pipeline_data)
3105       1/1                pipeline_finished &lt;= 1'b1;
3106                        else
3107       1/1                pipeline_finished &lt;= 1'b0;
3108                      end
3109                    
3110                    // -----------------------------------------------------------------------------
3111                    // Pipeline for received data
3112                    // -----------------------------------------------------------------------------
3113                    
3114                      // Pipeline consists of the last aligned data, number of valid bytes
3115                      // and the 16-bit data from the decoding stage.
3116                      // Only assign a value to the pipeline input when it is new data being
3117                      // pushed in so that pipeline is flushed with zeros otherwise.
3118                      always @(*)
3119       1/1              if (new_aligned_data)
3120       1/1                pipeline_input = {new_data_align[25:24],frer_rtag_mark_early,
3121                                            last_align_data_tag,
3122                                            no_aligned_data[1:0],
3123                                            new_data_align[15:0]};
3124                        else
3125       1/1                pipeline_input = {2'b00,20'd0};
3126                    
3127                    
3128                      // Determine when to advance the pipeline.
3129                      // Either when some new data is pushed in or if the last is in the
3130                      // pipeline.
3131                      assign push_pipeline = new_aligned_data | force_push_pipeline;
3132                    
3133                      // Data delay pipeline.
3134                      // Configurable depth pipeline, p_gem_rx_pipeline_delay deep by 19 bits
3135                      // Flush second frame from pipeline when previously attempted to put
3136                      // 2 ends into pipeline (overflow due to short runt frame).
3137                      always@(posedge rx_clk or negedge n_rxreset)
3138                      begin
3139       1/1               if (~n_rxreset)
3140                           begin
3141       1/1                   for (i = 0; i &lt; p_gem_rx_pipeline_delay[31:0]; i = i + 1)
3142       1/1                     pipeline_delay[i] &lt;= {2'b00,20'd0};  // parity and orginal signal
3143                           end
3144       1/1               else if (~enable_receive_rck)
3145                           begin
3146                             // synchronous reset, flush pipeline
3147       1/1                   for (i = 0; i &lt; p_gem_rx_pipeline_delay[31:0]; i = i + 1)
3148       1/1                     pipeline_delay[i] &lt;= {2'b00,20'd0};  // parity and orginal signal
3149                           end
3150       1/1               else if (pipeline_finished &amp; (overflow_saved |
3151                                                       two_ends_in_pipe |
3152                                                       (end_of_frame &amp; decoding_finished)))
3153                           begin
3154                             // rx overflow, flush pipeline at pipeline finished
3155       <font color = "red">0/1     ==>           for (i = 0; i &lt; p_gem_rx_pipeline_delay[31:0]; i = i + 1)</font>
3156       <font color = "red">0/1     ==>             pipeline_delay[i] &lt;= {2'b00,20'd0};  // parity and orginal signal</font>
3157                           end
3158       1/1               else if (push_pipeline)
3159                           begin
3160                              // if new aligned data is available then shift pipeline on.
3161                              // Or if the last aligned data has been written into the
3162                              // pipeline carry on shifting until it comes out.
3163       1/1                    pipeline_delay[0] &lt;= pipeline_input;
3164       1/1                    for (i = 1; i &lt; p_gem_rx_pipeline_delay[31:0]; i = i + 1)
3165       1/1                      pipeline_delay[i] &lt;= pipeline_delay[i - 1];
3166                           end
3167                         else
3168                           begin
3169                              // Maintain value
3170       1/1                   for (i = 0; i &lt; p_gem_rx_pipeline_delay[31:0]; i = i + 1)
3171       1/1                      pipeline_delay[i] &lt;= pipeline_delay[i];
3172                           end
3173                      end
3174                    
3175                      // assign last three locations of pipeline_delay[n] to signals so can
3176                      // reference individual bits.
3177                      // As well as defining the output of the pipeline, this is also used
3178                      // for stripping FCS.
3179                      assign pipeline_output     = pipeline_delay[p_gem_rx_pipeline_delay - 1];
3180                      assign pipeline_delay_fcs2 = pipeline_delay[p_gem_rx_pipeline_delay - 2];
3181                      assign pipeline_delay_fcs1 = pipeline_delay[p_gem_rx_pipeline_delay - 3];
3182                    
3183                      // Determine when data is not valid for 32/64/128 bit buffer if striping FCS.
3184                      assign no_more_128_data = strip_rx_fcs &amp; (pipeline_delay_fcs2[18] |
3185                                                                pipeline_output[18]);
3186                    
3187                      // Determine when to block fifo writes if striping FCS
3188                      assign stop_fifo_wr_fcs = strip_rx_fcs &amp; (pipeline_delay_fcs1[18] |
3189                                                                pipeline_delay_fcs2[18] |
3190                                                                pipeline_output[18]);
3191                    
3192                      // Decode number of bytes in pipeline output
3193                      assign no_pipeline_data = pipeline_output[17:16];
3194                    
3195                      // Decode when new valid pipeline data is available
3196                      assign new_pipeline_data = push_pipeline &amp; frame_in_pipeline &amp;
3197                                                 (no_pipeline_data != 2'b00);
3198                    
3199                      // Combine with optional removal of CB RTag
3200                      assign new_pipeline_data_comb  = new_pipeline_data &amp; ~(pipeline_output[19] &amp; frer_strip_rtag);
3201                    
3202                      // Detect last data coming out of pipeline
3203                      // This is used to read the result of the CRC, so it must be one clock
3204                      // after the last data appears from pipeline to allow CRC including
3205                      // last data to be calculated.
3206                      always@(posedge rx_clk or negedge n_rxreset)
3207                      begin
3208       1/1              if (~n_rxreset)
3209       1/1                last_pipeline_data &lt;= 1'b0;
3210                    
3211                        // if frame in pipeline has finshed zero last_pipeline_data
3212       1/1              else if (~frame_in_pipeline | pipeline_finished | ~enable_receive_rck)
3213       1/1                last_pipeline_data &lt;= 1'b0;
3214                    
3215                        // if the last data is now out of the pipeline and we have finished
3216                        // decoding the frame then start of last_pipeline_data sequence.
3217                        // This will be pulsed for one cycle only.
3218       1/1              else if (decoding_finished &amp; last_out_of_pipeline &amp; ~last_pipeline_data)
3219       1/1                last_pipeline_data &lt;= 1'b1;
3220                        else
3221       1/1                last_pipeline_data &lt;= 1'b0;
3222                      end
3223                    
3224                      // The amount of data on the final push out of the pipeline depends
3225                      // on whether FCS is being stripped out. If it is need to look forward
3226                      // to where the last byte of CRC data currently is (pipeline_delay_fcs1)
3227                      always @(*)
3228       1/1              if (strip_rx_fcs &amp; pipeline_delay_fcs1[18])
3229       <font color = "red">0/1     ==>        no_pipe_data_fcs = pipeline_delay_fcs1[17:16];</font>
3230                        else
3231       1/1                no_pipe_data_fcs = no_pipeline_data[1:0];
3232                    
3233                      // Store how many bytes come out of the last pipeline data. This will be
3234                      // used to determine how full the last 16-bit slot is at the EOP.
3235                      // Note that the last pipeline data will be indicated early if striping FCS.
3236                      always@(posedge rx_clk or negedge n_rxreset)
3237                      begin
3238       1/1              if (~n_rxreset)
3239       1/1                last_no_pipe_save &lt;= 2'b00;
3240       1/1              else if (~enable_receive_rck)
3241       1/1                last_no_pipe_save &lt;= 2'b00;
3242       1/1              else if ((pipeline_delay_fcs1[18] &amp; strip_rx_fcs) |
3243                                 (pipeline_output[18] &amp; ~strip_rx_fcs))
3244       1/1                last_no_pipe_save[1:0] &lt;= no_pipe_data_fcs[1:0];
3245                        else
3246       1/1                last_no_pipe_save[1:0] &lt;= last_no_pipe_save[1:0];
3247                      end
3248                    
3249                    // -----------------------------------------------------------------------------
3250                    // Form 32/64/128 bit data to transfer to DMA FIFO
3251                    // -----------------------------------------------------------------------------
3252                    
3253                      // Decode DMA data bus width
3254                      assign dma_32bit_mode  = (dma_bus_width == 2'b00);
3255                      assign dma_64bit_mode  = (dma_bus_width == 2'b01);
3256                    
3257                      // word_pntr_128 is a pointer to the next 16 bit word to be filled
3258                      // in 32/64/128 bit store from the aligned data.
3259                      // This is reset as the last data in a frame is written.
3260                      // Keep a track of the previous count for use at the end of frame in
3261                      // calculating the MOD signal on the FIFO interface
3262                      always@(posedge rx_clk or negedge n_rxreset)
3263                      begin
3264       1/1              if (~n_rxreset)
3265                          begin
3266       1/1                  word_pntr_128      &lt;= 3'b000;
3267       1/1                  prev_word_pntr_128 &lt;= 3'b000;
3268                          end
3269                    
3270                        // reset word pointer as last data in frame is written to the DMA FIFO
3271                        // or if receive is disabled.
3272       1/1              else if (pipeline_finished | ~enable_receive_rck | ~frame_in_pipeline)
3273                          begin
3274       1/1                  word_pntr_128      &lt;= 3'b000;
3275       1/1                  prev_word_pntr_128 &lt;= 3'b000;
3276                          end
3277                    
3278                        // If about to be filled then reset
3279       1/1              else if (new_pipeline_data_comb &amp; next_128_full &amp; ~no_more_128_data)
3280                          begin
3281       1/1                  word_pntr_128      &lt;= 3'b000;
3282       1/1                  prev_word_pntr_128 &lt;= word_pntr_128;
3283                          end
3284                    
3285                        // Word pointer is updated when new aligned data is available.
3286       1/1              else if (new_pipeline_data_comb &amp; ~no_more_128_data)
3287                          begin
3288       1/1                  word_pntr_128      &lt;= next_word_pntr_128[2:0];
3289       1/1                  prev_word_pntr_128 &lt;= word_pntr_128;
3290                          end
3291                    
3292                        // Else maintain value
3293                        else
3294                          begin
3295       1/1                  word_pntr_128      &lt;= word_pntr_128;
3296       1/1                  prev_word_pntr_128 &lt;= prev_word_pntr_128;
3297                          end
3298                      end
3299                    
3300                      // work out next value of word_pntr_128 (always increments by 1)
3301                      assign next_word_pntr_128[3:0] = {1'b0,word_pntr_128[2:0]} + 4'b0001;
3302                    
3303                      // Work out if buffer will be filled next clock.
3304                      // This depends on the DMA bus width selected.
3305                      assign next_128_full = (dma_32bit_mode)? next_word_pntr_128[1] :
3306                                             (dma_64bit_mode)? next_word_pntr_128[2] :
3307                                                               next_word_pntr_128[3];
3308                    
3309                      // At end of frame, sample udptcp_offset into udptcp_offset_str
3310                      // This will let the udptcp_offset counter inside gem_rx_decode
3311                      // free to begin counting on the next inbound frame, and
3312                      // we keep hold of the actual count value while the data is
3313                      // passing through the pipeline
3314                      always@(posedge rx_clk or negedge n_rxreset)
3315                      begin
3316       1/1              if (~n_rxreset)
3317                        begin
3318       1/1                udptcp_offset_str &lt;= 11'h000;
3319       1/1                pld_offset_str &lt;= 12'h000;
3320                        end
3321       1/1              else if (end_of_frame)
3322                        begin
3323       1/1               pld_offset_str &lt;= pld_offset[11:0];
3324       1/1               if (~tcp_frame &amp; ~udp_frame)
3325       1/1                 udptcp_offset_str &lt;= 11'h000;
3326                         else
3327       1/1                 udptcp_offset_str &lt;= udptcp_offset;
3328                        end
                        MISSING_ELSE
3329                      end
3330                    
3331                      // If store_rx_ts is set then replace the CRC with the rx TSU timestamp
3332                      // or the IP and TCP/UDP offset (in bytes) when the CRC emerges from the
3333                      // receive pipeline
3334                      always @(*)
3335                      begin
3336       1/1              if (store_rx_ts &amp; p_edma_tsu == 1)
3337                        begin
3338       <font color = "red">0/1     ==>        if (pipeline_delay_fcs1[18] &amp; ~pipeline_delay_fcs1[17])</font>
3339       <font color = "red">0/1     ==>          data_store_16 = {rx_w_timestamp_prty[0],pipeline_output[20],rx_w_timestamp[7:0],pipeline_output[7:0]};</font>
3340       <font color = "red">0/1     ==>        else if (pipeline_delay_fcs2[18] &amp; ~pipeline_delay_fcs2[17])</font>
3341       <font color = "red">0/1     ==>          data_store_16 = {rx_w_timestamp_prty[2],rx_w_timestamp_prty[1],rx_w_timestamp[23:8]};</font>
3342       <font color = "red">0/1     ==>        else if (pipeline_delay_fcs2[18])</font>
3343       <font color = "red">0/1     ==>          data_store_16 = {rx_w_timestamp_prty[1],rx_w_timestamp_prty[0],rx_w_timestamp[15:0]};</font>
3344       <font color = "red">0/1     ==>        else if (pipeline_output[18] &amp; ~pipeline_output[17])</font>
3345       <font color = "red">0/1     ==>          data_store_16 = {1'b0,rx_w_timestamp_prty[3],8'd0,rx_w_timestamp[31:24]};</font>
3346       <font color = "red">0/1     ==>        else if (pipeline_output[18])</font>
3347       <font color = "red">0/1     ==>          data_store_16 = {rx_w_timestamp_prty[3],rx_w_timestamp_prty[2],rx_w_timestamp[31:16]};</font>
3348                          else
3349       <font color = "red">0/1     ==>          data_store_16 = {pipeline_output[21:20],pipeline_output[15:0]};</font>
3350                        end
3351                    
3352       1/1              else if (store_udp_offset)
3353                        begin
3354       <font color = "red">0/1     ==>        if (pipeline_delay_fcs1[18] &amp; ~pipeline_delay_fcs1[17])</font>
3355       <font color = "red">0/1     ==>          data_store_16 = {udptcp_offset_str_par[0],pipeline_output[20],udptcp_offset_str[7:0],pipeline_output[7:0]};</font>
3356       <font color = "red">0/1     ==>        else if (pipeline_delay_fcs2[18] &amp; ~pipeline_delay_fcs2[17])</font>
3357       <font color = "red">0/1     ==>          data_store_16 = {1'b0,udptcp_offset_str_par[1],13'h0000,udptcp_offset_str[10:8]};</font>
3358       <font color = "red">0/1     ==>        else if (pipeline_delay_fcs2[18])</font>
3359       <font color = "red">0/1     ==>          data_store_16 = {udptcp_offset_str_par[1:0],5'h00,udptcp_offset_str[10:0]};</font>
3360       <font color = "red">0/1     ==>        else if (pipeline_output[18])</font>
3361       <font color = "red">0/1     ==>          data_store_16 = {2'b00,16'h0000};</font>
3362                          else
3363       <font color = "red">0/1     ==>          data_store_16 = {pipeline_output[21:20],pipeline_output[15:0]};</font>
3364                        end
3365                    
3366                        else
3367       1/1                data_store_16 = {pipeline_output[21:20],pipeline_output[15:0]};
3368                      end
3369                    
3370                      // Store aligned data in 128 bit store ready to transfer to DMA.
3371                      // Always put the beginning of the new aligned data (1 or 2 bytes) into
3372                      // the location pointed to by word_pntr_128.
3373                      // Do not push data in if striping FCS and the last bit is set in any
3374                      // of the last three locations in the pipeline.
3375                      always@(posedge rx_clk or negedge n_rxreset)
3376                      begin
3377       1/1               if (~n_rxreset) begin
3378       1/1                  data_store_128[127:0]   &lt;= 128'd0;
3379       1/1                  data_store_128_par[15:0]&lt;= 16'd0;
3380       1/1               end else if (new_pipeline_data_comb &amp; ~no_more_128_data)
3381       1/1                  casex ({no_pipe_data_fcs, word_pntr_128})
3382                    
3383                               // one new valid byte from pipeline data
3384                               // This is only possible in the last push.
3385                               5'b01_000  : begin // clear upper bits to avoid confusion
3386       1/1                                     data_store_128[7:0]     &lt;= data_store_16[7:0];
3387       1/1                                     data_store_128[127:8]   &lt;= 120'd0;
3388       1/1                                     data_store_128_par      &lt;= {15'd0,data_store_16[16]};
3389                                            end
3390       2/2                     5'b01_001  : begin data_store_128[23:16]   &lt;= data_store_16[7:0]; data_store_128_par[2]   &lt;= data_store_16[16]; end
3391       <font color = "red">0/2     ==>             5'b01_010  : begin data_store_128[39:32]   &lt;= data_store_16[7:0]; data_store_128_par[4]   &lt;= data_store_16[16]; end</font>
3392       <font color = "red">0/2     ==>             5'b01_011  : begin data_store_128[55:48]   &lt;= data_store_16[7:0]; data_store_128_par[6]   &lt;= data_store_16[16]; end</font>
3393       <font color = "red">0/2     ==>             5'b01_100  : begin data_store_128[71:64]   &lt;= data_store_16[7:0]; data_store_128_par[8]   &lt;= data_store_16[16]; end</font>
3394       <font color = "red">0/2     ==>             5'b01_101  : begin data_store_128[87:80]   &lt;= data_store_16[7:0]; data_store_128_par[10]  &lt;= data_store_16[16]; end</font>
3395       <font color = "red">0/2     ==>             5'b01_110  : begin data_store_128[103:96]  &lt;= data_store_16[7:0]; data_store_128_par[12]  &lt;= data_store_16[16]; end</font>
3396       <font color = "red">0/2     ==>             5'b01_111  : begin data_store_128[119:112] &lt;= data_store_16[7:0]; data_store_128_par[14]  &lt;= data_store_16[16]; end</font>
3397                    
3398                               // two new valid bytes from pipeline data
3399                               5'b1x_000  : begin // clear upper bits to avoid confusion
3400       1/1                                     data_store_128[15:0]    &lt;= data_store_16[15:0];
3401       1/1                                     data_store_128[127:16]  &lt;= 112'd0;
3402       1/1                                     data_store_128_par      &lt;= {14'd0,data_store_16[17:16]};
3403                                            end
3404       2/2                     5'b1x_001  : begin data_store_128[31:16]   &lt;= data_store_16[15:0]; data_store_128_par[3:2]    &lt;= data_store_16[17:16]; end
3405       <font color = "red">0/2     ==>             5'b1x_010  : begin data_store_128[47:32]   &lt;= data_store_16[15:0]; data_store_128_par[5:4]    &lt;= data_store_16[17:16]; end</font>
3406       <font color = "red">0/2     ==>             5'b1x_011  : begin data_store_128[63:48]   &lt;= data_store_16[15:0]; data_store_128_par[7:6]    &lt;= data_store_16[17:16]; end</font>
3407       <font color = "red">0/2     ==>             5'b1x_100  : begin data_store_128[79:64]   &lt;= data_store_16[15:0]; data_store_128_par[9:8]    &lt;= data_store_16[17:16]; end</font>
3408       <font color = "red">0/2     ==>             5'b1x_101  : begin data_store_128[95:80]   &lt;= data_store_16[15:0]; data_store_128_par[11:10]  &lt;= data_store_16[17:16]; end</font>
3409       <font color = "red">0/2     ==>             5'b1x_110  : begin data_store_128[111:96]  &lt;= data_store_16[15:0]; data_store_128_par[13:12]  &lt;= data_store_16[17:16]; end</font>
3410                               default    : begin //5'b1x_111  :
3411       <font color = "red">0/1     ==>                            data_store_128[127:112]    &lt;= data_store_16[15:0];</font>
3412       <font color = "red">0/1     ==>                            data_store_128_par[15:14]  &lt;= data_store_16[17:16];</font>
3413                                            end
3414                            endcase
3415                         else begin
3416       1/1                  data_store_128     &lt;= data_store_128;
3417       1/1                  data_store_128_par &lt;= data_store_128_par;
3418                         end
3419                      end
3420                    
3421                      // count the number of bytes left in the buffer after the last push from
3422                      // the pipeline output. This is used to generate the FIFO MOD signal.
3423                      //
3424                      // If terminating normally then this is equal to ...
3425                      //    (2 * [number of 16-bit locations previously filled])
3426                      //  + [number of bytes in final push]
3427                      //
3428                      // Else if terminating because too long then this is equal to ...
3429                      //    (2 * [number of 16-bit locations currently filled])
3430                      //  + [number of bytes in current push]
3431                      //
3432                      always @(too_long_dec or prev_word_pntr_128 or last_no_pipe_save or
3433                               no_pipe_data_fcs or word_pntr_128)
3434                         begin
3435       1/1                  if (too_long_dec)
3436       <font color = "red">0/1     ==>             no_bytes_in_wordpntr = {word_pntr_128[2:0], 1'b0} +</font>
3437                                                           {2'b00, no_pipe_data_fcs[1:0]};
3438                            else
3439       1/1                     no_bytes_in_wordpntr = {prev_word_pntr_128[2:0], 1'b0} +
3440                                                           {2'b00, last_no_pipe_save[1:0]};
3441                         end
3442                    
3443                    // -----------------------------------------------------------------------------
3444                    // FIFO interface
3445                    // -----------------------------------------------------------------------------
3446                    
3447                      // rx_w_sop_next is used to keep track of when next write will
3448                      // be the first in a frame. Set at last data write, reset when
3449                      // next write is complete (must be first in frame).
3450                      always@(posedge rx_clk or negedge n_rxreset)
3451                      begin
3452       1/1              if (~n_rxreset)
3453       1/1                rx_w_sop_next &lt;= 1'b1;
3454       1/1              else if (~enable_receive_rck)
3455       1/1                rx_w_sop_next &lt;= 1'b1;
3456       1/1              else if (rx_w_wr &amp; rx_w_eop)
3457       1/1                rx_w_sop_next &lt;= 1'b1;
3458       1/1              else if (rx_w_wr)
3459       1/1                rx_w_sop_next &lt;= 1'b0;
3460                        else
3461       1/1                rx_w_sop_next &lt;= rx_w_sop_next;
3462                      end
3463                    
3464                      // Next MOD signal generation.
3465                      // no_bytes_in_wordpntr will currently indicate how many bytes were used
3466                      // in the 128 bit buffer.
3467                      // Need to zero upper unused bits for 32 and 64 bit bus width modes.
3468                      always @(*)
3469                      begin
3470       1/1              case (dma_bus_width)
3471       1/1                 2'b00   : next_rx_w_mod[3:0] = {2'b00, no_bytes_in_wordpntr[1:0]};
3472       <font color = "red">0/1     ==>         2'b01   : next_rx_w_mod[3:0] = { 1'b0, no_bytes_in_wordpntr[2:0]};</font>
3473       <font color = "red">0/1     ==>         default : next_rx_w_mod[3:0] = {       no_bytes_in_wordpntr[3:0]};</font>
3474                        endcase
3475                      end
3476                    
3477                      assign rx_w_err_next = bad_frame | drop_pause_frame_saved | frer_discard;
3478                      // Write data into RX DMA FIFO
3479                      // Write data to DMA FIFO when more aligned data is becoming available
3480                      // and already have a push pending, or when the last data has been loaded.
3481                      // Indicate when end of packet is written into the FIFO
3482                      // Indicate when start of packet is written into the FIFO
3483                      // Work out how much data is to be transfered on last write
3484                      // Indicate when when there is an error with the current packet
3485                      // The TCI information can be output at SOP time also
3486                      // This will ensure priority fields are passed early enough
3487                      // for higher layers to work with it
3488                      always@(posedge rx_clk or negedge n_rxreset)
3489                      begin
3490       1/1              if (~n_rxreset)
3491                          begin
3492       1/1                  rx_w_wr      &lt;= 1'b0;
3493       1/1                  rx_w_sop     &lt;= 1'b0;
3494       1/1                  rx_w_eop     &lt;= 1'b0;
3495       1/1                  rx_w_mod     &lt;= 4'h0;
3496       1/1                  rx_w_err     &lt;= 1'b0;
3497       1/1                  rx_w_tci     &lt;= 4'h0;
3498       1/1                  rx_w_vlan_tagged &lt;= 1'b0;
3499       1/1                  rx_w_prty_tagged &lt;= 1'b0;
3500                          end
3501                    
3502                        // synchronous reset
3503       1/1              else if (~enable_receive_rck)
3504                          begin
3505       1/1                  rx_w_wr      &lt;= 1'b0;
3506       1/1                  rx_w_sop     &lt;= 1'b0;
3507       1/1                  rx_w_eop     &lt;= 1'b0;
3508       1/1                  rx_w_mod     &lt;= 4'h0;
3509       1/1                  rx_w_err     &lt;= 1'b0;
3510       1/1                  rx_w_tci     &lt;= 4'h0;
3511       1/1                  rx_w_vlan_tagged &lt;= 1'b0;
3512       1/1                  rx_w_prty_tagged &lt;= 1'b0;
3513                          end
3514                    
3515                        // Push data out onto the FIFO interface when the 128 bit buffer is
3516                        // full. If it is not the last data then keep EOP, ERR and MOD zero.
3517                        // Signal SOP if the last push was an EOP (signalled by rx_w_sop_next).
3518       1/1              else if (frame_in_pipeline &amp; new_pipeline_data_comb &amp; next_128_full &amp;
3519                                 ~(pipeline_output[18] | last_out_of_pipeline |
3520                                   stop_fifo_wr_fcs | too_long_dec | too_long) &amp;
3521                                 frame_matched_pipe)
3522                          begin
3523       1/1                  rx_w_wr  &lt;= 1'b1;
3524       1/1                  rx_w_eop &lt;= 1'b0;
3525       1/1                  rx_w_err &lt;= 1'b0;
3526       1/1                  rx_w_sop &lt;= rx_w_sop_next;
3527       1/1                  rx_w_mod &lt;= 4'h0;
3528       1/1                  if (rx_w_sop_next)
3529                            begin
3530       1/1                    rx_w_tci &lt;= tci;
3531       1/1                    rx_w_vlan_tagged &lt;= vlan_tagged;
3532       1/1                    rx_w_prty_tagged &lt;= priority_tagged;
3533                            end
                        MISSING_ELSE
3534                          end
3535                    
3536                        // Final push is forced if
3537                        // 1) too_long_dec is detected to prevent excessive length frames unnecessarily filling the FIFO.
3538                        // 2) Final push data out onto the FIFO interface when the 128 bit buffer is
3539                        //    full. If it is the last data then set EOP. Also set ERR if bad frame
3540                        //    is indicated. SOP may also be set if length is less than one location.
3541                        //    The MOD signal now must indicate how many bytes are valid.
3542       1/1              else if (final_eop_push)
3543                          begin
3544       1/1                  rx_w_wr  &lt;= 1'b1;
3545       1/1                  rx_w_eop &lt;= 1'b1;
3546       1/1                  rx_w_err &lt;= rx_w_err_next;
3547       1/1                  rx_w_sop &lt;= rx_w_sop_next;
3548       1/1                  rx_w_mod &lt;= next_rx_w_mod;
3549       1/1                  if (rx_w_sop_next)
3550                            begin
3551       <font color = "red">0/1     ==>            rx_w_tci &lt;= tci;</font>
3552       <font color = "red">0/1     ==>            rx_w_vlan_tagged &lt;= vlan_tagged;</font>
3553       <font color = "red">0/1     ==>            rx_w_prty_tagged &lt;= priority_tagged;</font>
3554                            end
                        MISSING_ELSE
3555                          end
3556                    
3557                        // Else reset to ensure that signals are just a pulse
3558                        else
3559                          begin
3560       1/1                  rx_w_wr  &lt;= 1'b0;
3561       1/1                  rx_w_eop &lt;= 1'b0;
3562       1/1                  rx_w_err &lt;= 1'b0;
3563       1/1                  rx_w_sop &lt;= 1'b0;
3564       1/1                  rx_w_mod &lt;= 4'h0;
3565       1/1                  rx_w_tci &lt;= rx_w_tci;
3566       1/1                  rx_w_vlan_tagged &lt;= rx_w_vlan_tagged;
3567       1/1                  rx_w_prty_tagged &lt;= rx_w_prty_tagged;
3568                          end
3569                      end
3570                    
3571                      // Final push to FIFO i/f, see above for comments, this is done as a signal
3572                      // here to avoid replication later.
3573                      assign final_eop_push  = frame_in_pipeline &amp; frame_matched_pipe &amp; ~too_long &amp;
3574                                               (too_long_dec | pipeline_finished);
3575                    
3576                      // assign FIFO write data output.
3577                      assign rx_w_data     = data_store_128[127:0];
3578                      assign rx_w_data_par = data_store_128_par[15:0];
3579                    
3580                    
3581                      // FIFO flush. Only asserted when receive is not enabled.
3582                      assign rx_w_flush = ~enable_receive_rck;
3583                    
3584                    // -----------------------------------------------------------------------------
3585                    // Detect overrun of the RX path
3586                    // -----------------------------------------------------------------------------
3587                    
3588                      // indicate internal GEM_RX overrun condition if the previous fifo
3589                      // frame has not had it's status written back and we get a new
3590                      // pipeline_finished
3591                      assign rx_pipeline_overflow =
3592                    
3593                          // Status update still in progress and new frame is valid length
3594                          (pipeline_finished &amp; update_in_progress &amp; ~too_long &amp;
3595                                                            ~(crc_error_reg &amp; too_short)) |
3596                    
3597                          // Special case for if new frame is too long
3598                          (pipeline_finished &amp; rx_end_frame &amp; too_long);
3599                    
3600                    
3601                      // Hold overflow condition if the pipeline hasn't finished
3602                      // (decoding_finished still high) and we get a new end_of_frame
3603                      // This implies there is a runt from the decoding stage and hence this
3604                      // saved condition is used to flush the runt from the pipeline.
3605                      // This logic therefore implies a limit on the depth of the pipeline.
3606                      always@(posedge rx_clk or negedge n_rxreset)
3607                      begin
3608       1/1              if (~n_rxreset)
3609       1/1                two_ends_in_pipe &lt;= 1'b0;
3610       1/1              else if (~enable_receive_rck)
3611       1/1                two_ends_in_pipe &lt;= 1'b0;
3612       1/1              else if (pipeline_finished)
3613       1/1                two_ends_in_pipe &lt;= 1'b0;
3614       1/1              else if (end_of_frame &amp; decoding_finished)
3615       <font color = "red">0/1     ==>        two_ends_in_pipe &lt;= 1'b1;</font>
                        MISSING_ELSE
3616                      end
3617                    
3618                      // detect any overrun failure that happens during the limits of the frame
3619                      // and store until status has been transferred to the handshaking block
3620                      // when pipeline_finished is high.
3621                      always@(posedge rx_clk or negedge n_rxreset)
3622                      begin
3623       1/1              if (~n_rxreset)
3624       1/1                overflow_saved &lt;= 1'b0;
3625       1/1              else if (~enable_receive_rck)
3626       1/1                overflow_saved &lt;= 1'b0;
3627       1/1              else if (pipeline_finished)
3628       1/1                overflow_saved &lt;= 1'b0;
3629       1/1              else if (frame_in_pipeline &amp; (rx_pipeline_overflow | rx_w_overflow))
3630       <font color = "red">0/1     ==>        overflow_saved &lt;= 1'b1;</font>
                        MISSING_ELSE
3631                      end
3632                    
3633                      // Detect a new overflow when current update is in progress and was not
3634                      // indicating an overflow. This is then used to start a new update to
3635                      // the register block to immediately signal an overflow.
3636                      always@(posedge rx_clk or negedge n_rxreset)
3637                      begin
3638       1/1              if (~n_rxreset)
3639       1/1                update_overflow &lt;= 1'b0;
3640       1/1              else if (~enable_receive_rck)
3641       1/1                update_overflow &lt;= 1'b0;
3642       1/1              else if (update_finished)
3643       1/1                update_overflow &lt;= 1'b0;
3644       1/1              else if (update_in_progress &amp; ~rx_overflow &amp; (rx_pipeline_overflow |
3645                                                                      rx_w_overflow))
3646       <font color = "red">0/1     ==>        update_overflow &lt;= 1'b1;</font>
                        MISSING_ELSE
3647                      end
3648                    
3649                    // -----------------------------------------------------------------------------
3650                    // Count number of bytes in frame coming from the pipeline
3651                    // -----------------------------------------------------------------------------
3652                    
3653                      // count frame length in bytes
3654                      always@(posedge rx_clk or negedge n_rxreset)
3655                      begin
3656       1/1              if (~n_rxreset)
3657       1/1                frm_byte_cnt &lt;= 14'd0;
3658       1/1              else if (pipeline_finished | ~enable_receive_rck | ~frame_in_pipeline)
3659       1/1                frm_byte_cnt &lt;= 14'd0;
3660       1/1              else if (new_pipeline_data_comb &amp; ~too_long)
3661       1/1                frm_byte_cnt &lt;= next_frm_byte_cnt[13:0];
                        MISSING_ELSE
3662                      end
3663                    
3664                      // detect how many valid bytes are in next aligned data
3665                      assign frm_byte_cnt_inc[1:0] = no_pipeline_data[1:0];
3666                    
3667                      // add increment onto frame count in terms of number of complete bytes
3668                      assign next_frm_byte_cnt = frm_byte_cnt + {12'd0, frm_byte_cnt_inc[1:0]};
3669                    
3670                    // -----------------------------------------------------------------------------
3671                    // Minimum Frame Size Check
3672                    // -----------------------------------------------------------------------------
3673                    // Determine whether frame is less than MinFrameSize (less than 64 bytes of
3674                    // valid data excluding preamble, SFD and carrier extension).
3675                    // Starts with the presumption that it is under sized and clears
3676                    // once required count is reached.
3677                      always@(posedge rx_clk or negedge n_rxreset)
3678                      begin
3679       1/1              if (~n_rxreset)
3680       1/1                not_min_frame_size &lt;= 1'b1;
3681                    
3682                        // if finished or not enabled then preset
3683       1/1              else if (pipeline_finished | ~enable_receive_rck | ~frame_in_pipeline)
3684       1/1                not_min_frame_size &lt;= 1'b1;
3685                    
3686                        // else if the min size is decoded reset not_min_frame_size
3687       1/1              else if ((next_frm_byte_cnt[13:0] == 14'h0040) &amp; new_pipeline_data_comb)
3688       1/1                not_min_frame_size &lt;= 1'b0;
                        MISSING_ELSE
3689                    
3690                      end
3691                    
3692                    // -----------------------------------------------------------------------------
3693                    // Frame too short
3694                    // -----------------------------------------------------------------------------
3695                    // Used to discard frame if minFrameSize is not met or slot time including
3696                    // carrier extension is not met in half duplex mode
3697                    // Also used to report too short statistics
3698                      assign too_short = not_min_frame_size | ~slot_time_saved;
3699                    
3700                    // -----------------------------------------------------------------------------
3701                    // Check for overlength frames
3702                    // -----------------------------------------------------------------------------
3703                    
3704                      // Determine whether frame is oversized
3705                      // If jumbo enable is set then up to 10240 bytes are allowed.
3706                      // Else if rx_1536_en is set, frames up to 1536 bytes are allowed,
3707                      // otherwise only 1518 bytes are allowed.
3708                      always @(jumbo_enable or new_pipeline_data_comb or frm_byte_cnt or rx_1536_en or jumbo_max_length)
3709                      begin
3710       1/1              if (jumbo_enable &amp; new_pipeline_data_comb &amp;
3711                              (frm_byte_cnt == jumbo_max_length))
3712       <font color = "red">0/1     ==>        too_long_dec = 1'b1;</font>
3713       1/1              else if (~jumbo_enable &amp; rx_1536_en &amp; new_pipeline_data_comb &amp;
3714                                 (frm_byte_cnt == 14'h0600))
3715       <font color = "red">0/1     ==>        too_long_dec = 1'b1;</font>
3716       1/1              else if (~jumbo_enable &amp; ~rx_1536_en &amp; new_pipeline_data_comb &amp;
3717                                 (frm_byte_cnt == 14'h05ee))
3718       <font color = "red">0/1     ==>        too_long_dec = 1'b1;</font>
3719                        else
3720       1/1                too_long_dec = 1'b0;
3721                      end
3722                    
3723                      // When too_long_dec is signalled hold until pipeline has finished
3724                      // processing all of frame. This will be used to stop any further pushes
3725                      // on the FIFO interface and then used for statistic reporting.
3726                      always@(posedge rx_clk or negedge n_rxreset)
3727                      begin
3728       1/1              if (~n_rxreset)
3729       1/1                too_long &lt;= 1'b0;
3730       1/1              else if (pipeline_finished | ~enable_receive_rck | ~frame_in_pipeline)
3731       1/1                too_long &lt;= 1'b0;
3732       1/1              else if (too_long_dec)
3733       <font color = "red">0/1     ==>        too_long &lt;= 1'b1;</font>
                        MISSING_ELSE
3734                      end
3735                    
3736                    // -----------------------------------------------------------------------------
3737                    // Check for measured frame lengths less than length field
3738                    // -----------------------------------------------------------------------------
3739                    
3740                      // determine whether frame has correct length field
3741                      // if length field is greater than equal to 16'h0600 then it represents
3742                      // type rather than length.
3743                      // If frame length is greater than length field then assume the
3744                      // frame is padded or jumbo, and don't reject.
3745                      // Don't set length_error for frames that are too long
3746                      // By comparing length_field_saved to 16'h0600, we only need to compare
3747                      // 11 bits of the length_field_saved to the frm_byte_cnt.
3748                      always@(frm_byte_cnt or length_field_saved or check_rx_length or too_long or
3749                              vlan_tagged_saved)
3750                      begin
3751       1/1               if (check_rx_length &amp;
3752                             (frm_byte_cnt[13:0] &lt; {3'b000,(length_field_saved[10:0] +
3753                                                   (vlan_tagged_saved ? 11'h016 : 11'h012))}) &amp;
3754                             (length_field_saved &lt; 16'h0600) &amp; ~too_long)
3755       <font color = "red">0/1     ==>          length_error = 1'b1;</font>
3756                         else
3757       1/1                  length_error = 1'b0;
3758                      end
3759                    
3760                    // -----------------------------------------------------------------------------
3761                    // Calculate the CRC for the incoming data
3762                    // -----------------------------------------------------------------------------
3763                    // Calculate CRC on received frame. The last 32 bit of the frame contain the
3764                    // inverted CRC. The means a frame received with good CRC will always
3765                    // produce a final CRC value of 32'hc704dd7b.
3766                    
3767                      // Update the current CRC value every time new aligned data is available.
3768                      // In all but the last data a full 32 bits will be processed. In the last
3769                      // data any number of bytes from 1 to 4 will be present so need to tap off
3770                      // at the right position.
3771                      always@(posedge rx_clk or negedge n_rxreset)
3772                      begin
3773       1/1              if (~n_rxreset)
3774       1/1                crc_h &lt;= 32'hffffffff;
3775       1/1              else if (pipeline_finished | ~enable_receive_rck | ~frame_in_pipeline)
3776       1/1                crc_h &lt;= 32'hffffffff;
3777       1/1              else if (new_pipeline_data &amp; no_pipeline_data[1:0] == 2'b01)
3778       1/1                crc_h &lt;= rx_stripe_out7;
3779       1/1              else if (new_pipeline_data)
3780       1/1                crc_h &lt;= rx_stripe_out15;
                        MISSING_ELSE
3781                      end
3782                    
3783                      // The 32 instantiations below form the CRC arithmetic functions
3784                      gem_stripe i_str_rx0 (.din(pipeline_output[0]),
3785                                                    .stripe_in(crc_h         ),
3786                                                    .stripe_out(rx_stripe_out0));
3787                      gem_stripe i_str_rx1 (.din(pipeline_output[1]),
3788                                                    .stripe_in(rx_stripe_out0),
3789                                                    .stripe_out(rx_stripe_out1));
3790                      gem_stripe i_str_rx2 (.din(pipeline_output[2]),
3791                                                    .stripe_in(rx_stripe_out1),
3792                                                    .stripe_out(rx_stripe_out2));
3793                      gem_stripe i_str_rx3 (.din(pipeline_output[3]),
3794                                                    .stripe_in(rx_stripe_out2),
3795                                                    .stripe_out(rx_stripe_out3));
3796                      gem_stripe i_str_rx4 (.din(pipeline_output[4]),
3797                                                    .stripe_in(rx_stripe_out3),
3798                                                    .stripe_out(rx_stripe_out4));
3799                      gem_stripe i_str_rx5 (.din(pipeline_output[5]),
3800                                                    .stripe_in(rx_stripe_out4),
3801                                                    .stripe_out(rx_stripe_out5));
3802                      gem_stripe i_str_rx6 (.din(pipeline_output[6]),
3803                                                    .stripe_in(rx_stripe_out5),
3804                                                    .stripe_out(rx_stripe_out6));
3805                      gem_stripe i_str_rx7 (.din(pipeline_output[7]),
3806                                                    .stripe_in(rx_stripe_out6),
3807                                                    .stripe_out(rx_stripe_out7));
3808                      gem_stripe i_str_rx8 (.din(pipeline_output[8]),
3809                                                    .stripe_in(rx_stripe_out7),
3810                                                    .stripe_out(rx_stripe_out8));
3811                      gem_stripe i_str_rx9 (.din(pipeline_output[9]),
3812                                                    .stripe_in(rx_stripe_out8),
3813                                                    .stripe_out(rx_stripe_out9));
3814                      gem_stripe i_str_rx10(.din(pipeline_output[10]),
3815                                                    .stripe_in(rx_stripe_out9),
3816                                                    .stripe_out(rx_stripe_out10));
3817                      gem_stripe i_str_rx11(.din(pipeline_output[11]),
3818                                                    .stripe_in(rx_stripe_out10),
3819                                                    .stripe_out(rx_stripe_out11));
3820                      gem_stripe i_str_rx12(.din(pipeline_output[12]),
3821                                                    .stripe_in(rx_stripe_out11),
3822                                                    .stripe_out(rx_stripe_out12));
3823                      gem_stripe i_str_rx13(.din(pipeline_output[13]),
3824                                                    .stripe_in(rx_stripe_out12),
3825                                                    .stripe_out(rx_stripe_out13));
3826                      gem_stripe i_str_rx14(.din(pipeline_output[14]),
3827                                                    .stripe_in(rx_stripe_out13),
3828                                                    .stripe_out(rx_stripe_out14));
3829                      gem_stripe i_str_rx15(.din(pipeline_output[15]),
3830                                                    .stripe_in(rx_stripe_out14),
3831                                                    .stripe_out(rx_stripe_out15));
3832                    
3833                      // Detect if good CRC at end of frame
3834                      // Good CRC is 32'hc704dd7b for this implementation because
3835                      // of the way the stripe block is implemented
3836                      always@(posedge rx_clk or negedge n_rxreset)
3837                      begin
3838       1/1              if (~n_rxreset)
3839       1/1                crc_error_reg &lt;= 1'b0;
3840       1/1              else if (~enable_receive_rck)
3841       1/1                crc_error_reg &lt;= 1'b0;
3842       1/1              else if (last_pipeline_data &amp; (crc_h == 32'hc704dd7b))
3843       1/1                crc_error_reg &lt;= 1'b0;
3844       1/1              else if (new_pipeline_data)
3845       1/1                crc_error_reg &lt;= 1'b1;
                        MISSING_ELSE
3846                      end
3847                    
3848                    // -----------------------------------------------------------------------------
3849                    // Magic packet detection
3850                    // -----------------------------------------------------------------------------
3851                    
3852                      // Magic packet detection state machine
3853                      // For magic packet detection must be address matched frame
3854                      // with no errors and contain 6 bytes of FF sync pattern
3855                      // followed by spec add 1 repeated 16 times.
3856                      // magic_packet signal is asserted for 64 rx_clk cycles.
3857                      wire magic_packet;
3858                      generate if (p_num_spec_add_filters &gt; 32'd0) begin : gen_magic_pkt
3859                        reg           magic_packet_r;
3860                        reg     [3:0] rx_mp_state;             // magic packet state machine variable
3861                        reg     [3:0] mp_add_cnt;              // counts 16 addresses in magic packet
3862                        wire    [3:0] mp_add_cnt_nxt;          // next value of mp_add_cnt
3863                        always@(posedge rx_clk or negedge n_rxreset)
3864                        begin
3865       1/1                if (~n_rxreset)
3866                            begin
3867       1/1                    magic_packet_r &lt;= 1'b0;
3868       1/1                    rx_mp_state  &lt;= RX_MP_WAIT_SYNC1;
3869       1/1                    mp_add_cnt   &lt;= 4'hF;
3870                            end
3871       1/1                else if (~enable_receive_rck |
3872                                  ~spec_add_filter_active[0] |
3873                                  (pipeline_finished &amp; (rx_mp_state != RX_MP_WAIT_CRC)))
3874                            begin
3875       1/1                    magic_packet_r &lt;= 1'b0;
3876       1/1                    rx_mp_state  &lt;= RX_MP_WAIT_SYNC1;
3877       1/1                    mp_add_cnt   &lt;= 4'hF;
3878                            end
3879                          else
3880       1/1                  case(rx_mp_state)
3881                               RX_MP_WAIT_SYNC2: // waiting for second and third FF sync bytes
3882       <font color = "red">0/1     ==>                if (new_pipeline_data_comb &amp; (pipeline_output[15:0] == 16'hffff))</font>
3883       <font color = "red">0/1     ==>                   rx_mp_state &lt;= RX_MP_WAIT_SYNC4;</font>
3884       <font color = "red">0/1     ==>                else if (new_pipeline_data_comb &amp; (pipeline_output[15:8] == 8'hff))</font>
3885       <font color = "red">0/1     ==>                   rx_mp_state &lt;= RX_MP_WAIT_SYNC2;</font>
3886       <font color = "red">0/1     ==>                else if (new_pipeline_data_comb)</font>
3887       <font color = "red">0/1     ==>                   rx_mp_state &lt;= RX_MP_WAIT_SYNC1;</font>
3888                                  else
3889       <font color = "red">0/1     ==>                   rx_mp_state &lt;= RX_MP_WAIT_SYNC2;</font>
3890                    
3891                               RX_MP_WAIT_SYNC3: // waiting for third and fourth FF sync bytes
3892       <font color = "red">0/1     ==>                if (new_pipeline_data_comb &amp; (pipeline_output[15:0] == 16'hffff))</font>
3893       <font color = "red">0/1     ==>                   rx_mp_state &lt;= RX_MP_WAIT_SYNC5;</font>
3894       <font color = "red">0/1     ==>                else if (new_pipeline_data_comb &amp; (pipeline_output[15:8] == 8'hff))</font>
3895       <font color = "red">0/1     ==>                   rx_mp_state &lt;= RX_MP_WAIT_SYNC2;</font>
3896       <font color = "red">0/1     ==>                else if (new_pipeline_data_comb)</font>
3897       <font color = "red">0/1     ==>                   rx_mp_state &lt;= RX_MP_WAIT_SYNC1;</font>
3898                                  else
3899       <font color = "red">0/1     ==>                   rx_mp_state &lt;= RX_MP_WAIT_SYNC3;</font>
3900                    
3901                               RX_MP_WAIT_SYNC4: // waiting for fourth and fifth FF sync bytes
3902       <font color = "red">0/1     ==>                if (new_pipeline_data_comb &amp; (pipeline_output[15:0] == 16'hffff))</font>
3903       <font color = "red">0/1     ==>                   rx_mp_state &lt;= RX_MP_WAIT_SYNC6;</font>
3904       <font color = "red">0/1     ==>                else if (new_pipeline_data_comb &amp; (pipeline_output[15:8] == 8'hff))</font>
3905       <font color = "red">0/1     ==>                   rx_mp_state &lt;= RX_MP_WAIT_SYNC2;</font>
3906       <font color = "red">0/1     ==>                else if (new_pipeline_data_comb)</font>
3907       <font color = "red">0/1     ==>                   rx_mp_state &lt;= RX_MP_WAIT_SYNC1;</font>
3908                                  else
3909       <font color = "red">0/1     ==>                   rx_mp_state &lt;= RX_MP_WAIT_SYNC4;</font>
3910                    
3911                               RX_MP_WAIT_SYNC5: // waiting for fifth and sixth FF sync bytes
3912       <font color = "red">0/1     ==>                if (new_pipeline_data_comb &amp; (pipeline_output[15:0] == 16'hffff))</font>
3913       <font color = "red">0/1     ==>                   rx_mp_state &lt;= RX_MP_WAIT_ADD1;</font>
3914       <font color = "red">0/1     ==>                else if (new_pipeline_data_comb &amp; (pipeline_output[15:8] == 8'hff))</font>
3915       <font color = "red">0/1     ==>                   rx_mp_state &lt;= RX_MP_WAIT_SYNC2;</font>
3916       <font color = "red">0/1     ==>                else if (new_pipeline_data_comb)</font>
3917       <font color = "red">0/1     ==>                   rx_mp_state &lt;= RX_MP_WAIT_SYNC1;</font>
3918                                  else
3919       <font color = "red">0/1     ==>                   rx_mp_state &lt;= RX_MP_WAIT_SYNC5;</font>
3920                    
3921                               RX_MP_WAIT_SYNC6: // waiting for sixth FF sync and spec_add1[7:0]
3922       <font color = "red">0/1     ==>                if (new_pipeline_data_comb &amp; (pipeline_output[7:0] == 8'hff) &amp;</font>
3923                                           (pipeline_output[15:8] == spec_add_filter_regs[7:0]))
3924       <font color = "red">0/1     ==>                   rx_mp_state &lt;= RX_MP_WAIT_ADD2;</font>
3925       <font color = "red">0/1     ==>                else if (new_pipeline_data_comb &amp; (pipeline_output[15:0] == 16'hffff))</font>
3926       <font color = "red">0/1     ==>                   rx_mp_state &lt;= RX_MP_WAIT_ADD1;</font>
3927       <font color = "red">0/1     ==>                else if (new_pipeline_data_comb &amp; (pipeline_output[15:8] == 8'hff))</font>
3928       <font color = "red">0/1     ==>                   rx_mp_state &lt;= RX_MP_WAIT_SYNC2;</font>
3929       <font color = "red">0/1     ==>                else if (new_pipeline_data_comb)</font>
3930       <font color = "red">0/1     ==>                   rx_mp_state &lt;= RX_MP_WAIT_SYNC1;</font>
3931                                  else
3932       <font color = "red">0/1     ==>                   rx_mp_state &lt;= RX_MP_WAIT_SYNC6;</font>
3933                    
3934                               RX_MP_WAIT_ADD1: // waiting for first spec_add1 byte
3935       <font color = "red">0/1     ==>                if (new_pipeline_data_comb &amp;</font>
3936                                      (pipeline_output[15:0] == spec_add_filter_regs[15:0]))
3937       <font color = "red">0/1     ==>                   rx_mp_state &lt;= RX_MP_WAIT_ADD3;</font>
3938       <font color = "red">0/1     ==>                else if (new_pipeline_data_comb &amp; (pipeline_output[7:0] == 8'hff) &amp;</font>
3939                                           (pipeline_output[15:8] == spec_add_filter_regs[7:0]) &amp;
3940                                           (mp_add_cnt == 4'hF))
3941       <font color = "red">0/1     ==>                   rx_mp_state &lt;= RX_MP_WAIT_ADD2;</font>
3942       <font color = "red">0/1     ==>                else if (new_pipeline_data_comb &amp; (mp_add_cnt == 4'hF) &amp;</font>
3943                                           (pipeline_output[15:0] == 16'hffff))
3944       <font color = "red">0/1     ==>                   rx_mp_state &lt;= RX_MP_WAIT_ADD1;</font>
3945       <font color = "red">0/1     ==>                else if (new_pipeline_data_comb &amp; (pipeline_output[15:0] == 16'hffff))</font>
3946       <font color = "red">0/1     ==>                   rx_mp_state &lt;= RX_MP_WAIT_SYNC3;</font>
3947       <font color = "red">0/1     ==>                else if (new_pipeline_data_comb &amp; (pipeline_output[15:8] == 8'hff))</font>
3948       <font color = "red">0/1     ==>                   rx_mp_state &lt;= RX_MP_WAIT_SYNC2;</font>
3949       <font color = "red">0/1     ==>                else if (new_pipeline_data_comb)</font>
3950       <font color = "red">0/1     ==>                   rx_mp_state &lt;= RX_MP_WAIT_SYNC1;</font>
3951                                  else
3952       <font color = "red">0/1     ==>                   rx_mp_state &lt;= RX_MP_WAIT_ADD1;</font>
3953                    
3954                               RX_MP_WAIT_ADD2: // waiting for second spec_add1 byte
3955       <font color = "red">0/1     ==>                if (new_pipeline_data_comb &amp;</font>
3956                                      (pipeline_output[15:0] == spec_add_filter_regs[23:8]))
3957       <font color = "red">0/1     ==>                   rx_mp_state &lt;= RX_MP_WAIT_ADD4;</font>
3958       <font color = "red">0/1     ==>                else if (new_pipeline_data_comb &amp; (pipeline_output[15:0] == 16'hffff))</font>
3959       <font color = "red">0/1     ==>                   rx_mp_state &lt;= RX_MP_WAIT_SYNC3;</font>
3960       <font color = "red">0/1     ==>                else if (new_pipeline_data_comb &amp; (pipeline_output[15:8] == 8'hff))</font>
3961       <font color = "red">0/1     ==>                   rx_mp_state &lt;= RX_MP_WAIT_SYNC2;</font>
3962       <font color = "red">0/1     ==>                else if (new_pipeline_data_comb)</font>
3963       <font color = "red">0/1     ==>                   rx_mp_state &lt;= RX_MP_WAIT_SYNC1;</font>
3964                                  else
3965       <font color = "red">0/1     ==>                   rx_mp_state &lt;= RX_MP_WAIT_ADD2;</font>
3966                    
3967                               RX_MP_WAIT_ADD3: // waiting for third spec_add1 byte
3968       <font color = "red">0/1     ==>                if (new_pipeline_data_comb &amp;</font>
3969                                      (pipeline_output[15:0] == spec_add_filter_regs[31:16]))
3970       <font color = "red">0/1     ==>                   rx_mp_state &lt;= RX_MP_WAIT_ADD5;</font>
3971       <font color = "red">0/1     ==>                else if (new_pipeline_data_comb &amp; (pipeline_output[15:0] == 16'hffff))</font>
3972       <font color = "red">0/1     ==>                   rx_mp_state &lt;= RX_MP_WAIT_SYNC3;</font>
3973       <font color = "red">0/1     ==>                else if (new_pipeline_data_comb &amp; (pipeline_output[15:8] == 8'hff))</font>
3974       <font color = "red">0/1     ==>                   rx_mp_state &lt;= RX_MP_WAIT_SYNC2;</font>
3975       <font color = "red">0/1     ==>                else if (new_pipeline_data_comb)</font>
3976       <font color = "red">0/1     ==>                   rx_mp_state &lt;= RX_MP_WAIT_SYNC1;</font>
3977                                  else
3978       <font color = "red">0/1     ==>                   rx_mp_state &lt;= RX_MP_WAIT_ADD3;</font>
3979                    
3980                               RX_MP_WAIT_ADD4: // waiting for fourth spec_add1 byte
3981       <font color = "red">0/1     ==>                if (new_pipeline_data_comb &amp;</font>
3982                                      (pipeline_output[15:0] == spec_add_filter_regs[39:24]))
3983       <font color = "red">0/1     ==>                   rx_mp_state &lt;= RX_MP_WAIT_ADD6;</font>
3984       <font color = "red">0/1     ==>                else if (new_pipeline_data_comb &amp; (pipeline_output[15:0] == 16'hffff))</font>
3985       <font color = "red">0/1     ==>                   rx_mp_state &lt;= RX_MP_WAIT_SYNC3;</font>
3986       <font color = "red">0/1     ==>                else if (new_pipeline_data_comb &amp; (pipeline_output[15:8] == 8'hff))</font>
3987       <font color = "red">0/1     ==>                   rx_mp_state &lt;= RX_MP_WAIT_SYNC2;</font>
3988       <font color = "red">0/1     ==>                else if (new_pipeline_data_comb)</font>
3989       <font color = "red">0/1     ==>                   rx_mp_state &lt;= RX_MP_WAIT_SYNC1;</font>
3990                                  else
3991       <font color = "red">0/1     ==>                   rx_mp_state &lt;= RX_MP_WAIT_ADD4;</font>
3992                    
3993                               RX_MP_WAIT_ADD5: // waiting for fifth spec_add1
3994       <font color = "red">0/1     ==>                if (new_pipeline_data_comb &amp; (mp_add_cnt == 4'h0) &amp;</font>
3995                                      (pipeline_output[15:0] == spec_add_filter_regs[47:32]))
3996       <font color = "red">0/1     ==>                   rx_mp_state &lt;= RX_MP_WAIT_CRC;</font>
3997       <font color = "red">0/1     ==>                else if (new_pipeline_data_comb &amp;</font>
3998                                           (pipeline_output[15:0] == spec_add_filter_regs[47:32]))
3999                                     begin
4000       <font color = "red">0/1     ==>                      rx_mp_state &lt;= RX_MP_WAIT_ADD1;</font>
4001       <font color = "red">0/1     ==>                      mp_add_cnt  &lt;= mp_add_cnt_nxt;</font>
4002                                     end
4003       <font color = "red">0/1     ==>                else if (new_pipeline_data_comb &amp; (pipeline_output[15:0] == 16'hffff))</font>
4004       <font color = "red">0/1     ==>                   rx_mp_state &lt;= RX_MP_WAIT_SYNC3;</font>
4005       <font color = "red">0/1     ==>                else if (new_pipeline_data_comb &amp; (pipeline_output[15:8] == 8'hff))</font>
4006       <font color = "red">0/1     ==>                   rx_mp_state &lt;= RX_MP_WAIT_SYNC2;</font>
4007       <font color = "red">0/1     ==>                else if (new_pipeline_data_comb)</font>
4008       <font color = "red">0/1     ==>                   rx_mp_state &lt;= RX_MP_WAIT_SYNC1;</font>
4009                                  else
4010       <font color = "red">0/1     ==>                   rx_mp_state &lt;= RX_MP_WAIT_ADD5;</font>
4011                    
4012                               RX_MP_WAIT_ADD6: // waiting for sixth spec_add1
4013       <font color = "red">0/1     ==>                if (new_pipeline_data_comb &amp; (mp_add_cnt == 4'h0) &amp;</font>
4014                                      (pipeline_output[7:0] == spec_add_filter_regs[47:40]))
4015       <font color = "red">0/1     ==>                   rx_mp_state &lt;= RX_MP_WAIT_CRC;</font>
4016       <font color = "red">0/1     ==>                else if (new_pipeline_data_comb &amp;</font>
4017                                           (pipeline_output[7:0] == spec_add_filter_regs[47:40]) &amp;
4018                                           (pipeline_output[15:8] == spec_add_filter_regs[7:0]))
4019                                     begin
4020       <font color = "red">0/1     ==>                      rx_mp_state &lt;= RX_MP_WAIT_ADD2;</font>
4021       <font color = "red">0/1     ==>                      mp_add_cnt  &lt;= mp_add_cnt_nxt;</font>
4022                                     end
4023       <font color = "red">0/1     ==>                else if (new_pipeline_data_comb &amp; (pipeline_output[15:0] == 16'hffff))</font>
4024       <font color = "red">0/1     ==>                   rx_mp_state &lt;= RX_MP_WAIT_SYNC3;</font>
4025       <font color = "red">0/1     ==>                else if (new_pipeline_data_comb &amp; (pipeline_output[15:8] == 8'hff))</font>
4026       <font color = "red">0/1     ==>                   rx_mp_state &lt;= RX_MP_WAIT_SYNC2;</font>
4027       <font color = "red">0/1     ==>                else if (new_pipeline_data_comb)</font>
4028       <font color = "red">0/1     ==>                   rx_mp_state &lt;= RX_MP_WAIT_SYNC1;</font>
4029                                  else
4030       <font color = "red">0/1     ==>                   rx_mp_state &lt;= RX_MP_WAIT_ADD6;</font>
4031                    
4032                               RX_MP_WAIT_CRC: // waiting for good CRC
4033       <font color = "red">0/1     ==>                if (pipeline_finished)</font>
4034                                     begin
4035       <font color = "red">0/1     ==>                      magic_packet_r &lt;= ~bad_frame;</font>
4036       <font color = "red">0/1     ==>                      rx_mp_state  &lt;= RX_MP_WAIT_SYNC1;</font>
4037       <font color = "red">0/1     ==>                      mp_add_cnt   &lt;= 4'hF;</font>
4038                                     end
4039                                  else
4040       <font color = "red">0/1     ==>                   rx_mp_state &lt;= RX_MP_WAIT_CRC;</font>
4041                    
4042                               default: //RX_MP_WAIT_SYNC1: // waiting for first FF sync bytes
4043       1/1                        if (new_pipeline_data_comb &amp; (pipeline_output[15:0] == 16'hffff))
4044                                     begin
4045       <font color = "red">0/1     ==>                      magic_packet_r &lt;= 1'b0;</font>
4046       <font color = "red">0/1     ==>                      rx_mp_state &lt;= RX_MP_WAIT_SYNC3;</font>
4047       <font color = "red">0/1     ==>                      mp_add_cnt  &lt;= 4'hF;</font>
4048                                     end
4049       1/1                        else if (new_pipeline_data_comb &amp; (pipeline_output[15:8] == 8'hff))
4050                                     begin
4051       <font color = "red">0/1     ==>                      magic_packet_r &lt;= 1'b0;</font>
4052       <font color = "red">0/1     ==>                      rx_mp_state &lt;= RX_MP_WAIT_SYNC2;</font>
4053       <font color = "red">0/1     ==>                      mp_add_cnt  &lt;= 4'hF;</font>
4054                                     end
4055                                  else
4056                                     begin
4057       1/1                              magic_packet_r &lt;= 1'b0;
4058       1/1                              rx_mp_state &lt;= RX_MP_WAIT_SYNC1;
4059       1/1                              mp_add_cnt  &lt;= 4'hF;
4060                                     end
4061                    
4062                            endcase
4063                        end
4064                        assign mp_add_cnt_nxt = mp_add_cnt - 4'h1;
4065                        assign magic_packet = magic_packet_r;
4066                      end else begin : gen_no_magic_packet
4067                        assign magic_packet = 1'b0;
4068                      end
4069                      endgenerate
4070                    
4071                    // -----------------------------------------------------------------------------
4072                    // Detect ARP request frame
4073                    // -----------------------------------------------------------------------------
4074                    
4075                      parameter IDLE      = 4'h0;
4076                      parameter OP_FIELD  = 4'h3;
4077                      parameter PROT_ADDR = 4'hd;
4078                      parameter ALL_FIELD = 4'he;
4079                    
4080                      // Detect an ARP request frame for WoL purposes.
4081                      // An ARP type is already detected and signalled by arp_frame.
4082                      // Fields checked are ARP operation for a request opcode and target protocol
4083                      // address (only bottom 16 bits).
4084                      // Fields not checked are hardware and protocol types address lengths,
4085                      // sender hardware and protocol address, and target hardware address.
4086                      always@(posedge rx_clk or negedge n_rxreset)
4087                      begin
4088       1/1               if (~n_rxreset)
4089                           begin
4090       1/1                   arp_count     &lt;= IDLE;
4091       1/1                   arp_req_frame &lt;= 1'b0;
4092                           end
4093                    
4094                         // Wait for an ARP frame type to be recognised to allow further
4095                         // processing. Only process when enabled and a valid frame is detected.
4096       1/1               else if (~enable_receive_rck | pipeline_finished |
4097                                  ~frame_in_pipeline | ~arp_frame)
4098                           begin
4099       1/1                   arp_count     &lt;= IDLE;
4100       1/1                   arp_req_frame &lt;= 1'b0;
4101                           end
4102                    
4103                         // new pipeline data to process
4104       <font color = "red">0/1     ==>       else if (new_aligned_data)</font>
4105                           begin
4106                              // Use arp_count to work out which field in ARP frame
4107       <font color = "red">0/1     ==>            case (arp_count)</font>
4108                                 OP_FIELD: begin // ARP operation field
4109                    
4110                                              // increment count
4111       <font color = "red">0/1     ==>                            arp_count &lt;= arp_count_nxt;</font>
4112                    
4113                                              // Check operation field for correct ARP
4114                                              // request opcode.
4115       <font color = "red">0/1     ==>                            if ({new_data_align[7:0],</font>
4116                                                   new_data_align[15:8]} == ARP_REQ_OP)
4117       <font color = "red">0/1     ==>                              arp_req_frame &lt;= 1'b1;</font>
4118                                              else
4119       <font color = "red">0/1     ==>                              arp_req_frame &lt;= 1'b0;</font>
4120                                           end
4121                    
4122                              PROT_ADDR  : begin // ARP target protocol address
4123                    
4124                                              // increment count
4125       <font color = "red">0/1     ==>                            arp_count &lt;= arp_count_nxt;</font>
4126                    
4127                                              // Check bottom 16 bytes of target protocol address
4128                                              // match expected wop_ip_addr
4129       <font color = "red">0/1     ==>                            if ((wol_ip_addr != 16'h0000) &amp;</font>
4130                                                   {new_data_align[7:0],
4131                                                    new_data_align[15:8]} == wol_ip_addr)
4132       <font color = "red">0/1     ==>                              arp_req_frame &lt;= arp_req_frame;</font>
4133                                              else
4134       <font color = "red">0/1     ==>                              arp_req_frame &lt;= 1'b0;</font>
4135                    
4136                                           end
4137                    
4138                              ALL_FIELD : begin // All field processed
4139       <font color = "red">0/1     ==>                           arp_count     &lt;= arp_count;</font>
4140       <font color = "red">0/1     ==>                           arp_req_frame &lt;= arp_req_frame;</font>
4141                                           end
4142                    
4143                                 default : begin // wait for all field to happen, increment count
4144       <font color = "red">0/1     ==>                           arp_count     &lt;= arp_count_nxt;</font>
4145       <font color = "red">0/1     ==>                           arp_req_frame &lt;= arp_req_frame;</font>
4146                                           end
4147                              endcase
4148                           end
                   <font color = "red">==>  MISSING_ELSE</font>
4149                      end
4150                    
4151                      // assign next value of arp_count
4152                      assign arp_count_nxt = arp_count + 4'h1;
4153                    
4154                    // -----------------------------------------------------------------------------
4155                    // Wake-on-LAN assertion
4156                    // -----------------------------------------------------------------------------
4157                    
4158                      // syncrhonise WoL enable mask
4159                      cdnsdru_datasync_v1 #(
4160                         .CDNSDRU_DATASYNC_DIN_W(4)
4161                      ) i_cdnsdru_datasync_v1_wol_mask (
4162                         .clk(rx_clk),
4163                         .reset_n(n_rxreset),
4164                         .din(wol_mask),
4165                         .dout(wol_mask_rck));
4166                    
4167                      // wol signal is asserted for 64 rx_clk cycles when wakeup event is seen.
4168                      always@(posedge rx_clk or negedge n_rxreset)
4169                      begin
4170       1/1              if (~n_rxreset)
4171                          begin
4172       1/1                  wol_drive_cnt &lt;= 6'h00;
4173       1/1                  wol           &lt;= 1'b0;
4174                          end
4175       1/1              else if (~enable_receive_rck)
4176                          begin
4177       1/1                  wol_drive_cnt &lt;= 6'h00;
4178       1/1                  wol           &lt;= 1'b0;
4179                          end
4180       1/1              else if (wol_drive_cnt != 6'h00)
4181                          begin
4182       <font color = "red">0/1     ==>          wol_drive_cnt &lt;= wol_drive_cnt_nxt;</font>
4183       <font color = "red">0/1     ==>          wol           &lt;= 1'b1;</font>
4184                          end
4185       1/1              else if (
4186                    
4187                               // magic packet detected and mask enabled
4188                               (magic_packet &amp; wol_mask_rck[0]) |
4189                    
4190                               // or ARP request frame with bottom 16 bits of DA that matches
4191                               // wol_ip_addr and mask is enabled
4192                               (pipeline_finished &amp; arp_req_frame_saved &amp; frame_matched_pipe &amp;
4193                                                         broad_frame_saved &amp; wol_mask_rck[1]) |
4194                    
4195                               // or specific address 1 match and mask is enabled
4196                               (pipeline_finished &amp; frame_matched_pipe &amp; add_match_saved_bot &amp;
4197                                                                             wol_mask_rck[2]) |
4198                    
4199                               // or multicast hash filter match and not broadcast and mask set
4200                               (pipeline_finished &amp; frame_matched_pipe &amp; multi_match_saved &amp;
4201                                                        ~broad_frame_saved &amp; wol_mask_rck[3])
4202                    
4203                                )
4204                          begin
4205       <font color = "red">0/1     ==>           wol_drive_cnt &lt;= 6'h3F;</font>
4206       <font color = "red">0/1     ==>           wol           &lt;= 1'b1;</font>
4207                          end
4208                        else
4209                          begin
4210       1/1                   wol_drive_cnt &lt;= 6'h00;
4211       1/1                   wol           &lt;= 1'b0;
4212                          end
4213                      end
4214                    
4215                      // next count variables with overflow bit
4216                      assign wol_drive_cnt_nxt = wol_drive_cnt - 6'h01;
4217                    
4218                    // -----------------------------------------------------------------------------
4219                    // Status and Error Reporting (to both register and DMA blocks)
4220                    // -----------------------------------------------------------------------------
4221                    
4222                      // dma_rx_end_tog is toggled at the end of every frame (or if too long)
4223                      // and is used as handshaking to the DMA module.
4224                      // dma_rx_end_frame is used as an indication that an update is already in
4225                      // progress so that we can detect if the updates happen too often (overflow).
4226                      always@(posedge rx_clk or negedge n_rxreset)
4227                      begin
4228       1/1              if (~n_rxreset)
4229                          begin
4230       1/1                  dma_rx_end_tog      &lt;= 1'b0;
4231       1/1                  dma_rx_end_frame    &lt;= 1'b0;
4232                          end
4233                        else
4234                          begin
4235                    
4236                             // dma_rx_end_tog indicates to the DMA block that status
4237                             // is available for a new received frame. This is either
4238                             // at the end of a frame if not too long, or immediately if
4239                             // frame exceeds length. Do not signal if frame has not been
4240                             // matched as the DMA knows nothing about it.
4241       1/1                   if (~enable_receive_rck)
4242                               begin
4243       1/1                       dma_rx_end_tog    &lt;= dma_rx_end_tog;
4244       1/1                       dma_rx_end_frame  &lt;= 1'b0;
4245                               end
4246       1/1                   else if ((pipeline_finished | too_long_dec) &amp; ~too_long &amp;
4247                                      frame_matched_pipe &amp; ~update_in_progress)
4248                               begin
4249       1/1                       dma_rx_end_tog    &lt;= ~dma_rx_end_tog;
4250       1/1                       dma_rx_end_frame  &lt;= 1'b1;
4251                               end
4252       1/1                   else if (dma_update_finished)
4253                               begin
4254       1/1                       dma_rx_end_tog    &lt;= dma_rx_end_tog;
4255       1/1                       dma_rx_end_frame  &lt;= 1'b0;
4256                               end
                        MISSING_ELSE
4257                           end
4258                      end
4259                    
4260                      // When there is a DMA, need to wait for DMA to indicated that it has completed status
4261                      // capture, otherwise base off the registers capture status.
4262                      generate if (p_edma_ext_fifo_interface == 1'b0) begin : gen_has_dma
4263                        // detect either edge on synchronised dma_rx_status_tog to indicate
4264                        // that DMA update has completed.
4265                        edma_sync_toggle_detect i_edma_sync_toggle_detect_dma_rx_status_tog (
4266                          .clk      (rx_clk),
4267                          .reset_n  (n_rxreset),
4268                          .din      (dma_rx_status_tog),
4269                          .rise_edge(),
4270                          .fall_edge(),
4271                          .any_edge (dma_update_finished)
4272                         );
4273                      end else begin : gen_has_no_dma
4274                        assign dma_update_finished = reg_update_finished;
4275                      end
4276                      endgenerate
4277                    
4278                    
4279                      // rx_end_tog is toggled at the end of every frame and is used as
4280                      // handshaking to the register module.
4281                      // rx_end_frame is used as an indication that an update is already in
4282                      // progress so that we can detect if the updates happen too often (overflow).
4283                      always@(posedge rx_clk or negedge n_rxreset)
4284                      begin
4285       1/1              if (~n_rxreset)
4286                          begin
4287       1/1                  rx_end_tog         &lt;= 1'b0;
4288       1/1                  rx_end_frame       &lt;= 1'b0;
4289                          end
4290                        else
4291                          begin
4292                    
4293                             // rx_end_tog indicates to the registers block that status
4294                             // is available for a new received frame. This is always at end
4295                             // of frame if the status is not already being updated (overflow).
4296                             // If an overflow has occured for this reason then there will a
4297                             // further update once the current update has completed.
4298       1/1                   if (~enable_receive_rck)
4299                               begin
4300       1/1                       rx_end_tog    &lt;= rx_end_tog;
4301       1/1                       rx_end_frame  &lt;= 1'b0;
4302                               end
4303       1/1                   else if ((pipeline_finished &amp; ~((update_in_progress &amp; ~too_long) |
4304                                                        (rx_end_frame &amp; too_long))) |
4305                                 (update_finished &amp; update_overflow))
4306                               begin
4307       1/1                       rx_end_tog    &lt;= ~rx_end_tog;
4308       1/1                       rx_end_frame  &lt;= 1'b1;
4309                               end
4310       1/1                   else if (reg_update_finished)
4311                               begin
4312       1/1                       rx_end_tog    &lt;= rx_end_tog;
4313       1/1                       rx_end_frame  &lt;= 1'b0;
4314                               end
                        MISSING_ELSE
4315                          end
4316                      end
4317                    
4318                      // detect either edge on synchronised rx_status_wr_tog to indicate
4319                      // that DMA update has completed.
4320                      edma_sync_toggle_detect i_edma_sync_toggle_detect_rx_status_wr_tog (
4321                         .clk(rx_clk),
4322                         .reset_n(n_rxreset),
4323                         .din(rx_status_wr_tog),
4324                         .rise_edge(),
4325                         .fall_edge(),
4326                         .any_edge(reg_update_finished));
4327                    
4328                    
4329                      // detect when a status update is still in progress. This is when either
4330                      // the DMA or register block updates are still active
4331                      assign update_in_progress = (rx_end_frame &amp; ~reg_update_finished) |
4332                                                  (dma_rx_end_frame &amp; ~dma_update_finished);
4333                    
4334                      // Detect when update has finished. This is a pulse signalled when both
4335                      // updates have completed.
4336                      assign update_finished =
4337                         // Pulse when the register update is just finishing and the dma
4338                         // update has already finished or about to finish, or...
4339                         (rx_end_frame &amp; reg_update_finished &amp;
4340                          (~dma_rx_end_frame | dma_update_finished)) |
4341                    
4342                         // pulse when the DMA update is just finishing and the register
4343                         // update has already finished or about to finish, or...
4344                         (dma_rx_end_frame &amp; dma_update_finished &amp;
4345                          (~rx_end_frame | reg_update_finished));
4346                    
4347                      //-------------------------------------------
4348                      // Per queue rx flushing
4349                      //-------------------------------------------
4350                      reg [13:0] frame_length;
4351                      always @ *
4352                      begin
4353       1/1              if (strip_rx_fcs &amp; (frm_byte_cnt &gt;= 14'h0004))
4354       <font color = "red">0/1     ==>        frame_length = frm_byte_cnt[13:0] - 14'h0004;</font>
4355                        else
4356       1/1                frame_length = frm_byte_cnt[13:0];
4357                      end
4358                    
4359                      gem_rx_per_queue_flush # (
4360                          .grouped_params (grouped_params)
4361                        ) i_gem_rx_per_queue_flush (
4362                          .n_rxreset                (n_rxreset),                // reset
4363                          .rx_clk                   (rx_clk),                   // clock
4364                          .enable_receive_rck       (enable_receive_rck),       // soft reset
4365                          .max_val_pclk             (max_val_pclk),             // bits 31:16 of rx_q_flush register (for each queue)
4366                          .drop_all_frames_rx_clk   (drop_all_frames_rx_clk),   // bit 0 (for each queue)
4367                          .limit_frames_size_rx_clk (limit_frames_size_rx_clk), // bit 3 (for each queue)
4368                          .queue_ptr_rx             (queue_ptr_rx),             // queue pointer in SRAM push phase
4369                          .final_eop_push           (final_eop_push),           // Early end of packet strobe
4370                          .frame_length             (frame_length),             // it counts the frame length expressed in bytes
4371                          .rx_drop_frame            (rx_drop_frame),            // Output associated to Mode0, Mode2, 3, and 4
4372                          .frame_flushed_tog        (frame_flushed_tog),        // toggle to stats regs: flush by mode 2, 3, or 4
4373                          .fill_lvl_breached        (fill_lvl_breached)         // Coming from EDMA RX-RD, signalling a breach on the fill level
4374                      );
4375                    
4376                      //-------------------------------------------
4377                      // Per type 2 screener rate limiting
4378                      //-------------------------------------------
4379                      generate if((p_num_type2_screeners &gt; 8'd0))
4380                      begin: gen_per_scr2_rate_lim
4381                        gem_rx_per_scr2_rate_lim # (
4382                            .grouped_params (grouped_params)
4383                          ) i_gem_rx_per_scr2_rate_lim (
4384                            .n_rxreset          (n_rxreset),                                   // reset
4385                            .rx_clk             (rx_clk),                                      // clock
4386                            .enable_receive_rck (enable_receive_rck),                          // soft reset
4387                            .frame_length       (frame_length),                                // frame length
4388                            .final_eop_push     (final_eop_push),                              // early version of rx_w_eop
4389                            .rx_w_eop           (rx_w_eop),                                    // end of packet strobe at fifo if
4390                            .end_of_frame       (end_of_frame),                                // sampling point for scr2_match_vec
4391                            .scr2_match_vec     (scr2_match_vec),                              // type 2 screener matching vector
4392                            .scr2_rate_lim_regs (scr2_rate_lim[(32*p_num_type2_screeners):1]), // type 2 screener rate limiting registers
4393                            .scr2_rate_lim_drop (scr2_rate_lim_drop),                          // drop signal to gem_rx
4394                            .scr_excess_rate    (scr_excess_rate)                              // ouput for statistic registers
4395                        );
4396                      end
4397                      else
4398                      begin: no_gen_per_scr2_rate_lim
4399                        assign scr2_rate_lim_drop = 1'b0;
4400                        assign scr_excess_rate    = 1'b0;
4401                      end
4402                      endgenerate
4403                    
4404                      // decide what is a bad frame
4405                      assign bad_frame = too_long | too_long_dec | too_short |
4406                                         (crc_error_reg &amp; ~rx_no_crc_check) |
4407                                         code_error_saved | length_error | update_overflow |
4408                                         overflow_saved | rx_pipeline_overflow  | rx_w_overflow |
4409                                         ip_ck_err_saved | tcp_udp_ck_err_saved | rx_drop_frame |
4410                                         scr_drop_frame_saved | scr2_rate_lim_drop;
4411                    
4412                      // status back to DMA block.
4413                      // Only load when frame finished (or too long) and valid length has
4414                      // been measured and the previous status has been taken by the DMA.
4415                      // Do not signal if frame has not been matched as the DMA know nothing
4416                      // about the frame.
4417                      // Generate rx_w_bad_frame if any of the error conditions are true.
4418                      generate if (p_num_spec_add_filters &gt; 32'd0) begin : gen_spec_add2
4419                       reg  [p_num_spec_add_filters-1:0] rx_w_add_match_r;
4420                       always@(posedge rx_clk or negedge n_rxreset)
4421                       begin
4422       1/1               if (~n_rxreset)
4423       1/1                     rx_w_add_match_r       &lt;= {p_num_spec_add_filters{1'b0}};
4424       1/1               else if ((pipeline_finished | too_long_dec) &amp; ~too_long &amp;
4425                                   frame_matched_pipe &amp; ~update_in_progress &amp;
4426                                   (frm_byte_cnt != 14'd0))
4427       1/1                     rx_w_add_match_r       &lt;= add_match_saved[p_num_spec_add_filters:1];
                        MISSING_ELSE
4428                       end
4429                       assign rx_w_add_match = {rx_w_add_match_r,1'b0};
4430                      end else begin : gen_no_spec_add2
4431                       assign rx_w_add_match = 1'b0;
4432                      end
4433                      endgenerate
4434                      always@(posedge rx_clk or negedge n_rxreset)
4435                      begin
4436       1/1              if (~n_rxreset)
4437                          begin
4438       1/1                  rx_w_bad_frame       &lt;= 1'b0;
4439       1/1                  rx_w_frame_length    &lt;= 14'd0;
4440       1/1                  rx_w_broadcast_frame &lt;= 1'b0;
4441       1/1                  rx_w_mult_hash_match &lt;= 1'b0;
4442       1/1                  rx_w_uni_hash_match  &lt;= 1'b0;
4443       1/1                  rx_w_ext_match1      &lt;= 1'b0;
4444       1/1                  rx_w_ext_match2      &lt;= 1'b0;
4445       1/1                  rx_w_ext_match3      &lt;= 1'b0;
4446       1/1                  rx_w_ext_match4      &lt;= 1'b0;
4447       1/1                  rx_w_type_match1     &lt;= 1'b0;
4448       1/1                  rx_w_type_match2     &lt;= 1'b0;
4449       1/1                  rx_w_type_match3     &lt;= 1'b0;
4450       1/1                  rx_w_type_match4     &lt;= 1'b0;
4451       1/1                  rx_w_checksumi_ok    &lt;= 1'b0;
4452       1/1                  rx_w_checksumt_ok    &lt;= 1'b0;
4453       1/1                  rx_w_checksumu_ok    &lt;= 1'b0;
4454       1/1                  rx_w_snap_frame      &lt;= 1'b0;
4455       1/1                  rx_w_length_error    &lt;= 1'b0;
4456       1/1                  rx_w_crc_error       &lt;= 1'b0;
4457       1/1                  rx_w_too_short       &lt;= 1'b0;
4458       1/1                  rx_w_too_long        &lt;= 1'b0;
4459       1/1                  rx_w_code_error      &lt;= 1'b0;
4460                          end
4461       1/1              else if ((pipeline_finished | too_long_dec) &amp; ~too_long &amp;
4462                                  frame_matched_pipe &amp; ~update_in_progress &amp;
4463                                  (frm_byte_cnt != 14'd0))
4464                          begin
4465       1/1                  rx_w_bad_frame          &lt;= bad_frame;
4466       1/1                  rx_w_broadcast_frame    &lt;= broad_frame_saved;
4467       1/1                  rx_w_mult_hash_match    &lt;= multi_match_saved;
4468       1/1                  rx_w_uni_hash_match     &lt;= uni_match_saved;
4469       1/1                  rx_w_ext_match1         &lt;= ext_match1_saved;
4470       1/1                  rx_w_ext_match2         &lt;= ext_match2_saved;
4471       1/1                  rx_w_ext_match3         &lt;= ext_match3_saved;
4472       1/1                  rx_w_ext_match4         &lt;= ext_match4_saved;
4473       1/1                  rx_w_type_match1        &lt;= type_match1_saved;
4474       1/1                  rx_w_type_match2        &lt;= type_match2_saved;
4475       1/1                  rx_w_type_match3        &lt;= type_match3_saved;
4476       1/1                  rx_w_type_match4        &lt;= type_match4_saved;
4477       1/1                  rx_w_checksumi_ok       &lt;= rx_toe_enable &amp; ip_v4_frame_saved &amp;
4478                                                       ~ip_ck_err_saved;
4479       1/1                  rx_w_checksumt_ok       &lt;= rx_toe_enable &amp; tcp_frame_saved &amp;
4480                                                       ~tcp_udp_ck_err_saved &amp; ~ip_ck_err_saved;
4481       1/1                  rx_w_checksumu_ok       &lt;= rx_toe_enable &amp; udp_frame_saved &amp;
4482                                                       ~tcp_udp_ck_err_saved &amp; ~ip_ck_err_saved;
4483       1/1                  rx_w_snap_frame         &lt;= snap_frame_saved;
4484                    
4485       1/1                  rx_w_length_error       &lt;= length_error;
4486       1/1                  rx_w_crc_error          &lt;= crc_error_reg &amp; ~too_long_dec;
4487       1/1                  rx_w_too_short          &lt;= too_short;
4488       1/1                  rx_w_too_long           &lt;= too_long_dec;
4489       1/1                  rx_w_code_error         &lt;= code_error_saved;
4490       1/1                  rx_w_frame_length[13:0] &lt;= frame_length;
4491                    
4492                          end
                        MISSING_ELSE
4493                      end
4494                    
4495                      // When the first sof is passed to the pbuf, pass
4496                      // the decoded screen to the pbuf, then hold the
4497                      // value when frame decode has stopped.
4498                      always@(posedge rx_clk or negedge n_rxreset)
4499                      begin
4500       1/1              if (~n_rxreset)
4501                          begin
4502       1/1                  queue_ptr_rx &lt;= 4'd0;
4503       1/1                  queue_ptr_rx_enable &lt;= 1'd0;
4504                          end
4505                        else
4506                          begin
4507       1/1                  if (rx_w_sop &amp;&amp; frame_being_decoded)
4508       1/1                    queue_ptr_rx_enable &lt;= 1'b1;
4509       1/1                  else if (!frame_being_decoded)
4510       1/1                    queue_ptr_rx_enable &lt;= 1'b0;
                        MISSING_ELSE
4511                    
4512       1/1                  if (queue_ptr_rx_enable &amp; ext_rxq_sel_en_rck)
4513       <font color = "red">0/1     ==>            queue_ptr_rx &lt;= {ext_match4_from_loop,ext_match3_from_loop,ext_match2_from_loop,ext_match1_from_loop};</font>
4514       1/1                  else if (queue_ptr_rx_enable)
4515       1/1                    queue_ptr_rx &lt;= queue_ptr_rx_scn;
                        MISSING_ELSE
4516                          end
4517                      end
4518                    
4519                      // Status signals to register block. Only updated when frame finished,
4520                      // and previous status has been taken.
4521                      // If an overflow has occured for this reason then there will a
4522                      // further update once the current update has completed.
4523                      always@(posedge rx_clk or negedge n_rxreset)
4524                      begin
4525       1/1               if (~n_rxreset)
4526                           begin
4527       1/1                   rx_frame_rxed_ok   &lt;= 1'b0;
4528       1/1                   rx_align_error     &lt;= 1'b0;
4529       1/1                   rx_crc_error       &lt;= 1'b0;
4530       1/1                   rx_short_error     &lt;= 1'b0;
4531       1/1                   rx_long_error      &lt;= 1'b0;
4532       1/1                   rx_jabber_error    &lt;= 1'b0;
4533       1/1                   rx_symbol_error    &lt;= 1'b0;
4534       1/1                   rx_length_error    &lt;= 1'b0;
4535       1/1                   rx_ip_ck_error     &lt;= 1'b0;
4536       1/1                   rx_tcp_ck_error    &lt;= 1'b0;
4537       1/1                   rx_udp_ck_error    &lt;= 1'b0;
4538       1/1                   rx_overflow        &lt;= 1'b0;
4539       1/1                   rx_pause_frame     &lt;= 1'b0;
4540       1/1                   rx_pause_nonzero   &lt;= 1'b0;
4541       1/1                   rx_broadcast_frame &lt;= 1'b0;
4542       1/1                   rx_multicast_frame &lt;= 1'b0;
4543       1/1                   rx_bytes_in_frame  &lt;= 14'h0000;
4544       1/1                   rx_pfc_pause_frame &lt;= 1'b0;
4545       1/1                   rx_pfc_pause_nonzero &lt;= 1'b0;
4546                           end
4547       1/1               else if ((pipeline_finished &amp; ~((update_in_progress &amp; ~too_long) |
4548                                                         (rx_end_frame &amp; too_long))) |
4549                                  (update_finished &amp; update_overflow))
4550                           begin
4551       1/1                   rx_frame_rxed_ok   &lt;= ~rx_w_err_next &amp; frame_matched_pipe;
4552       1/1                   rx_align_error     &lt;= ~too_long &amp; ~too_short &amp; nibble_cnt_odd_saved
4553                                                   &amp; (crc_error_reg | code_error_saved);
4554       1/1                   rx_crc_error       &lt;= ~too_long &amp; ~too_short &amp; ~nibble_cnt_odd_saved
4555                                                   &amp; (crc_error_reg | code_error_saved);
4556       1/1                   rx_short_error     &lt;= too_short &amp; ~crc_error_reg;
4557       1/1                   rx_long_error      &lt;= too_long &amp; ~crc_error_reg &amp; ~code_error_saved;
4558       1/1                   rx_jabber_error    &lt;= too_long &amp; (crc_error_reg | code_error_saved);
4559       1/1                   rx_symbol_error    &lt;= code_error_saved &amp; ~(gigabit &amp; too_short);
4560       1/1                   rx_length_error    &lt;= length_error;
4561       1/1                   rx_ip_ck_error     &lt;= ~too_long &amp; ~too_short &amp; ~code_error_saved &amp;
4562                                                   ~crc_error_reg &amp; ip_ck_err_saved;
4563       1/1                   rx_tcp_ck_error    &lt;= ~too_long &amp; ~too_short &amp; ~code_error_saved &amp;
4564                                                   ~crc_error_reg &amp; tcp_frame_saved &amp;
4565                                                   tcp_udp_ck_err_saved;
4566       1/1                   rx_udp_ck_error    &lt;= ~too_long &amp; ~too_short &amp; ~code_error_saved &amp;
4567                                                   ~crc_error_reg &amp; udp_frame_saved &amp;
4568                                                   tcp_udp_ck_err_saved;
4569       1/1                   rx_overflow        &lt;= overflow_saved | rx_pipeline_overflow |
4570                                                   rx_w_overflow | update_overflow;
4571       1/1                   rx_pause_frame     &lt;= pause_frame_saved &amp; ~bad_frame &amp; ~pfc_negotiate;
4572       1/1                   rx_pause_nonzero   &lt;= pause_frame_saved &amp; ~bad_frame &amp; ~pfc_negotiate &amp;
4573                                                   (pause_time_saved != 16'h0000);
4574       1/1                   rx_broadcast_frame &lt;= broad_frame_saved &amp; ~bad_frame &amp;
4575                                                   frame_matched_pipe;
4576       1/1                   rx_multicast_frame &lt;= multi_frame_saved &amp; ~bad_frame &amp;
4577                                                   frame_matched_pipe;
4578                    
4579                             // Always signal full byte count to statistic registers
4580                             // even if striping FCS.
4581       1/1                   rx_bytes_in_frame  &lt;= frm_byte_cnt;
4582       1/1                   rx_pfc_pause_frame &lt;= pfc_pause_frame_saved &amp; ~bad_frame &amp;
4583                                                   pfc_enable_rck;
4584       1/1                   rx_pfc_pause_nonzero &lt;= pfc_pause_frame_saved &amp; ~bad_frame &amp;
4585                                                     pfc_enable_rck;
4586                           end
                        MISSING_ELSE
4587                      end
4588                    
4589                      // Generate PFC pause frame negotiate, the signal is set when a
4590                      // PFC pause frame is detected and is reset when pfc_enable is low
4591                      always @(posedge rx_clk or negedge n_rxreset)
4592                      begin
4593       1/1              if (~n_rxreset)
4594       1/1                pfc_negotiate     &lt;= 1'b0;
4595                        else
4596                          begin
4597       1/1                  if (~pfc_enable_rck)
4598       1/1                    pfc_negotiate &lt;= 1'b0;
4599                            else
4600                              begin
4601       <font color = "red">0/1     ==>              if (rx_pfc_pause_frame)</font>
4602       <font color = "red">0/1     ==>                pfc_negotiate &lt;= 1'b1;</font>
4603                                else
4604       <font color = "red">0/1     ==>                pfc_negotiate &lt;= pfc_negotiate;</font>
4605                              end
4606                          end
4607                      end
4608                    
4609                    // -----------------------------------------------------------------------------
4610                    // Signal pause frame and new time to GEM_TX
4611                    // -----------------------------------------------------------------------------
4612                    
4613                      // signal to GEM_TX when a new pause time is available. This will be done
4614                      // by a toggle signal that changes state every time a new pause frame is
4615                      // received and decoded successfully.
4616                      // Only active when both pause is enabled and in full duplex mode.
4617                      always@(posedge rx_clk or negedge n_rxreset)
4618                      begin
4619       1/1              if (~n_rxreset)
4620                          begin
4621       1/1                  new_pause_time &lt;= 16'h0000;
4622       1/1                  new_pause_tog  &lt;= 1'b0;
4623                          end
4624       1/1              else if (pipeline_finished &amp; pause_frame_saved &amp; ~bad_frame &amp;
4625                                 pause_enable_rck &amp; full_duplex &amp; (~pfc_negotiate))
4626                          begin
4627       <font color = "red">0/1     ==>          new_pause_time &lt;= pause_time_saved;</font>
4628       <font color = "red">0/1     ==>          new_pause_tog  &lt;= ~new_pause_tog;</font>
4629                          end
                        MISSING_ELSE
4630                      end
4631                    
4632                    // -----------------------------------------------------------------------------
4633                    // Signal PFC pause frame and new time to GEM_RX_PFC_TIMER
4634                    // -----------------------------------------------------------------------------
4635                    
4636                      // signal to GEM_RX_PFC_TIMER when a new PFC pause time is available.
4637                      // This will be done by a toggle signal that changes state every time
4638                      // a PFC new pause frame is received and decoded successfully.
4639                      // Only active when both PFC is enabled and in full duplex mode.
4640                      assign new_pfc_pause_time0 = pfc_pause_time0;
4641                      assign new_pfc_pause_time1 = pfc_pause_time1;
4642                      assign new_pfc_pause_time2 = pfc_pause_time2;
4643                      assign new_pfc_pause_time3 = pfc_pause_time3;
4644                      assign new_pfc_pause_time4 = pfc_pause_time4;
4645                      assign new_pfc_pause_time5 = pfc_pause_time5;
4646                      assign new_pfc_pause_time6 = pfc_pause_time6;
4647                      assign new_pfc_pause_time7 = pfc_pause_time7;
4648                      assign new_priority_enable = priority_enable;
4649                    
4650                      // drive new_pfc_pause_tog
4651                      always@(posedge rx_clk or negedge n_rxreset)
4652                      begin
4653       1/1              if (~n_rxreset)
4654       1/1                new_pfc_pause_tog   &lt;= 1'b0;
4655       1/1              else if (pipeline_finished &amp; pfc_pause_frame_saved &amp; ~bad_frame &amp;
4656                                 pfc_enable_rck &amp; full_duplex )
4657       <font color = "red">0/1     ==>        new_pfc_pause_tog   &lt;= ~new_pfc_pause_tog;</font>
                        MISSING_ELSE
4658                      end
4659                    
4660                    // -----------------------------------------------------------------------------
4661                    // Priority Queue Screeners
4662                    // -----------------------------------------------------------------------------
4663                    
4664                      assign reset_queue_ptr = (dma_update_finished | start_of_data);
4665                      generate if (p_num_type1_screeners == 8'd0 &amp;&amp; p_num_type2_screeners == 8'd0) begin : gen_no_screeners
4666                        assign queue_ptr_rx_scn = 4'd0;
4667                        assign scr_drop_frame   = 1'b0;
4668                      end else begin : gen_screeners
4669                        gem_screener_top # (
4670                                              .p_num_type1_screeners (p_num_type1_screeners),
4671                                              .p_num_type2_screeners (p_num_type2_screeners)
4672                                           ) i_gem_screener_top(
4673                          .n_rxreset           (n_rxreset),
4674                          .rx_clk              (rx_clk),
4675                          .reset_queue_ptr     (reset_queue_ptr),
4676                          .screener_type1_regs (screener_type1_regs),
4677                          .ip_v4_frame         (ip_v4_frame),
4678                          .ip_v6_frame         (ip_v6_frame),
4679                          .udp_frame           (udp_frame),
4680                          .ip_v4_tos           (ip_v4_tos),
4681                          .ip_v6_tc            (ip_v6_tc),
4682                          .udp_dest_addr       (udp_dest_addr),
4683                    
4684                          .screener_type2_regs (screener_type2_regs),
4685                          .scr2_ethtype_match  (scr2_ethtype_match[7:0]),
4686                          .scr2_compare_match  (scr2_compare_match[31:0]),
4687                          .tci                 (tci[3:1]),
4688                          .vlan_tagged         (vlan_tagged),
4689                    
4690                          .priority_queue      (queue_ptr_rx_scn),
4691                          .drop_frame          (scr_drop_frame),
4692                          .scr2_match_vec      (scr2_match_vec)
4693                        );
4694                      end
4695                      endgenerate
4696                    
4697                      generate if (p_num_scr2_compare_regs != 8'd0 &amp;&amp; p_num_type2_screeners != 8'd0) begin : gen_comp2_regs
4698                      genvar a;
4699                      genvar b;
4700                        wire  frame_has_valid_ctag;
4701                        wire  frame_has_valid_stag;
4702                        wire [p_num_scr2_compare_regs-1:0] offset_type_0,offset_type_1,offset_type_2,offset_odd;
4703                        reg [p_num_scr2_compare_regs-1:0] frameatoffset;
4704                        reg [15:0] last_databyte;
4705                        reg [15:0] last_last_databyte;
4706                        reg [32:0] scr2_compare_match_r;  // Type 2 ext screening compare match bus
4707                    
4708                        // The S-TAG for VLAN matching is defined only if it matches the stacked vlan type programmed into
4709                        // the registers.
4710                        // The C-TAG will always be the 2nd VLAN if two VLANs were seen or the first VLAN only if it
4711                        // matches the standard 8100 VLAN type.
4712                        assign frame_has_valid_stag = {1'b1,ext_vlan_tag1[31:16]} == stacked_vlantype[16:0];
4713                        assign frame_has_valid_ctag = ext_has_2vlans  ? 1'b1            // ext_has_2vlans will always be set only for 8100 type.
4714                                                                      : ext_vlan_tag1[31:16] == 16'h8100;
4715                    
4716                        always@(posedge rx_clk or negedge n_rxreset)
4717                        begin
4718                          if (~n_rxreset)
4719                          begin
4720                            last_databyte       &lt;= 16'd0;
4721                            last_last_databyte  &lt;= 16'd0;
4722                          end
4723                          else if (new_aligned_data)
4724                          begin
4725                            last_databyte       &lt;= new_data_align[15:0];
4726                            last_last_databyte  &lt;= last_databyte[15:0];
4727                          end
4728                        end
4729                    
4730                        for (a=0; a&lt;p_num_scr2_compare_regs; a = a+1)
4731                        begin : screener_type2_compare_process
4732                          wire        comp_reg_no_mask;
4733                          wire [15:0] comp_reg_value;
4734                          wire [15:0] comp_reg_mask;
4735                          assign comp_reg_no_mask     = scr2_compare_regs[(43*a)+41+1];
4736                          assign comp_reg_value       = scr2_compare_regs[(43*a)+31+1:(43*a)+16+1]; // Compare Value from screener
4737                          assign comp_reg_mask        = scr2_compare_regs[(43*a)+15+1:(43*a+1)];    // Compare Mask from screener
4738                    
4739                          assign offset_type_0[a]    = scr2_compare_regs[(43*a)+39+1];
4740                          assign offset_type_1[a]    = scr2_compare_regs[(43*a)+40+1];
4741                          assign offset_type_2[a]    = scr2_compare_regs[(43*a)+42+1];
4742                          assign offset_odd[a]       = scr2_compare_regs[(43*a)+32+1];
4743                    
4744                          // For the packet inspection, the offset from the compare register is defined in bytes, but the data passing through the pipe
4745                          // is in nibbles.  When compare mask is being used (as defined by clearing bit 9 of the 2nd compare register, which is bit 41 wh both comapre
4746                          // registers are concatenated), then we will always do the comparison 1 cycle after the index = offset[6:1]. If offset[0] is cle, then we should
4747                          // compare the previous cycles data stripe with the cmpare value from the comp reg.  If offset[1] is set, we compare the upper 8its of the
4748                          // previous cycles data stripe and the lower 8 bits of the current cycles datastripe with the comp reg.
4749                          // When the compare mask is not used, then we will always do the comparison 2 cycles after the index = offset[6:1]. If offset[0]s clear, then we should
4750                          // compare the previous 2 cycles data stripes (=32 bits) with the cmpare value from the comp reg.  If offset[1] is set, we compa the upper 8 bits of the
4751                          // data 2 cycles previous, the full 16 bits of the previous stripe, and the lower 8 bits of the current cycles datastripe with t 32 bit comp reg.
4752                          // Note that for VLAN matching, the software will have written the offset value to be 0 so we effectively compare straight after the Ethertype by which
4753                          // time all the VLAN decoding would have finished.
4754                          // If the match is set to compare S-TAG but no S-TAG seen, then the frameatoffset[x] signal would not be activated. Similarly for C-TAG.
4755                    
4756                          wire [6:0] index_from_screener;
4757                          assign index_from_screener = scr2_compare_regs[(43*a)+38+1:(43*a)+33+1] + {4'h0,comp_reg_no_mask,~comp_reg_no_mask};
4758                          always@(*)
4759                          begin
4760                            casex ({offset_type_2[a],offset_type_1[a],offset_type_0[a]})
4761                              3'b000   : // Offset from SOF
4762                              begin
4763                                if (index_cnt_sof == index_from_screener)
4764                                  frameatoffset[a]  = 1'b1;
4765                                else
4766                                  frameatoffset[a]  = 1'b0;
4767                              end
4768                              3'b001:   // Offset from ethertype
4769                              begin
4770                                if (index_cnt_type == index_from_screener)  // index_from_screener
4771                                  frameatoffset[a]  = 1'b1;
4772                                else
4773                                  frameatoffset[a]  = 1'b0;
4774                              end
4775                              3'b1x0  : // VLAN CTAG
4776                              begin
4777                                if (index_cnt_type == 7'h01)  // Match just after the Ethertype
4778                                  frameatoffset[a]  = frame_has_valid_ctag;
4779                                else
4780                                  frameatoffset[a]  = 1'b0;
4781                              end
4782                              3'b1x1  : // VLAN STAG
4783                              begin
4784                                if (index_cnt_type == 7'h01)  // Match just after the Ethertype
4785                                  frameatoffset[a]  = frame_has_valid_stag;
4786                                else
4787                                  frameatoffset[a]  = 1'b0;
4788                              end
4789                    
4790                              3'b010   : // Offset from L3 header
4791                              begin
4792                                if (index_cnt_l3 == index_from_screener)
4793                                  frameatoffset[a]  = 1'b1;
4794                                else
4795                                  frameatoffset[a]  = 1'b0;
4796                              end
4797                              default : // Offset from L4 header
4798                              begin
4799                                if (index_cnt_l4 == index_from_screener)
4800                                  frameatoffset[a]  = 1'b1;
4801                                else
4802                                  frameatoffset[a]  = 1'b0;
4803                              end
4804                            endcase
4805                          end
4806                    
4807                          // Perform the comparison as defined above. frameatoffset will go high on the cycle the comparison should take place. new_data_agn is
4808                          // the data from the current stripe, last_databyte is the data from the previous stripe. last_last_databyte is the data from stre 2
4809                          // cycles back
4810                          wire [15:0] scr2_comp_masked;
4811                          wire [31:0] comp_reg32_value;
4812                          wire [15:0] comp_stag_value;
4813                          wire [15:0] comp_ctag_value;
4814                          reg  [15:0] comp_dat_value16;
4815                          reg  [31:0] comp_dat_value32;
4816                    
4817                          assign comp_ctag_value      = ext_has_2vlans  ? ext_vlan_tag2[15:0] : ext_vlan_tag1[15:0];
4818                          assign comp_stag_value      = ext_vlan_tag1[15:0];
4819                          assign scr2_comp_masked     = comp_reg_value &amp; comp_reg_mask;
4820                          assign comp_reg32_value     = scr2_compare_regs[(43*a)+31+1:(43*a)+1];
4821                    
4822                          always@(*)
4823                          begin
4824                            if (offset_type_2[a] &amp; ~offset_type_0[a])     // CTAG matching
4825                              comp_dat_value16  = comp_ctag_value;
4826                            else if (offset_type_2[a] &amp; offset_type_0[a]) // STAG matching
4827                              comp_dat_value16  = comp_stag_value;
4828                            else if (offset_odd[a])                       // Normal data match
4829                              comp_dat_value16  = {new_data_align[7:0],last_databyte[15:8]};
4830                            else                                          // Normal data match
4831                              comp_dat_value16  = last_databyte[15:0];
4832                    
4833                            if (offset_odd[a])
4834                              comp_dat_value32  = {new_data_align[7:0],last_databyte,last_last_databyte[15:8]};
4835                            else
4836                              comp_dat_value32  = {last_databyte,last_last_databyte};
4837                          end
4838                    
4839                          always@(posedge rx_clk or negedge n_rxreset)
4840                          begin
4841                            if (~n_rxreset)
4842                              scr2_compare_match_r[a] &lt;= 1'b0;
4843                            else if (~enable_receive_rck | ~frame_being_decoded | last_aligned_data)
4844                              scr2_compare_match_r[a] &lt;= 1'b0;
4845                            else if (new_aligned_data)
4846                            begin
4847                              if (frameatoffset[a])
4848                              begin
4849                                if (~comp_reg_no_mask)  // use_mask
4850                                  scr2_compare_match_r[a] &lt;= scr2_comp_masked == (comp_dat_value16 &amp; comp_reg_mask);
4851                                else
4852                                  scr2_compare_match_r[a] &lt;= comp_reg32_value == comp_dat_value32;
4853                              end
4854                            end
4855                          end
4856                        end
4857                        
4858                        wire   zero;
4859                        assign zero = 1'b0;
4860                        
4861                        // Tie scr2_compare_match bits mapping to non-present compare regs to zero
4862                        for (b={24'd0,p_num_scr2_compare_regs}; b&lt;33; b = b+1)
4863                        begin :scr2_comp_match
4864                          always @(*)
4865                            scr2_compare_match_r[b] = zero;
4866                        end
4867                        assign scr2_compare_match[32:0] = scr2_compare_match_r;
4868                    
4869                      end else begin  : gen_no_comp2_regs
4870                        assign scr2_compare_match[32:0] = 33'd0;
4871                      end
4872                      endgenerate
4873                    
4874                      generate if (p_num_scr2_ethtype_regs != 8'd0 &amp;&amp; p_num_type2_screeners != 8'd0) begin : gen_ethtype_regs
4875                      genvar c;
4876                      genvar d;
4877                        reg   [8:0]   scr2_ethtype_match_r;  // Type 2 ext screening ethtype match bus
4878                        for (c=0; c&lt;p_num_scr2_ethtype_regs; c = c+1)
4879                        begin :scr2_eth_match
4880                          always@(posedge rx_clk or negedge n_rxreset)
4881                          begin
4882                            if (~n_rxreset)
4883                              scr2_ethtype_match_r[c] &lt;= 1'b0;
4884                            else if (~enable_receive_rck | ~frame_being_decoded | last_aligned_data)
4885                              scr2_ethtype_match_r[c] &lt;= 1'b0;
4886                            else if (ext_type_stb)
4887                              scr2_ethtype_match_r[c] &lt;=  ext_type == scr2_ethtype_regs[(16*c)+16:(16*c)+1];
4888                          end
4889                        end
4890                        
4891                        wire   zero;
4892                        assign zero = 1'b0;
4893                        
4894                        // Tie scr2_compare_match bits mapping to non-present compare regs to zero
4895                        for (d={24'd0,p_num_scr2_ethtype_regs}; d&lt;9; d = d+1)
4896                        begin : scr2_eth_match2
4897                          always @(*)
4898                            scr2_ethtype_match_r[d] = zero;
4899                        end
4900                        assign scr2_ethtype_match[8:0] = scr2_ethtype_match_r;
4901                      end else begin  : gen_no_ethtype_regs
4902                        assign scr2_ethtype_match[8:0] = 9'd0;
4903                      end
4904                      endgenerate
4905                    
4906                    
4907                      // Timestamp capture
4908                    
4909                      generate if (p_edma_tsu == 1'b1) begin : gen_tsu
4910                    
4911                        reg     [77:0] rx_w_timestamp_r;
4912                        reg     [9:0]  rx_w_timestamp_prty_r;      // parity protection for the rx_w_timestamp_r
4913                        reg            tsu_timer_safe_to_sample;   // Qualifer
4914                        wire           tsu_timer_safe_to_sample_c; // Qualifer
4915                        reg     [77:0] tsu_timer_sampled_on_sof;             // TSU timer count value
4916                        reg     [9:0]  tsu_timer_prty_sampled_on_sof;        // parity protection for the TSU timer count value
4917                        wire           sof_rx_sync;                // 2nd Sync flop for sof_tx (into tsu_clk)
4918                        reg            sof_rx_sync_d1;             // delayed flop for rising edge detect
4919                        wire           rx_sof_pclk,rx_sof_tsu;
4920                        reg     [77:0] tsu_ptp_rx_timer_out_r;      // Timestamp in PCLK domain
4921                        reg     [9:0]  tsu_ptp_rx_timer_out_prty_r; // parity protection for tsu_ptp_rx_timer_out_r Timestamp in PCLK domain
4922                    
4923                        // In order to support single step timestamp insertion with maximum accuracy, the timstamp
4924                        // must be captured based on the tx_sof event, passed into the TSU clock. that way the timestamp
4925                        // can be accurately captured asap.  the captured TS must then be passed back to the TX clock for
4926                        // insertion into the timestamp.
4927                        // Timestamp location for PTPoE is offset 48 (34 of PTP frame + 14 ethernet header)
4928                        // It is &gt; than this for PTPoIP, so use PTPoE as worst case
4929                        // Minimum sized ethernet frame is 64bytes
4930                        // By enforcing the rule that TSU clock is &gt; 1/8th the frequency of TX_CLK, this allows for 6 TSU clocks
4931                        // to create a toggle signal on tx_sof, pass into TSU domain and sample the TS into a stable bank of registers.
4932                        // This final register bank will be stable for an entire frame, i.e. &gt;= 64 tx_clks. It will also be stable at
4933                        // the point this module needs to sample it for insertion into the frame, and it will be stable at the point
4934                        // gem_dma_pbuf_tx_rd.v needs to sample it on tx_r_eop.
4935                    
4936                        // first synchronize the SOF event to the TSU clock domain
4937                         cdnsdru_datasync_v1 i_cdnsdru_datasync_v1_sof_rx_tog (
4938                            .clk(tsu_clk),
4939                            .reset_n(n_tsureset),
4940                            .din(sof_rx_tog),
4941                            .dout(sof_rx_sync));
4942                    
4943                        always@(posedge tsu_clk or negedge n_tsureset)
4944       1/1                if (~n_tsureset)
4945       1/1                  sof_rx_sync_d1  &lt;= 1'b0;
4946                          else
4947       1/1                  sof_rx_sync_d1  &lt;= sof_rx_sync;
4948                    
4949                        // detect the SOF event in TSU clock domain
4950                        assign rx_sof_tsu = sof_rx_sync_d1 ^ sof_rx_sync;
4951                    
4952                        // sample the time in TSU clock domain.  This will remain valid for an entire frame
4953                        // From sof_tx to next sof_tx
4954                        always@(posedge tsu_clk or negedge n_tsureset)
4955                        begin
4956       1/1                if (~n_tsureset)
4957                          begin
4958       1/1                  tsu_timer_sampled_on_sof      &lt;= {78{1'b0}};
4959       1/1                  tsu_timer_prty_sampled_on_sof &lt;= {10{1'b0}};
4960                          end
4961                          else
4962                          begin
4963       1/1                  if (rx_sof_tsu) begin
4964       1/1                    tsu_timer_sampled_on_sof      &lt;= tsu_timer_cnt[93:16];
4965       1/1                    tsu_timer_prty_sampled_on_sof &lt;= tsu_timer_cnt_par[11:2];
4966                            end
                        MISSING_ELSE
4967                          end
4968                        end
4969                        edma_sync_toggle_detect i_edma_sync_toggle_detect_sof_tx_sync_d1 (
4970                          .clk(rx_clk),
4971                          .reset_n(n_rxreset),
4972                          .din(sof_rx_sync_d1),
4973                          .rise_edge(),
4974                          .fall_edge(),
4975                          .any_edge(tsu_timer_safe_to_sample_c));
4976                    
4977                         always@(posedge rx_clk or negedge n_rxreset)
4978                         begin
4979       1/1                  if (~n_rxreset)
4980                               // asynchronous reset.
4981       1/1                    tsu_timer_safe_to_sample &lt;= 1'b0;
4982       1/1                  else if (tsu_timer_safe_to_sample_c)
4983       1/1                    tsu_timer_safe_to_sample &lt;= 1'b1;
4984       1/1                  else if (rx_dv_int_te)
4985       1/1                    tsu_timer_safe_to_sample &lt;= 1'b0;
                        MISSING_ELSE
4986                         end
4987                    
4988                        // Now sample it at a point we know the timer value is stable ...
4989                        always@(posedge rx_clk or negedge n_rxreset)
4990                        begin
4991       1/1                if (~n_rxreset) begin
4992       1/1                  rx_w_timestamp_r      &lt;= {78{1'b0}};
4993       1/1                  rx_w_timestamp_prty_r &lt;= {10{1'b0}};
4994                          end
4995                          else
4996                          begin
4997       1/1                  if (rx_dv_int_te &amp; tsu_timer_safe_to_sample) begin
4998       1/1                    rx_w_timestamp_r      &lt;= tsu_timer_sampled_on_sof;
4999       1/1                    rx_w_timestamp_prty_r &lt;= tsu_timer_prty_sampled_on_sof;
5000                            end
                        MISSING_ELSE
5001                          end
5002                        end
5003                    
5004                        // Now synchonize to pclk
5005                         edma_sync_toggle_detect i_edma_sync_toggle_detect_sof_rx_sync_d1 (
5006                            .clk(pclk),
5007                            .reset_n(n_preset),
5008                            .din(sof_rx_sync_d1),
5009                            .rise_edge(),
5010                            .fall_edge(),
5011                            .any_edge(rx_sof_pclk));
5012                    
5013                        always@(posedge pclk or negedge n_preset)
5014       1/1                if (~n_preset) begin
5015       1/1                  tsu_ptp_rx_timer_out_r      &lt;= {78{1'b0}};
5016       1/1                  tsu_ptp_rx_timer_out_prty_r &lt;= {10{1'b0}};
5017                          end else
5018       1/1                  if (rx_sof_pclk) begin
5019       1/1                    tsu_ptp_rx_timer_out_r      &lt;= tsu_timer_sampled_on_sof;
5020       1/1                    tsu_ptp_rx_timer_out_prty_r &lt;= tsu_timer_prty_sampled_on_sof;
5021                            end
                        MISSING_ELSE
</pre>
</div>
<div class="ui-layout-south">
<table align=center><tr><td class="s0 cl">0%</td>
<td class="s1 cl">10%</td>
<td class="s2 cl">20%</td>
<td class="s3 cl">30%</td>
<td class="s4 cl">40%</td>
<td class="s5 cl">50%</td>
<td class="s6 cl">60%</td>
<td class="s7 cl">70%</td>
<td class="s8 cl">80%</td>
<td class="s9 cl">90%</td>
<td class="s10 cl">100%</td></tr></table></div>
</body>
</html>
